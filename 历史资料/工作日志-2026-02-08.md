# 工作日志-2026-02-08

**创建时间**: 2026-02-08 17:21:10  
**存放位置**: D:\2bktest\MDview\

---

## 1 DCP插件配置错误及修正 【配置项名称错误导致启动失败】2026-02-08 17:21:10

### 1.1 错误概述

在为 OpenCode Desktop 安装 DCP (Dynamic Context Pruning) 插件时，犯了配置项名称错误，导致 OpenCode 启动失败。

### 1.2 错误详情

**错误配置**（错误版本）:
```json
"plugins": [
  "@tarquinen/opencode-dcp@latest"
]
```

**错误信息**:
```
Failed to spawn OpenCode Server. Logs:
[STDERR] [91m[1mError: [0mConfiguration is invalid at C:\Users\40968\.config\opencode\opencode.jsonc
[STDERR] ↳ Unrecognized key: "plugins"
```

**正确配置**（修正后）:
```json
"plugin": [
  "@tarquinen/opencode-dcp@latest"
]
```

### 1.3 错误原因分析

1. **凭记忆/猜测配置项名称**：错误地使用了复数形式 `"plugins"`
2. **未查阅官方文档**：没有确认 OpenCode 配置文件的正确语法
3. **假设与常规习惯一致**：其他工具通常使用 `"plugins"`，但 OpenCode 使用 `"plugin"`

### 1.4 影响范围

- OpenCode Desktop 无法启动
- 用户需要手动修正配置
- 延误了 DCP 插件的测试工作

### 1.5 修正措施

1. **立即修正**：将 `"plugins"` 改为 `"plugin"`（单数形式）
2. **验证配置**：确认 JSON 格式正确
3. **重启测试**：重启 OpenCode 验证配置生效

### 1.6 经验教训

**必须遵守的原则**:
1. ✅ **查阅官方文档**：配置任何插件前，先查看官方文档或示例
2. ✅ **核对配置项名称**：不要凭记忆，要对照官方配置示例
3. ✅ **备份配置文件**：修改前务必备份（这次已备份到 `opencode.jsonc.backup.20260208_xxxxxx`）
4. ✅ **小步验证**：修改配置后先验证格式，再测试功能

**常见配置项名称陷阱**:
| 工具/框架 | 插件配置项 | 说明 |
|-----------|-----------|------|
| OpenCode | `"plugin"` | **单数形式！** |
| VS Code | 不适用（使用 extensions） | 不同机制 |
| npm/package.json | `"dependencies"` | 复数形式 |
| webpack | `"plugins"` | 复数形式 |
| ESLint | `"plugins"` | 复数形式 |

### 1.7 预防措施

**未来安装插件时的检查清单**:
- [ ] 查阅官方文档确认配置项名称
- [ ] 查看官方示例配置文件
- [ ] 备份原配置文件
- [ ] 修改后先验证 JSON 语法
- [ ] 重启应用测试
- [ ] 检查日志确认插件加载成功

### 1.8 相关文档

- **DCP 插件 NPM 页面**: https://www.npmjs.com/package/@tarquinen/opencode-dcp
- **配置文件位置**: `C:\Users\40968\.config\opencode\opencode.jsonc`
- **备份文件**: `opencode.jsonc.backup.20260208_xxxxxx`

---

**更新时间**: 2026-02-08 17:21:10


---

## 3 会话备份插件配置错误 【"session-backup" 配置键不被识别】2026-02-08 18:35:32

### 3.1 错误现象

**错误信息**：
```
Configuration is invalid at C:\Users\40968\.config\opencode\opencode.jsonc
  ↳ Unrecognized key: "session-backup"
```

**出现次数**：连续两次启动失败

### 3.2 原因分析

1. **错误配置**：在 `opencode.jsonc` 中添加了 `"session-backup": {...}` 配置项
2. **插件不支持**：`opencode-session-backup` 插件不接受 JSON 配置
3. **配置方式错误**：该插件应使用环境变量而非配置文件

### 3.3 解决方案

**已修复**：移除配置文件中的 `"session-backup"` 配置块

**正确配置方式**（如需配置）：
```bash
# 使用环境变量（未验证是否有效）
set OPENCODE_BACKUP_PATH=D:\2bktest\MDview\opencode-backups
```

**当前配置**（已清理）：
```json
"plugin": [
  "@tarquinen/opencode-dcp@latest",
  "@ramtinj95/opencode-tokenscope@latest",
  "opencode-session-backup@latest"  // 插件已安装，无额外配置
]
```

### 3.4 经验教训

- **教训1**：并非所有插件都支持 JSON 配置
- **教训2**：安装前必须查阅插件文档确认配置方式
- **教训3**：遇到 "Unrecognized key" 错误应立即移除该配置项
- **教训4**：插件配置和插件安装是两个不同的概念

### 3.5 当前状态

- ✅ 配置文件已修正
- ✅ 已备份到 `opencode.jsonc.backup.fix-session-backup.xxx`
- ⏳ 等待重启验证

**更新时间**: 2026-02-08 18:35:32


---

## 4 Bun 与 Node.js 运行时配置差异发现 【opencode-session-backup 插件配置问题分析】2026-02-08 19:44:15

### 4.1 发现经过

在尝试配置 `opencode-session-backup` 插件的 JSON 配置时，发现 Desktop 版本与预期行为不一致。

**问题现象**：
- NPM 文档明确说明支持 `"session-backup": {...}` JSON 配置
- 实际测试：JSON 配置在 Desktop 版本不生效
- 环境变量配置（`OPENCODE_BACKUP_PATH`）可以正常工作

### 4.2 根本原因分析

**Desktop 版本使用 Bun 运行时**：
```log
INFO  service=bun pkg=opencode-session-backup version=latest installing
```

**关键差异**：

| 运行时 | 配置方式 | 状态 | 原因 |
|--------|----------|------|------|
| **Bun (Desktop)** | JSON 配置 | ❌ **不生效** | Bun 可能不调用 `config` 回调函数 |
| **Bun (Desktop)** | 环境变量 | ✅ **生效** | `process.env` 同步读取，无需回调 |
| **Node.js (TUI)** | JSON 配置 | ✅ 可能生效 | 标准插件回调机制 |
| **Node.js (TUI)** | 环境变量 | ✅ 生效 | 标准 Node.js 行为 |

### 4.3 代码分析验证

通过查看插件源码（`index.js` 第 220-235 行）：

```javascript
// 环境变量方式（同步，立即生效）
destination = process.env.OPENCODE_BACKUP_PATH || getDefaultDestination();
debugMode = process.env.OPENCODE_BACKUP_DEBUG === "true";

// JSON 配置方式（依赖 config 回调）
config: async (config) => {
    const pluginConfig = config["session-backup"];
    if (pluginConfig?.backupPath) {
        destination = pluginConfig.backupPath;
    }
}
```

**结论**：Bun 运行时可能不支持或不调用 `config` 异步回调函数。

### 4.4 实际存储路径确认

通过查看插件安装位置和文件结构：

**Desktop 版本实际存储**：
```
C:\Users\40968\.cache\opencode\node_modules\
├── @tarquinen\opencode-dcp\          ✅ v2.0.2
├── @ramtinj95\opencode-tokenscope\   ✅ v1.5.2
└── opencode-session-backup\          ✅ v1.3.0
```

**TUI 版本标准路径**：
```
~/.config/opencode/plugins/          （已创建并复制）
~/.opencode/plugins/                 （项目级，已创建并复制）
```

**Bun 缓存位置**：
```
C:\Users\40968\.bun\install\cache\
```

### 4.5 解决方案与建议

**Desktop 版本（Bun 运行时）**：
- ✅ 使用环境变量配置：
  ```powershell
  $env:OPENCODE_BACKUP_PATH = "D:/2bktest/MDview/opencode-backups"
  $env:OPENCODE_BACKUP_DEBUG = "true"
  ```
- ✅ 使用默认备份路径：`~/Google Drive/opencode-sessions/`
- ✅ 使用工具命令：
  ```bash
  /session_backup_sync force=true
  /session_backup_status
  ```

**TUI/CLI 版本（Node.js 运行时）**：
- 可能支持 JSON 配置（需测试验证）
- 同样支持环境变量方式

### 4.6 经验教训

- **教训1**：OpenCode Desktop 使用 Bun 运行时，与 TUI/CLI 版本（Node.js）有差异
- **教训2**：插件文档未明确区分运行时差异，需实际测试验证
- **教训3**：优先使用环境变量配置，兼容性最好
- **教训4**：查看插件源码可以快速定位问题
- **教训5**：Bun 的插件 `config` 回调可能不完全兼容

### 4.7 后续行动

- ✅ 使用默认备份路径继续工作
- ⏳ 如需自定义路径，使用环境变量方式
- ❌ 不再尝试 JSON 配置方式（Desktop 版本不支持）

**相关文件**：
- 插件源码：`~/.cache/opencode/node_modules/opencode-session-backup/dist/index.js`
- 配置文件：`~/.config/opencode/opencode.jsonc`
- 备份目录：`~/Google Drive/opencode-sessions/`

**更新时间**: 2026-02-08 19:44:15


---

## 6 opencode-antigravity-auth 插件配置成功记录 【版本号必须使用具体版本】2026-02-09 00:48:37

### 6.1 配置过程

**用户操作**：通过视频教程成功配置 antigravity 插件
**关键发现**：版本号必须使用具体版本，不能使用 @latest

### 6.2 关键教训

| 配置项 | 错误写法 | 正确写法 | 说明 |
|--------|---------|---------|------|
| 插件版本 | `opencode-antigravity-auth@latest` ❌ | `opencode-antigravity-auth@1.4.6` ✅ | 必须使用具体版本号 |
| 错误提示 | `Invalid SemVer: latest` | - | @latest 不是有效的语义化版本 |

### 6.3 成功经验

1. **视频教程比文档更靠谱** - 用户通过视频成功配置
2. **版本号格式重要** - OpenCode 对版本号格式要求严格
3. **其他插件使用 @latest 正常** - 只有 antigravity 必须用具体版本

### 6.4 当前配置状态

**最终正确的配置**（5个插件）：
```json
"plugin": [
  "@tarquinen/opencode-dcp@latest",
  "@ramtinj95/opencode-tokenscope@latest",
  "opencode-session-backup@latest",
  "@tarquinen/opencode-smart-title@latest",
  "opencode-antigravity-auth@1.4.6"
]
```

### 6.5 待确认问题

用户提到"其他设置还有问题"，但当前配置已验证正确。
待后续进一步确认具体是哪个设置有问题。

**更新时间**: 2026-02-09 00:48:37
