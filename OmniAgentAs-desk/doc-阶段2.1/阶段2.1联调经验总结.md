# 阶段2.1联调经验总结

**创建时间**: 2026-02-18 14:48:36
**总结人**: 小沈
**联调时间**: 2026-02-18 13:25-14:33

---

## 1. 这次联调是怎么做的

### 1.1 开始：小新制定了API契约

小新先写了`阶段2.1-前端UI-API契约-小新-2026-02-17.md`，规定了9个接口的请求和响应格式。

**关键约定**:
- 配置更新用`zhipu_api_key`和`opencode_api_key`，不用`api_key`
- 会话返回用`session_id`，不用`id`
- 配置验证响应要包含`model`字段

### 1.2 小沈开发后端

**做的事情**:
1. 实现4个缺失的接口（security、execution、health、echo）
2. 对照契约检查已有接口

**发现的问题**:
- config.py里用的是`api_key`，契约要求`zhipu_api_key`/`opencode_api_key`
- sessions.py里返回的是`id`，契约要求`session_id`
- config验证响应缺少`model`字段
- 会话列表返回的是数组，契约要求对象格式（带total/page/page_size）

**修复过程**:
- 修改config.py，把`api_key`字段拆开
- 修改sessions.py，把`id`改成`session_id`
- 给ConfigValidateResponse加上`model`字段
- 修改会话列表返回格式为对象

**测试验证**:
- 写了15个测试用例
- 第1轮测试发现测试代码问题，修复
- 第2轮测试发现契约不一致，修复
- 第3轮测试全部通过
- 生成测试报告记录结果

### 1.3 小新准备前端

- 前端代码已经按照契约v1.2写好了
- TypeScript编译0错误
- 48个单元测试全部通过
- 前端服务运行在localhost:3000

### 1.4 联调执行过程

**第一层（小沈做curl测试）**:
- 测试`zhipu_api_key`字段：PUT /config，返回200 ✅
- 测试`opencode_api_key`字段：PUT /config，返回200 ✅
- 测试`session_id`字段：POST /sessions，返回session_id ✅
- 测试`model`字段：POST /config/validate，返回包含model ✅

**第二层（小新做前端API调用）**:
- 前端调用更新配置接口，成功 ✅
- 前端调用创建会话接口，成功 ✅
- 验证了4个关键字段都正确

**第三层（小新做业务流程）**:
- TC01: 获取配置，成功 ✅
- TC02: 创建会话，成功 ✅
- TC03: 获取会话列表，分页格式正确 ✅
- TC04: 删除会话，成功 ✅

**第四层（小新做边界测试）**:
- TC05: 空API Key测试，后端接受但可优化 ⚠️
- TC06: 无效API Key验证，正确返回错误 ✅
- TC07: 超出范围分页，返回空数组 ✅
- TC08: 非法字段，后端忽略并正常处理 ✅

### 1.5 文档记录

整个过程中，每做一个操作都实时记录到`阶段2.1联调记录-2026-02-18.md`:
- 第1章：小沈的后端准备
- 第2章：小新的前端准备
- 第3章：启动时遇到的问题
- 第4章：环境检查
- 第5章：第一层curl测试
- 第6章：小新启动前端
- 第7章：协作规范确认
- 第8章：第二层测试
- 第9章：第三层测试
- 第10章：第四层测试
- 第11章：小新检查第4-8章执行情况
- 第12章：小沈检查第4-8章执行情况

---

## 2. 为什么这次联调顺利

### 2.1 契约先定好

小新先把API契约写好了，前后端都知道该实现什么。不像以前那种"边做边改"的方式。

**实际效果**:
- 小沈开发时有明确标准
- 对照契约检查发现了4个不一致的地方
- 联调时双方对字段名没有争议

### 2.2 开发阶段就检查

小沈不是等联调时才发现问题，而是开发完成后主动对照契约检查。

**实际做的**:
- 读契约文档全文
- 逐条对比自己的实现
- 发现4个不一致的问题：api_key→zhipu_api_key/opencode_api_key、id→session_id、缺少model字段、列表格式不对
- 立即修复这些问题

**结果**: 联调时字段名问题已经解决了

### 2.3 后端自己测试充分

小沈做了3轮测试：
- 第1轮：写完接口后测试，发现测试代码问题
- 第2轮：修复后测试，发现契约不一致问题
- 第3轮：修复契约问题后测试，15个用例全部通过

**实际效果**: 联调时后端接口已经是验证过的，不会因为后端问题导致联调失败

### 2.4 分层测试，一步步来

没有一开始就做UI流程测试，而是分层进行：
1. 先用curl测试接口通不通（第一层）
2. 再用前端调API看能不能通（第二层）
3. 然后做完整业务流程（第三层）
4. 最后做边界测试（第四层）

**实际效果**:
- 第一层通过了，说明后端接口没问题
- 第二层通过了，说明前后端能连通
- 第三层通过了，说明业务流程没问题
- 第四层通过了，说明边界处理没问题
- 每过一层，信心增加一层

### 2.5 实时记录

每做一个操作，立即记录到联调记录文件里。

**实际做的**:
- 小沈做完curl测试，立即记录第5章
- 小新做完前端测试，立即记录第8、9、10章
- 发现问题立即写进文档
- 双方都看得到对方的进度

**结果**: 文档里完整记录了整个过程，现在写经验总结都有据可查

### 2.6 分工明确

- 小沈负责：后端修复、curl测试、后端支持
- 小新负责：前端代码、前端API测试、UI流程测试
- 双方共同：环境检查、问题处理

**实际效果**: 没有互相推诿，各自把自己负责的部分做好

---

## 3. 实际遇到的问题和解决

### 3.1 契约不一致问题（开发阶段发现）

**问题**: 小沈对照契约检查时发现4个不一致：
1. config.py用`api_key`，契约要求`zhipu_api_key`/`opencode_api_key`
2. sessions.py返回`id`，契约要求`session_id`
3. config验证响应缺少`model`字段
4. 会话列表返回数组，契约要求对象

**解决**: 
- 修改config.py的ConfigUpdate模型
- 修改sessions.py的SessionResponse模型，把id改成session_id
- 给ConfigValidateResponse加上model字段
- 修改会话列表返回格式

**结果**: 在联调前就已经修复了

### 3.2 启动服务时ASGI模块导入错误（联调时遇到）

**问题**: 执行`python -m uvicorn main:app`报错：Could not import module "main"

**解决**: 改成`python -m uvicorn app.main:app`，加上app.前缀

**结果**: 服务成功启动

### 3.3 curl命令在bash中返回空（联调时遇到）

**问题**: 在bash里执行curl，返回空

**解决**: 用PowerShell后台启动服务，再执行curl

**结果**: curl测试正常

### 3.4 章节号写错（文档记录时遇到）

**问题**: 追加内容时没检查最后章节号，写了重复的章节号（2次）

**解决**: 发现后立即修正

**教训**: 追加内容前先检查最后章节号

---

## 4. 这次做得好的地方

1. **契约先定好**：小新先写契约，前后端都有标准
2. **开发阶段自查**：小沈对照契约检查，发现4个问题并提前修复
3. **后端测试充分**：3轮测试，15个用例全部通过
4. **分层测试**：curl→前端API→UI流程→边界，一步步来
5. **实时记录**：每步操作都记录，文档完整
6. **分工明确**：各自负责自己的部分

---

## 5. 下次可以改进的地方

1. **章节号管理**：追加内容前先检查最后章节号，避免重复
2. **P1级用例完整测试**：这次P1-03（获取会话消息）和P1-05（发送消息）没有明确测试，下次可以补充
3. **时间预估**：实际用时比预估长，下次预估要留余量

---

## 6. 给其他项目的建议

### 6.1 一定要有契约文档

不要口头约定，要写文档。这次小新的契约文档起了很大作用。

### 6.2 开发阶段就要对照契约检查

不要等到联调时才发现字段名不对。小沈这次在开发阶段就发现并修复了4个问题。

### 6.3 后端自己要先测试

小沈做了3轮测试，联调时后端是验证过的，不会因为后端问题卡壳。

### 6.4 分层测试，不要一步到位

先做curl测试，再做前端调用，再做业务流程，再做边界测试。这样问题定位快。

### 6.5 实时记录

每做一个操作就记录，不要事后补。这次文档完整，就是因为实时记录。

---

**更新时间**: 2026-02-18 14:48:36
