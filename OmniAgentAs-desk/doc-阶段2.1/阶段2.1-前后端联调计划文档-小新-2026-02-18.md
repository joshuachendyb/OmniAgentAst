# 阶段2.1-前后端联调计划文档

**文档类型**: 联调计划  
**制定人**: 小新  
**制定时间**: 2026-02-18 12:15:00  
**联调人员**: 小新（前端）+ 小沈（后端）  
**预计时长**: 50分钟  
**存放位置**: OmniAgentAs-desk/doc-阶段2.1/

---

## 版本历史

【版本】: v1.1 : 2026-02-18 12:30:00: 吸收小沈补充方案，更新后端测试状态、端口配置确认、快速验证清单
【版本】: v1.0 : 2026-02-18 12:15:00: 初始版本，制定阶段2.1前后端联调详细计划，明确分工

---

## 1. 联调概述

### 1.1 联调目的

验证前端代码与后端实现的一致性，确保接口调用符合契约v1.2要求，发现并解决集成问题。

### 1.2 联调范围

| 范围 | 说明 | 负责人 |
|------|------|--------|
| **后端修复验证** | 验证小沈修复的3个字段名问题 | 小沈 |
| **接口连通性** | 验证前后端服务能正常通信 | 小新+小沈 |
| **功能验证** | 验证核心业务功能正常 | 小新 |
| **问题修复** | 解决联调中发现的问题 | 视问题归属 |

### 1.3 参与人员及分工

| 人员 | 角色 | 主要职责 |
|------|------|---------|
| **小新** | 前端开发 | 前端服务启动、API调用测试、UI流程验证、问题记录 |
| **小沈** | 后端开发 | 后端修复、服务启动、CORS配置、接口联调支持 |
| **用户** | 项目负责人 | 确认问题处理方案、重大决策确认 |

---

## 2. 联调前准备

### 2.1 后端准备清单 【负责人：小沈】

#### 2.1.1 后端当前状态（根据小沈第3次测试结果）

**后端API已完成第3次全面测试，质量状态如下**：

| 测试指标 | 结果 |
|---------|------|
| 测试接口数 | 9个 |
| 测试用例数 | 15个 |
| 通过数 | 15个 |
| 失败数 | 0 |
| **通过率** | **100%** |
| **契约符合性** | **100%** |

**已实现的接口（全部测试通过）**：
- ✅ GET /api/v1/health
- ✅ POST /api/v1/security/check
- ✅ POST /api/v1/echo
- ✅ GET /api/v1/config
- ✅ PUT /api/v1/config
- ✅ POST /api/v1/config/validate
- ✅ POST /api/v1/sessions
- ✅ GET /api/v1/sessions
- ✅ GET /api/v1/chat/execution/{id}/stream

#### 2.1.2 后端准备项清单

| 序号 | 准备项 | 详细要求 | 状态 | 备注 |
|------|--------|---------|------|------|
| 1 | **字段名修复** | 修改 `ConfigUpdate` 模型，将 `api_key` 改为 `zhipu_api_key` 和 `opencode_api_key` | ✅ **已完成** | 第3次测试验证通过 |
| 2 | **字段名修复** | 修改 `SessionResponse` 模型，将 `id` 改为 `session_id` | ✅ **已完成** | 第3次测试验证通过 |
| 3 | **字段添加** | 修改 `ConfigValidateResponse`，添加 `model` 字段 | ✅ **已完成** | 第3次测试验证通过 |
| 4 | **CORS配置** | 配置跨域访问，允许前端 `http://localhost:5173` 访问 | ✅ **已配置** | 需联调时验证 |
| 5 | **版本号文件** | 确保项目根目录有 `version.txt` 文件 | ✅ **已存在** | 健康检查可读取 |
| 6 | **端口确认** | 确认后端服务端口（8000或8001） | ⚠️ **待确认** | 见2.1.3节 |
| 7 | **服务启动** | 启动后端服务 | ⬜ **联调时** | 小沈在联调时启动 |

**小沈准备完成标志**：✅ 1-5项已完成，6-7项联调时确认

#### 2.1.3 端口配置确认（关键）⚠️

**小沈指出的问题**：后端实际测试使用8001端口，联调需确认使用哪个端口。

| 配置项 | 原计划 | 实际测试 | 联调确认 |
|--------|--------|---------|---------|
| 后端端口 | 8000 | 8001 | **确认使用8000** ✅ |
| 前端API地址 | localhost:8000 | - | 保持8000 ✅ |
| CORS允许 | localhost:5173 | - | 已配置 ✅ |

**确认结果**：✅ **联调使用端口8000**（双方已确认）

**小沈待办**：联调时将后端服务端口改为8000并启动

```bash
# 后端启动命令（端口8000）
cd D:/2bktest/MDview/OmniAgentAs-desk/backend
python -m uvicorn main:app --reload --port 8000 --host 0.0.0.0
```

### 2.2 前端准备清单 【负责人：小新】

小新在联调前完成的准备工作：

| 序号 | 准备项 | 详细要求 | 状态 |
|------|--------|---------|------|
| 1 | **API地址确认** | 确认 `services/api.ts` 中 `API_BASE_URL = 'http://localhost:8000/api/v1'` | ✅ 已完成 |
| 2 | **类型定义检查** | 确认所有类型定义符合契约v1.2 | ✅ 已完成 |
| 3 | **前端服务启动** | 启动前端开发服务器 `npm run dev` | 联调时启动 |
| 4 | **测试工具准备** | 准备浏览器控制台、curl命令、测试用例 | 联调时准备 |

### 2.3 环境检查表 【负责人：小沈+小新】

联调开始前双方共同确认：

| 检查项 | 后端状态 | 前端状态 | 确认人 |
|--------|---------|---------|--------|
| 后端服务运行中 | ⬜ | - | 小沈 |
| 前端服务运行中 | - | ⬜ | 小新 |
| 网络连通（能ping通） | ⬜ | ⬜ | 双方 |
| CORS配置正确 | ⬜ | - | 小沈 |
| 数据库已初始化 | ⬜ | - | 小沈 |

---

## 3. 联调测试方法

### 3.1 分层验证策略 【负责人：小新主导，小沈配合】

```
第一层：接口连通性测试（curl/Postman）【5分钟】
    ↓ 通过后进入
第二层：单接口功能验证（前端直接调用）【10分钟】
    ↓ 通过后进入
第三层：业务流程验证（完整功能场景）【20分钟】
    ↓ 通过后进入
第四层：边界和异常测试（错误处理）【10分钟】
```

### 3.2 第一层：接口连通性测试 【负责人：小沈主导】

小沈使用curl验证后端接口修复是否正确：

```bash
# 1. 健康检查 - 验证版本号动态读取
# 【负责人：小沈】
curl http://localhost:8000/api/v1/health
# 预期：返回 {"status": "healthy", "version": "x.x.x"}

# 2. 获取配置 - 验证基础功能
# 【负责人：小沈】
curl http://localhost:8000/api/v1/config

# 3. 更新配置 - 验证字段名修改（智谱AI）
# 【负责人：小沈】
curl -X PUT http://localhost:8000/api/v1/config \
  -H "Content-Type: application/json" \
  -d '{"ai_provider":"zhipuai","zhipu_api_key":"test-key"}'
# 预期：成功，状态码200

# 4. 更新配置 - 验证字段名修改（OpenCode）
# 【负责人：小沈】
curl -X PUT http://localhost:8000/api/v1/config \
  -H "Content-Type: application/json" \
  -d '{"ai_provider":"opencode","opencode_api_key":"test-key"}'
# 预期：成功，状态码200

# 5. 创建会话 - 验证session_id字段
# 【负责人：小沈】
curl -X POST http://localhost:8000/api/v1/sessions
# 预期：返回 {"session_id": "xxx", "title": "...", "created_at": "...", "updated_at": "...", "message_count": 0}
# 注意：字段名必须是 session_id，不是 id

# 6. 验证配置 - 验证model字段
# 【负责人：小沈】
curl -X POST http://localhost:8000/api/v1/config/validate \
  -H "Content-Type: application/json" \
  -d '{"provider":"zhipuai","api_key":"test-key"}'
# 预期：返回 {"valid": true, "message": "...", "model": "glm-4-flash"}
# 注意：必须包含 model 字段
```

**第一层通过标志**：✅ 所有curl命令返回200，字段名正确

### 3.3 第二层：单接口功能验证 【负责人：小新主导】

小新在前端浏览器控制台直接调用API：

```typescript
// 测试1：更新配置（智谱AI）
// 【负责人：小新】
import { configApi } from './services/api';
configApi.updateConfig({
  ai_provider: 'zhipuai',
  zhipu_api_key: 'test-key'
}).then(res => console.log('✅ 智谱配置成功:', res))
  .catch(err => console.error('❌ 智谱配置失败:', err));

// 测试2：更新配置（OpenCode）
// 【负责人：小新】
configApi.updateConfig({
  ai_provider: 'opencode',
  opencode_api_key: 'test-key'
}).then(res => console.log('✅ OpenCode配置成功:', res))
  .catch(err => console.error('❌ OpenCode配置失败:', err));

// 测试3：创建会话 - 验证session_id字段
// 【负责人：小新】
import { sessionApi } from './services/api';
sessionApi.createSession()
  .then(res => {
    console.log('✅ 创建会话成功:', res);
    console.log('session_id:', res.session_id); // 确认字段名正确
  })
  .catch(err => console.error('❌ 创建会话失败:', err));

// 测试4：验证配置 - 验证model字段
// 【负责人：小新】
configApi.validateConfig({ provider: 'zhipuai', api_key: 'test' })
  .then(res => {
    console.log('✅ 验证成功:', res);
    console.log('model:', res.model); // 确认包含model字段
  })
  .catch(err => console.error('❌ 验证失败:', err));
```

**第二层通过标志**：✅ 所有API调用成功，返回数据符合契约

### 3.4 第三层：业务流程验证 【负责人：小新主导】

按用户使用场景测试完整功能：

| 用例编号 | 测试场景 | 操作步骤 | 预期结果 | 负责人 |
|---------|---------|---------|---------|--------|
| TC01 | **配置更新流程** | 1. 打开设置页面<br>2. 选择智谱AI<br>3. 输入API Key<br>4. 点击保存 | 保存成功，提示"配置已更新" | 小新 |
| TC02 | **创建会话流程** | 1. 点击"新对话"<br>2. 输入消息<br>3. 发送 | 会话创建成功，显示在列表中 | 小新 |
| TC03 | **对话流程** | 1. 选择会话<br>2. 发送消息<br>3. 查看AI回复 | AI正常回复，消息显示正确 | 小新 |
| TC04 | **会话管理** | 1. 创建3个会话<br>2. 查看会话列表<br>3. 删除1个会话 | 列表显示正确，删除后刷新正常 | 小新 |

**第三层通过标志**：✅ 所有业务流程正常，无报错

### 3.5 第四层：边界和异常测试 【负责人：小新主导，小沈配合】

| 用例编号 | 测试场景 | 操作 | 预期处理 | 负责人 |
|---------|---------|------|---------|--------|
| TC05 | **空API Key** | 更新配置时不传API Key | 后端返回400错误，前端提示"API Key不能为空" | 小新+小沈 |
| TC06 | **无效API Key** | 输入错误的API Key验证 | 验证失败，返回valid: false | 小新+小沈 |
| TC07 | **网络异常** | 后端服务关闭时调用API | 前端提示"请求超时，请检查网络" | 小新 |
| TC08 | **并发请求** | 快速点击多次发送 | 只处理一次，避免重复提交 | 小新 |

---

## 4. 代码集成方案

### 4.1 后端需要提供的配置 【负责人：小沈】

小沈需要提供以下配置或代码：

#### 4.1.1 CORS配置代码

```python
# backend/main.py 或 app.py
# 【负责人：小沈】需要在后端代码中添加

from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=[
        "http://localhost:5173",  # Vite开发服务器
        "http://localhost:3000",  # 可能的其他前端端口
    ],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

#### 4.1.2 后端启动命令

```bash
# 【负责人：小沈】提供准确的启动命令

cd D:/2bktest/MDview/OmniAgentAs-desk/backend

# 方式1：使用uvicorn
python -m uvicorn main:app --reload --port 8000 --host 0.0.0.0

# 方式2：如果使用其他方式，请说明
```

#### 4.1.3 数据库初始化命令（如果需要）

```bash
# 【负责人：小沈】如果需要初始化数据库，请提供命令

# 示例：
python init_db.py
```

### 4.2 前端已就绪的代码 【负责人：小新】

前端代码已是真实API调用，无需修改：

| 文件 | 状态 | 说明 |
|------|------|------|
| `services/api.ts` | ✅ 已就绪 | 所有类型定义符合契约v1.2，真实API调用 |
| `pages/History/index.tsx` | ✅ 已就绪 | 会话列表展示，使用对象格式解析 |
| 其他组件 | ✅ 已就绪 | 已完成单元测试（48个通过） |

### 4.3 前端启动命令 【负责人：小新】

```bash
# 【负责人：小新】前端启动
cd D:/2bktest/MDview/OmniAgentAs-desk/frontend
npm run dev
```

前端将运行在 `http://localhost:5173`

---

## 5. 联调用例清单

### 5.1 P0级：必须通过的用例 【负责人：小新+小沈】

这些用例验证小沈修复的3个问题，必须全部通过：

| 编号 | 用例名称 | 测试接口 | 验证点 | 负责人 |
|------|---------|---------|--------|--------|
| P0-01 | 更新配置-智谱AI | PUT /config | 请求使用 `zhipu_api_key` | 小沈+小新 |
| P0-02 | 更新配置-OpenCode | PUT /config | 请求使用 `opencode_api_key` | 小沈+小新 |
| P0-03 | 创建会话-字段名 | POST /sessions | 响应字段为 `session_id` | 小沈+小新 |
| P0-04 | 验证配置-model | POST /config/validate | 响应包含 `model` | 小沈+小新 |

### 5.2 P1级：功能验证用例 【负责人：小新】

| 编号 | 用例名称 | 测试内容 | 负责人 |
|------|---------|---------|--------|
| P1-01 | 获取配置 | GET /config 返回正确配置 | 小新 |
| P1-02 | 获取会话列表 | GET /sessions 返回对象格式 | 小新 |
| P1-03 | 获取会话消息 | GET /sessions/{id}/messages | 小新 |
| P1-04 | 删除会话 | DELETE /sessions/{id} | 小新 |
| P1-05 | 发送消息 | POST /chat | 小新 |

### 5.3 P2级：业务流程用例 【负责人：小新】

| 编号 | 用例名称 | 测试内容 | 负责人 |
|------|---------|---------|--------|
| P2-01 | 完整对话流程 | 配置→创建→发送→查看历史 | 小新 |
| P2-02 | 多会话管理 | 创建、切换、删除多个会话 | 小新 |

---

## 6. 问题处理流程

### 6.1 问题记录模板 【负责人：发现者】

联调中发现问题时，按以下格式记录：

```
【问题编号】YYYYMMDD-XXX
【问题描述】一句话描述问题
【涉及接口】接口路径
【当前现象】实际发生什么
【预期现象】应该发生什么
【问题归属】前端/后端/契约
【处理方案】如何修复
【负责人】谁负责修复
【状态】待处理/处理中/已解决
```

### 6.2 问题升级标准 【负责人：用户】

| 问题类型 | 处理方式 | 升级标准 |
|---------|---------|---------|
| 字段名不匹配 | 按契约修改 | 无需升级，直接修改 |
| 字段类型不一致 | 按契约修改 | 无需升级，直接修改 |
| 字段缺失/多余 | 讨论后决定 | **需用户确认**是否修改契约 |
| 接口路径不一致 | 按契约修改 | 无需升级，直接修改 |
| 业务逻辑争议 | 协商确定 | **需用户确认** |

### 6.3 快速修复流程 【负责人：问题归属方】

```
发现问题 → 记录问题 → 判断归属 → 快速修复（5分钟内）→ 重新测试
                                          ↓
                                    无法快速修复
                                          ↓
                                    升级用户决策
```

---

## 7. 时间安排

### 7.1 联调时间表

| 阶段 | 时长 | 内容 | 负责人 | 开始时间 | 结束时间 |
|------|------|------|--------|---------|---------|
| **准备阶段** | - | 小沈完成后端修复和准备 | 小沈 | 联调前 | - |
| **第一层** | 5分钟 | curl测试3个修改点 | 小沈主导 | T+0 | T+5 |
| **第二层** | 10分钟 | 前端控制台调用API | 小新主导 | T+5 | T+15 |
| **第三层** | 20分钟 | 完整UI流程测试 | 小新主导 | T+15 | T+35 |
| **第四层** | 10分钟 | 边界和异常测试 | 小新主导 | T+35 | T+45 |
| **问题修复** | 视情况 | 修复发现的问题 | 视归属 | T+45 | - |
| **报告编写** | 10分钟 | 编写联调报告 | 小新 | 联调后 | - |

**总计预计时间**：50分钟（不含问题修复时间）

### 7.2 里程碑

- ✅ **M1**：小沈完成准备（6项清单）
- ✅ **M2**：第一层通过（curl测试）
- ✅ **M3**：第二层通过（前端API调用）
- ✅ **M4**：第三层通过（业务流程）
- ✅ **M5**：P0级用例全部通过
- ✅ **M6**：联调报告完成

---

## 8. 风险与应对

| 风险 | 可能性 | 影响 | 应对措施 | 负责人 |
|------|--------|------|---------|--------|
| 后端修复延期 | 中 | 联调延期 | 每日同步进度，预留buffer | 小沈 |
| CORS配置问题 | 中 | 前端无法调用 | 提前准备配置代码，联调时快速调整 | 小沈 |
| 数据库连接失败 | 低 | 后端无法启动 | 检查数据库配置，提供初始化脚本 | 小沈 |
| 字段名仍不匹配 | 低 | P0用例失败 | 现场快速修复（5分钟） | 小沈 |
| 前端-后端版本不一致 | 低 | 联调失败 | 联调前确认git提交状态 | 小新+小沈 |

---

## 9. 交付物

### 9.1 联调完成后交付 【负责人：小新】

| 交付物 | 说明 | 截止时间 |
|--------|------|---------|
| **联调测试报告** | 记录测试用例执行结果、发现的问题 | 联调后当天 |
| **问题清单** | 如有问题，记录待修复项 | 联调后当天 |
| **集成确认书** | 双方签字确认联调通过（可选） | 联调通过后 |

### 9.2 文档模板

联调报告模板（供参考）：
```markdown
# 阶段2.1-前后端联调报告
**联调时间**: YYYY-MM-DD HH:MM
**参与人员**: 小新、小沈
**后端版本**: commit xxx
**前端版本**: commit xxx

## 测试用例执行结果
| 用例 | 结果 | 备注 |
|------|------|------|
| P0-01 | ✅/❌ | |
...

## 发现的问题
...

## 结论
✅ 联调通过 / ❌ 有待修复问题
```

---

## 10. 确认签字

本计划经双方确认后执行：

| 角色 | 姓名 | 确认状态 | 签字/时间 |
|------|------|---------|----------|
| **前端负责人** | 小新 | ⬜ 已确认 | _________ |
| **后端负责人** | 小沈 | ⬜ 已确认 | _________ |
| **项目负责人** | 用户 | ⬜ 已确认 | _________ |

**确认说明**：
- 确认代表已阅读并理解本计划的所有内容
- 确认代表同意按照本计划执行联调
- 如有异议，请在签字前提出

---

**文档最终更新时间**: 2026-02-18 12:15:00
**文档状态**: 待确认
**预计联调时间**: 待双方协商确定
