# 阶段2.1危险等级及提示设计

**【版本】: v1.1 : 2026-02-19 15:30:00: 补充权重数值、测试用例、依赖关系、版本历史和参考资料**

**文档性质**: 阶段2.1安全分级系统的设计、实施和验收依据  
**适用范围**: OmniAgentAs-desk项目危险操作检测与提示系统  
**编写人**: 小新  
**编写时间**: 2026-02-19 14:30:00

---

## 目录

1. [问题背景与来由](#一问题背景与来由)
2. [方案设计](#二方案设计)
3. [技术实现设计](#三技术实现设计)
4. [契约接口（API）](#四契约接口api)
5. [实施分工](#五实施分工)
6. [测试与调试](#六测试与调试)

---

## 版本历史

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|---------|------|
| **v0.1** | 2026-02-19 10:35:57 | 小沈提出L0-L3四级分类方案（系统级/项目级/操作级/对话级） | 小沈 |
| **v0.2** | 2026-02-19 10:53:30 | 小新提出10级连续评分方案（CRSS），基于CVSS 0-10分制 | 小新 |
| **v0.3** | 2026-02-19 12:02:46 | 确定采用CRSS方案，小沈编写后端实施计划 | 小沈 |
| **v0.4** | 2026-02-19 12:17:17 | 小新补充前端详细设计，确定API契约（23.2原版） | 小新 |
| **v0.5** | 2026-02-19 13:22:08 | 小沈优化API契约为精简版（只保留score+message） | 小沈 |
| **v1.0** | 2026-02-19 14:30:00 | 汇总所有讨论内容，形成正式设计文档 | 小新 |
| **v1.1** | 2026-02-19 15:30:00 | 补充具体权重数值、测试用例、依赖关系、版本历史和参考资料 | 小新 |

**方案演进说明**：
- **从L0-L3到0-10分**：由粗粒度4级演进为细粒度10级，实现无空隙全覆盖
- **从冗余字段到精简接口**：23.2原版有8个字段，24章精简版只有4个字段，职责更清晰
- **从模糊定义到精确量化**：补充具体权重数值，可编程实现

---

## 一、问题背景与来由

### 1.1 问题发现

**时间**: 2026-02-19 07:45:00  
**发现人**: 北京老陈（用户）  
**问题描述**: 安全检测规则无法识别普通文件删除操作

**用户测试指令**:
```
删除文件 tests/11.txt
del tests\11.txt
rm tests/11.txt
rm -rf tests/11.txt
```

**测试结果**: 所有指令均被标记为 **SAFE**（安全），未触发任何确认弹窗或提示。

### 1.2 根本原因分析

**问题定位**: `backend/app/services/shell_security.py` 安全检测逻辑缺陷

**具体原因**:

1. **黑名单匹配范围过窄**（第31-90行）
   - 只包含 `rm -rf /`、`rm -rf /*` 等针对系统根目录的命令
   - 不包含普通的 `del file.txt` 或 `rm file.txt`

2. **正则模式匹配范围过窄**（第109-179行）
   - 模式 `r'rm\s+-[rf]+\s+[/\\*]+'` 只匹配带 `/` 或 `*` 的递归删除
   - 不匹配 `rm 文件名` 这种普通删除

3. **未覆盖中文指令**（第31-179行）
   - 没有任何针对中文关键词 `删除` 的规则
   - AI返回的中文指令完全被忽略

4. **后端完全跳过安全检查**（第267行）
   - `handle_file_operation()` 函数没有调用 `check_command_safety()`
   - 后端直接执行所有文件操作命令

### 1.3 修复过程

**Wave 1（紧急修复）**: 2026-02-19 08:15:00
- 前端：修复字段名适配（`safe` → `isDangerous`）
- 后端：在 `chat.py` 第267行添加 `check_command_safety()` 调用
- **效果**: 能检测危险操作，但规则仍不完善

**Wave 2（规则完善）**: 2026-02-19 10:17:30
- 小查审查：提出目录敏感模式方案（方案B）
- 小沈提出：L0-L3四级分类方案
- 小新提出：10级连续评分方案（CRSS）

**最终决策**: 采用小新的**10级安全分类体系方案（CRSS）**，原因：
- 0-10分全覆盖，无空隙、不重合
- 三维评分模型可精确量化风险
- 便于编程实现和前端分级响应

---

## 二、方案设计

### 2.1 10级安全分类体系（CRSS）

**方案名称**: CRSS（Command Risk Scoring System）命令风险评分系统  
**设计原则**: 0-10分连续分级，无空隙、不重合、可推导  
**参考标准**: CVSS（通用漏洞评分系统）0-10分制

#### 2.1.1 等级定义

| 分数 | 等级名称 | 定义 | 操作示例 | 系统响应 |
|------|---------|------|---------|---------|
| **0** | 🟢 **无害** | 纯查询操作，只读不修改 | `ls`, `cat readme.txt`, `pwd` | ✅ 直接执行 |
| **1** | 🟢 **安全** | 读取临时/缓存文件 | `cat .cache/config.json` | ✅ 直接执行 |
| **2** | 🟢 **低风险** | 读取用户数据 | `cat ~/document.txt` | ✅ 直接执行 |
| **3** | 🟢 **轻微风险** | 创建临时文件/目录 | `mkdir temp/`, `touch .log` | ✅ 直接执行，记录日志 |
| **4** | 🟡 **注意** | 修改临时/缓存数据 | `echo "cache" > .cache/file` | ℹ️ 执行并提示 |
| **5** | 🟡 **中等** | 修改用户数据（可恢复） | 编辑用户文档 | ℹ️ 执行并提示 |
| **6** | 🟡 **较高** | 删除临时/缓存文件 | `rm *.tmp`, `del .cache/` | ⚠️ 需用户知晓 |
| **7** | 🟠 **高风险** | 删除用户数据 | `rm ~/file.txt` | 🛑 需用户确认 |
| **8** | 🟠 **严重** | 删除项目核心文件 | `rm src/app.py` | 🛑 需用户确认+备份提醒 |
| **9** | 🔴 **危险** | 系统级危险操作 | `sudo rm -rf`, `format C:` | ❌ **直接拒绝** |
| **10** | 🔴 **致命** | 系统毁灭性操作 | `rm -rf /`, `dd if=/dev/zero of=/dev/sda` | ❌ **直接拒绝+告警** |

#### 2.1.2 简化等级（前端使用）

为简化前端处理，将10级合并为4个响应等级：

| 分数段 | 等级 | 处理方式 | UI响应 |
|--------|------|---------|--------|
| **0-3分** | SAFE | 直接执行 | 静默（无UI） |
| **4-6分** | MEDIUM | 执行并提示 | 顶部通知 |
| **7-8分** | HIGH | 需用户确认 | 弹窗Modal |
| **9-10分** | CRITICAL | 直接拒绝 | Alert警告 |

### 2.2 三维评分模型

**计算公式**:
```
风险分数 = (操作类型权重 + 操作对象权重) / 2 × 影响范围系数
```

#### 2.2.1 维度1：操作类型权重（0-10分）

| 操作类型 | 权重范围 | 默认权重 | 关键词示例 |
|---------|---------|---------|-----------|
| **查询(READ)** | 0-2 | 1 | cat, ls, grep, 查看, 读取 |
| **创建(CREATE)** | 2-4 | 3 | mkdir, touch, 创建, 新建 |
| **修改(UPDATE)** | 4-7 | 5 | edit, sed, 修改, 编辑, 更新 |
| **删除(DELETE)** | 6-10 | 8 | rm, del, 删除, remove, 清除 |
| **执行(EXEC)** | 5-10 | 7 | sudo, run, exec, 执行, 运行 |

**具体权重定义（Python字典）**：
```python
OPERATION_WEIGHTS = {
    'READ': {'min': 0, 'max': 2, 'default': 1, 'keywords': ['cat', 'ls', 'grep', '查看', '读取']},
    'CREATE': {'min': 2, 'max': 4, 'default': 3, 'keywords': ['mkdir', 'touch', '创建', '新建']},
    'UPDATE': {'min': 4, 'max': 7, 'default': 5, 'keywords': ['edit', 'sed', '修改', '编辑', '更新']},
    'DELETE': {'min': 6, 'max': 10, 'default': 8, 'keywords': ['rm', 'del', '删除', 'remove', '清除']},
    'EXEC': {'min': 5, 'max': 10, 'default': 7, 'keywords': ['sudo', 'run', 'exec', '执行', '运行']},
}
```

#### 2.2.2 维度2：操作对象权重（0-10分）

| 对象类型 | 权重范围 | 默认权重 | 识别特征 |
|---------|---------|---------|---------|
| **临时数据** | 0-2 | 1 | .tmp, .cache, temp/, 临时文件 |
| **用户数据** | 3-5 | 4 | ~/, /home/, 文档/, 用户目录 |
| **项目数据** | 6-8 | 7 | src/, app/, backend/, frontend/, .py, .js, .ts |
| **系统数据** | 8-10 | 9 | C:\Windows, /bin, /etc, 系统目录, 注册表 |

**具体权重定义（Python字典）**：
```python
TARGET_WEIGHTS = {
    'TEMP': {'min': 0, 'max': 2, 'default': 1, 'patterns': [r'\.tmp', r'\.cache', r'temp/', r'\.log']},
    'USER': {'min': 3, 'max': 5, 'default': 4, 'patterns': [r'~/', r'/home/', r'文档/', r'用户目录']},
    'PROJECT': {'min': 6, 'max': 8, 'default': 7, 'patterns': [r'src/', r'app/', r'backend/', r'frontend/', r'\.py', r'\.js', r'\.ts']},
    'SYSTEM': {'min': 8, 'max': 10, 'default': 9, 'patterns': [r'C:\\Windows', r'/bin', r'/etc', r'系统目录']},
}

# 本项目(OmniAgentAs-desk)保护目录列表
PROJECT_PROTECTED_DIRS = [
    'backend/', 'frontend/', 'config/', 'tests/', 
    'doc-阶段2.1/', 'notes/', 'src/', '.git/',
    'package.json', 'requirements.txt', 'version.txt'
]
```

#### 2.2.3 维度3：影响范围系数

| 范围 | 系数 | 识别特征 |
|------|------|---------|
| **单个文件** | ×1.0 | 具体文件名，无通配符 |
| **整个目录** | ×1.5 | 目录名/结尾，如 `tests/` |
| **跨目录** | ×2.0 | 包含*, ?, 或"所有文件"、"批量操作" |
| **系统级** | ×3.0 | 包含-rf, /s /q, 根目录/全盘操作 |

**具体系数定义（Python字典）**：
```python
SCOPE_MULTIPLIERS = {
    'SINGLE_FILE': 1.0,      # 单文件：具体文件名，如 tests/11.txt
    'DIRECTORY': 1.5,        # 目录：目录名/结尾，如 tests/
    'CROSS_DIR': 2.0,        # 跨目录：包含通配符，如 tests/*.txt
    'SYSTEM': 3.0,           # 系统级：-rf, /s /q, /
}

# 范围识别关键词
SCOPE_PATTERNS = {
    'SINGLE_FILE': [r'^[^*?]+\.[a-zA-Z0-9]+$', r'^[^*?/]+$'],  # 具体文件名
    'DIRECTORY': [r'/$', r'\\$'],                              # 以/或\结尾
    'CROSS_DIR': [r'\*', r'\?', r'所有', r'批量', r'全部'],      # 通配符或中文
    'SYSTEM': [r'-rf', r'-rf', r'/s\s+/q', r'^/$', r'根目录', r'全盘'],  # 系统级
}
```

### 2.3 计算示例

**示例1**: `cat readme.txt`
- 操作: 查询(1分) + 用户数据(4分) = 2.5分
- 范围: 单文件(×1.0)
- **总分**: 2.5 → **3分**（🟢 轻微风险，直接执行）

**示例2**: `rm tests/11.txt`
- 操作: 删除(8分) + 项目数据(7分) = 7.5分
- 范围: 单文件(×1.0)
- **总分**: 7.5 → **8分**（🟠 严重，需确认+备份提醒）

**示例3**: `del temp.log`
- 操作: 删除(6分) + 临时数据(1分) = 3.5分
- 范围: 单文件(×1.0)
- **总分**: 3.5 → **4分**（🟡 注意，执行并提示）

**示例4**: `rm -rf /`
- 操作: 删除(10分) + 系统数据(10分) = 10分
- 范围: 系统级(×3.0) → 封顶10分
- **总分**: **10分**（🔴 致命，直接拒绝+告警）

---

## 三、技术实现设计

### 3.1 后端核心函数设计

#### 3.1.1 风险评分计算

```python
def calculate_risk_score(command: str) -> int:
    """
    计算命令风险分数 (0-10)
    
    计算公式: (操作分数 + 对象分数) / 2 × 范围系数
    
    Returns:
        int: 0-10的整数分数
    """
    # 1. 解析操作类型
    op_type = parse_operation_type(command)
    type_score = OPERATION_WEIGHTS[op_type]
    
    # 2. 解析操作对象
    op_target = parse_operation_target(command)
    target_score = TARGET_WEIGHTS[op_target]
    
    # 3. 解析影响范围
    scope = parse_impact_scope(command)
    scope_multiplier = SCOPE_MULTIPLIERS[scope]
    
    # 4. 计算总分
    raw_score = (type_score + target_score) / 2 * scope_multiplier
    final_score = min(10, int(raw_score))
    
    return final_score
```

#### 3.1.2 提示信息生成

```python
def get_risk_message(score: int, command: str) -> str:
    """
    根据分数生成用户提示信息
    
    Args:
        score: 风险分数
        command: 原始命令
    
    Returns:
        str: 用户可见的提示信息
    """
    if score <= 3:
        return "操作安全"
    elif score <= 6:
        return "操作存在风险，请注意"
    elif score <= 8:
        return f"检测到风险操作，是否确认？"
    else:
        return "危险操作已被系统拦截"
```

### 3.2 前端响应设计

#### 3.2.1 等级与UI对应关系

| 分数段 | 等级 | UI组件 | 交互方式 |
|--------|------|--------|---------|
| 0-3分 | SAFE | 无 | 静默执行，显示结果 |
| 4-6分 | MEDIUM | Notification通知 | 顶部通知"正在执行敏感操作"，3秒后自动消失 |
| 7-8分 | HIGH | Modal确认框 | 弹窗"检测到风险操作，是否确认？"+显示具体文件 |
| 9-10分 | CRITICAL | Alert警告 | 红色警告"危险操作已被拦截"+记录日志 |

#### 3.2.2 组件样式规范

**DangerConfirmModal（7-8分）**:
```css
- 宽度: 480px
- 背景: 白色
- 边框: 2px solid #faad14 (橙色)
- 图标: WarningOutlined (橙色)
- 标题: "危险操作确认"
- 按钮: "确认执行"（橙色）,"取消"（灰色）
```

**SecurityAlert（9-10分）**:
```css
- 使用 Ant Design Alert 组件
- type: "error"
- message: "危险操作已被系统拦截"
- description: 显示具体操作和风险信息
- closable: false
```

**SecurityNotification（4-6分）**:
```css
- 使用 Ant Design Notification 组件
- type: "warning"
- duration: 3秒
- placement: "top"
```

---

## 四、契约接口（API）

### 4.1 接口设计原则

**精简设计理由**:
1. **分数是核心**：0-10分是10级方案的核心，其他字段都可以从分数推导
2. **前端计算更灵活**：前端可以根据分数自定义处理逻辑
3. **后端职责单一**：后端只负责评分，前端负责UI响应
4. **减少数据传输**：字段少，网络开销小

### 4.2 TypeScript类型定义

```typescript
// 后端返回格式
interface SecurityCheckResponse {
  success: boolean;      // API是否成功调用
  data?: {
    score: number;       // 风险分数：0-10分，整数
    message: string;     // 用户可见的提示信息
  };
  error?: string;        // API调用失败时的错误信息
}

// 分数段定义（前端使用）
const RISK_LEVELS = {
  SAFE: { min: 0, max: 3, canProceed: true, ui: 'silent' },
  MEDIUM: { min: 4, max: 6, canProceed: true, ui: 'notification' },
  HIGH: { min: 7, max: 8, canProceed: false, ui: 'modal' },
  CRITICAL: { min: 9, max: 10, canProceed: false, ui: 'alert' }
} as const;

// 前端推导函数
function getRiskLevel(score: number) {
  if (score <= 3) return RISK_LEVELS.SAFE;
  if (score <= 6) return RISK_LEVELS.MEDIUM;
  if (score <= 8) return RISK_LEVELS.HIGH;
  return RISK_LEVELS.CRITICAL;
}
```

### 4.3 API端点

```
POST /api/v1/security/check
Request: { command: string }
Response: SecurityCheckResponse
```

### 4.4 响应示例

**示例1：安全操作（0-3分）**
```json
{
  "success": true,
  "data": {
    "score": 2,
    "message": "操作安全"
  }
}
```

**示例2：中等风险（4-6分）**
```json
{
  "success": true,
  "data": {
    "score": 5,
    "message": "操作存在风险，请注意"
  }
}
```

**示例3：高风险（7-8分）**
```json
{
  "success": true,
  "data": {
    "score": 8,
    "message": "检测到删除项目文件，是否确认？"
  }
}
```

**示例4：危险操作（9-10分）**
```json
{
  "success": true,
  "data": {
    "score": 10,
    "message": "危险操作已被系统拦截"
  }
}
```

**示例5：API错误**
```json
{
  "success": false,
  "error": "安全检查服务异常"
}
```

### 4.5 前端使用示例

#### 基础调用

```typescript
import { securityApi } from './api';

// 调用安全检测
const response = await securityApi.checkCommand('rm tests/11.txt');

// 处理响应
if (response.success && response.data) {
  const { score, message } = response.data;
  
  // 根据分数推导等级
  const riskLevel = getRiskLevel(score);
  
  // 根据UI类型处理
  switch (riskLevel.ui) {
    case 'silent':
      // 0-3分：直接执行
      await sendMessage(command);
      break;
    case 'notification':
      // 4-6分：显示通知
      showNotification(message);
      await sendMessage(command);
      break;
    case 'modal':
      // 7-8分：弹窗确认
      const confirmed = await showConfirmModal(message);
      if (confirmed) {
        await sendMessage(command);
      }
      break;
    case 'alert':
      // 9-10分：显示警告，不执行
      showAlert(message);
      break;
  }
}
```

#### 封装 Hook（推荐）

```typescript
// hooks/useSecurityCheck.ts
import { securityApi } from '../services/api';

export function useSecurityCheck() {
  const check = async (command: string) => {
    const response = await securityApi.checkCommand(command);
    
    if (!response.success) {
      throw new Error(response.error || '安全检查失败');
    }
    
    const { score, message } = response.data;
    const riskLevel = getRiskLevel(score);
    
    return {
      score,
      message,
      level: riskLevel.level,
      canProceed: riskLevel.canProceed,
      ui: riskLevel.ui
    };
  };
  
  return { check };
}
```

### 4.6 后端实现要求

#### shell_security.py 新增函数

```python
def calculate_risk_score(command: str) -> int:
    """
    计算命令风险分数 (0-10)
    
    计算公式: (操作分数 + 对象分数) / 2 × 范围系数
    
    Returns:
        int: 0-10的整数分数
    """
    # 1. 解析操作类型
    op_type = parse_operation_type(command)
    type_score = OPERATION_WEIGHTS[op_type]
    
    # 2. 解析操作对象
    op_target = parse_operation_target(command)
    target_score = TARGET_WEIGHTS[op_target]
    
    # 3. 解析影响范围
    scope = parse_impact_scope(command)
    scope_multiplier = SCOPE_MULTIPLIERS[scope]
    
    # 4. 计算总分
    raw_score = (type_score + target_score) / 2 * scope_multiplier
    final_score = min(10, int(raw_score))
    
    return final_score


def get_risk_message(score: int, command: str) -> str:
    """
    根据分数生成用户提示信息
    
    Args:
        score: 风险分数
        command: 原始命令
    
    Returns:
        str: 用户可见的提示信息
    """
    if score <= 3:
        return "操作安全"
    elif score <= 6:
        return "操作存在风险，请注意"
    elif score <= 8:
        return f"检测到风险操作，是否确认？"
    else:
        return "危险操作已被系统拦截"
```

#### security.py 修改

```python
class SecurityCheckResponse(BaseModel):
    """安全检查响应"""
    success: bool = Field(..., description="API是否成功")
    data: Optional[dict] = Field(None, description="响应数据")
    error: Optional[str] = Field(None, description="错误信息")


@router.post("/security/check", response_model=SecurityCheckResponse)
async def check_security(request: SecurityCheckRequest):
    """检查命令安全性"""
    try:
        # 计算风险分数
        score = calculate_risk_score(request.command)
        
        # 生成用户提示
        message = get_risk_message(score, request.command)
        
        return SecurityCheckResponse(
            success=True,
            data={
                "score": score,
                "message": message
            }
        )
    except Exception as e:
        return SecurityCheckResponse(
            success=False,
            error=f"安全检查失败: {str(e)}"
        )
```

### 4.7 与原版设计的对比

| 对比项 | 23.2原版 | 本设计精简版 | 变化 |
|--------|----------|--------------|------|
| 字段数量 | 8个 | 4个 | 减少50% |
| score | 有 | 有 | 保持 |
| level | 有 | 无 | 删除，可推导 |
| canProceed | 有 | 无 | 删除，可推导 |
| message | 有 | 有 | 保持 |
| riskDetails | 有 | 无 | 删除 |
| success | 有 | 有 | 保持 |
| error | 有 | 有 | 保持 |

**精简版优势**：
1. 字段少，传输效率高
2. 职责清晰，后端只评分
3. 前端灵活，可自定义处理逻辑
4. 易于维护，没有冗余数据

---

## 五、实施分工

### 5.1 总体原则与依赖关系

**北京老陈明确要求**:
1. **先讨论后动手**：分工确认后才能开始
2. **后端先完成**：后端评分逻辑完成后，再进行前端联调
3. **全量测试**：每个分数段都要有对应测试用例
4. **反馈机制**：不管什么危险等级，都要给用户反馈信息

**前后端依赖关系图**:
```
阶段1: 后端独立开发
├── 小沈完成步骤1-9（shell_security.py + chat.py修改）
└── 交付物: 可运行的API接口 /api/v1/security/check
    ↓
阶段2: 联调接口
├── 小沈提供API文档和curl测试用例
├── 小新验证接口可用性（使用curl测试）
└── 交付物: 双方确认接口契约无误
    ↓
阶段3: 前端独立开发
├── 小新完成步骤1-11（前端所有步骤）
└── 交付物: 前端代码提交到feature/2.1-frontend-ui
    ↓
阶段4: 联合测试
├── 双方共同执行测试用例
└── 交付物: 测试报告+bug修复
```

**关键依赖说明**:
| 前端步骤 | 依赖后端步骤 | 依赖说明 |
|---------|-------------|---------|
| 前端步骤1（类型定义） | 后端步骤9 | 需要知道API返回的确切字段（score+message） |
| 前端步骤2（API适配） | 后端步骤11 | 需要API端点可用才能调试 |
| 前端步骤3（状态管理） | 后端步骤9 | 需要知道score范围和message格式 |
| 前端步骤4-6（UI组件） | 无 | 可独立开发，使用mock数据 |
| 前端步骤7（集成） | 后端步骤10-11 | 需要完整API联调 |
| 前端步骤8-11 | 后端全部完成 | 需要端到端测试 |

### 5.2 后端部分（小沈负责）

| 步骤 | 文件 | 具体内容 |
|------|------|---------|
| 1 | `shell_security.py` | 添加操作类型权重表（READ/CREATE/UPDATE/DELETE/EXEC） |
| 2 | `shell_security.py` | 添加操作对象权重表（临时/用户/项目/系统） |
| 3 | `shell_security.py` | 添加影响范围系数（单文件/目录/跨目录/系统级） |
| 4 | `shell_security.py` | 添加解析函数：parse_operation_type() |
| 5 | `shell_security.py` | 添加解析函数：parse_operation_target() |
| 6 | `shell_security.py` | 添加解析函数：parse_impact_scope() |
| 7 | `shell_security.py` | 添加核心评分函数：calculate_risk_score() |
| 8 | `shell_security.py` | 添加风险等级判定：get_risk_message() |
| 9 | `shell_security.py` | 修改check()函数返回格式（返回score+message） |
| 10 | `chat.py` | 适配新返回格式，根据score处理不同逻辑 |
| 11 | 后端API | 确认/修改 `/security/check` 接口 |

**后端实施顺序**:
1. 先完成步骤1-3（评分数据和解析函数）
2. 再完成步骤4-8（评分核心函数）
3. 然后完成步骤9（修改check函数）
4. 最后步骤10-11（修改调用方和API）

### 5.3 前端部分（小新负责）

#### 第一阶段：基础设施（优先级：高）

| 步骤 | 文件 | 具体内容 | 验收标准 |
|------|------|---------|---------|
| 1 | `src/types/security.ts` | 创建安全相关类型定义文件，包含SecurityCheckResponse、RiskLevel等 | 类型定义完整，无ts错误 |
| 2 | `src/services/api.ts` | 更新securityApi.checkCommand函数，适配新返回格式（score+message） | 能正确调用并解析响应 |
| 3 | `src/stores/securityStore.ts` | 创建Pinia状态管理，存储当前安全检测结果 | 状态可跨组件共享 |

#### 第二阶段：UI组件（优先级：高）

| 步骤 | 文件 | 具体内容 | 验收标准 |
|------|------|---------|---------|
| 4 | `src/components/DangerConfirmModal/index.tsx` | 创建危险操作确认弹窗（7-8分）<br>- 显示风险等级（橙色警告图标）<br>- 显示具体操作内容<br>- "确认执行"和"取消"按钮<br>- 样式：圆角、阴影、动画 | 弹窗可正常显示关闭，按钮可点击 |
| 5 | `src/components/SecurityAlert/index.tsx` | 创建危险警告组件（9-10分）<br>- 红色Alert样式<br>- 禁止图标<br>- 明确告知"操作被拦截" | Alert样式正确，信息清晰 |
| 6 | `src/components/SecurityNotification/index.tsx` | 创建顶部通知组件（4-6分）<br>- 黄色背景<br>- 3秒后自动消失<br>- 显示"正在执行敏感操作" | 通知显示和消失正常 |

#### 第三阶段：集成（优先级：高）

| 步骤 | 文件 | 具体内容 | 验收标准 |
|------|------|---------|---------|
| 7 | `src/components/Chat/index.tsx` | 集成安全检测：<br>- 发送消息前调用checkCommand<br>- 根据score决定执行逻辑：<br>  - 0-3分: 直接发送<br>  - 4-6分: 显示通知+发送<br>  - 7-8分: 显示Modal，等待确认<br>  - 9-10分: 显示Alert，不发送 | 各分数段处理正确 |
| 8 | `src/components/Chat/MessageItem.tsx` | 消息项显示安全状态标记（可选） | 如实现，标记显示正确 |

#### 第四阶段：错误处理（优先级：中）

| 步骤 | 文件 | 具体内容 | 验收标准 |
|------|------|---------|---------|
| 9 | `src/App.tsx` | 添加全局错误边界，捕获安全检测API异常 | 错误时显示友好提示 |
| 10 | `src/services/api.ts` | 添加请求超时处理（5秒超时） | 超时后显示"检测超时，是否继续？" |
| 11 | `src/stores/securityStore.ts` | 添加错误状态管理 | 错误状态可全局访问 |

**前端实施顺序**:
1. 等待后端完成步骤1-9
2. 完成后端联调（测试API）
3. 前端完成步骤1-3（基础设施）
4. 前端完成步骤4-6（UI组件）
5. 前端完成步骤7-8（集成）
6. 前端完成步骤9-11（错误处理）

### 5.4 联调测试（共同）

| 步骤 | 内容 | 负责人 |
|------|------|--------|
| 1 | 后端自测：curl命令测试各分数段用例 | 小沈 |
| 2 | 前后端API联调 | 小沈+小新 |
| 3 | 端到端测试：验证各风险等级UI响应 | 小新 |

---

## 六、测试与调试

### 6.1 测试用例设计

#### 6.1.1 基础功能测试

| 序号 | 测试命令 | 预期分数 | 预期处理 | 测试类型 |
|------|---------|---------|---------|---------|
| 1 | `cat readme.txt` | 0-3分 | 直接执行 | 安全操作 |
| 2 | `rm tests/11.txt` | 7-8分 | 弹窗确认 | 高风险操作 |
| 3 | `del temp.log` | 4-6分 | 提示执行 | 中等风险 |
| 4 | `rm -rf /` | 9-10分 | 直接拒绝 | 危险操作 |
| 5 | `删除文件 tests/11.txt` | 7-8分 | 弹窗确认 | 中文指令 |
| 6 | `mkdir temp/test` | 3-4分 | 直接执行 | 创建操作 |
| 7 | `ls -la` | 0-2分 | 直接执行 | 查询操作 |
| 8 | `sudo rm -rf /` | 10分 | 直接拒绝 | 系统级危险 |
| 9 | `del /s /q build\` | 6-7分 | 提示执行 | 目录删除 |
| 10 | `rm *.tmp` | 5-6分 | 提示执行 | 批量删除临时文件 |

#### 6.1.2 边界值测试（关键）

| 序号 | 测试命令 | 预期分数 | 边界说明 | 预期处理 |
|------|---------|---------|---------|---------|
| 11 | `cat file.txt` | 3分 | SAFE/MEDIUM边界 | 直接执行（≤3分） |
| 12 | `echo "test" > temp.log` | 4分 | SAFE/MEDIUM边界 | 提示执行（>3分） |
| 13 | `del temp.log` | 6分 | MEDIUM/HIGH边界 | 提示执行（≤6分） |
| 14 | `rm tests/11.txt` | 7分 | MEDIUM/HIGH边界 | 弹窗确认（>6分） |
| 15 | `rm -rf tests/` | 8分 | HIGH/CRITICAL边界 | 弹窗确认（≤8分） |
| 16 | `rm -rf /` | 9分 | HIGH/CRITICAL边界 | 直接拒绝（>8分） |
| 17 | `sudo rm -rf /` | 10分 | 最高分值 | 直接拒绝+告警 |
| 18 | `cat .cache/data.json` | 1分 | 最低分值 | 直接执行 |

#### 6.1.3 异常输入测试

| 序号 | 测试输入 | 预期行为 | 说明 |
|------|---------|---------|------|
| 19 | 空字符串 `""` | 返回safe=0或error | 空输入处理 |
| 20 | `null` | 返回error | null输入处理 |
| 21 | 超长命令（>1000字符） | 返回error或截断处理 | 超长输入处理 |
| 22 | 特殊字符 `; rm -rf /` | 正确识别并评分 | 命令注入尝试 |
| 23 | Unicode字符 `删除🗑️文件` | 正确解析中文 | Emoji处理 |
| 24 | 混合语言 `delete 文件.txt` | 正确识别操作类型 | 中英混合 |

#### 6.1.4 复杂场景测试

| 序号 | 测试命令 | 预期分数 | 说明 |
|------|---------|---------|------|
| 25 | `rm -rf tests/ && cat readme.txt` | 10分 | 复合命令取最高分 |
| 26 | `find . -name "*.tmp" -delete` | 6-7分 | find+delete组合 |
| 27 | `cat tests/11.txt | rm` | 8分 | 管道命令识别 |
| 28 | `echo "y" | rm -i tests/11.txt` | 7分 | 交互式删除 |
| 29 | `rm -- -rf`（删除名为-rf的文件） | 7分 | 特殊文件名 |
| 30 | `rm -rf ./-rf` | 7分 | 当前目录特殊文件 |

### 6.2 前端测试验收标准

| 测试项 | 输入 | 预期结果 |
|--------|------|---------|
| SAFE级别 | `cat readme.txt` | 直接执行，无弹窗 |
| MEDIUM级别 | `del temp.log` | 顶部通知，3秒后消失 |
| HIGH级别 | `rm tests/11.txt` | 显示Modal，需用户确认 |
| CRITICAL级别 | `rm -rf /` | 显示Alert，禁止执行 |
| 中文指令 | `删除文件 tests/11.txt` | 正确识别为HIGH级别 |
| API超时 | 网络断开 | 显示"检测超时"提示 |
| API错误 | 后端500错误 | 显示"检测失败"提示 |

### 6.3 后端测试方法

**使用curl测试**:
```bash
# 测试安全操作
curl -X POST http://localhost:8000/api/v1/security/check \
  -H "Content-Type: application/json" \
  -d '{"command": "cat readme.txt"}'

# 测试高风险操作
curl -X POST http://localhost:8000/api/v1/security/check \
  -H "Content-Type: application/json" \
  -d '{"command": "rm tests/11.txt"}'

# 测试危险操作
curl -X POST http://localhost:8000/api/v1/security/check \
  -H "Content-Type: application/json" \
  -d '{"command": "rm -rf /"}'
```

### 6.4 数据流向验证

```
用户点击发送/执行
    ↓
Chat组件调用 securityApi.checkCommand(command)
    ↓
后端 calculate_risk_score(command)
    ↓
返回 {score, message}
    ↓
前端根据score分支处理：
    ├─ 0-3分: 直接执行，无UI反馈
    ├─ 4-6分: 执行 + 顶部通知
    ├─ 7-8分: 显示Modal → 用户确认 → 执行/取消
    └─ 9-10分: 显示Alert，不执行
```

### 6.5 风险控制与回滚

**回滚方案**:
- 后端：保留原check()函数，改名check_legacy()，新函数check_v2()
- 前端：通过feature flag控制，可开关新安全检测
- 如果新方案有bug，10分钟内可回滚到v0.3.6

---

## 七、参考资料

### 7.1 参考标准

| 标准名称 | 版本 | 参考内容 | 链接 |
|---------|------|---------|------|
| **CVSS** | v3.1 | 通用漏洞评分系统，0-10分制分级方法 | https://www.first.org/cvss/ |
| **ISO/IEC 27001** | 2013 | 信息安全管理体系，风险评估方法 | https://www.iso.org/standard/54534.html |
| **OWASP ASVS** | v4.0 | 应用安全验证标准，安全配置建议 | https://owasp.org/www-project-asvs/ |

### 7.2 相关文档

| 文档名称 | 位置 | 说明 |
|---------|------|------|
| **工作日志** | `工作日志-2026-02-19.md` | 完整的问题讨论和方案演进过程 |
| **第18章** | 工作日志第1475-1648行 | 10级CRSS方案原始设计 |
| **第22章** | 工作日志第1871-1960行 | 后端实施分工原始计划 |
| **第23章** | 工作日志第2088-2289行 | 前端详细设计（接口部分已更新为第24章） |
| **第24章** | 工作日志第2293-2640行 | 精简版API契约设计 |

### 7.3 技术参考

| 技术/工具 | 用途 | 版本 |
|----------|------|------|
| **FastAPI** | 后端API框架 | >=0.104.0 |
| **React** | 前端框架 | >=18.0.0 |
| **Ant Design** | UI组件库 | >=5.0.0 |
| **Pinia** | 前端状态管理 | >=2.0.0 |

---

## 附录：设计原则总结

1. **单一职责**：后端只负责评分，前端负责UI响应
2. **数据最小化**：只传必要的字段，不传冗余数据
3. **推导而非存储**：可计算的数据不存储，减少维护成本
4. **前端灵活**：前端可以根据分数自定义处理逻辑
5. **全覆盖**：0-10分无空隙、不重合
6. **可量化**：三维评分模型精确计算风险
7. **用户友好**：每个等级都有明确的用户反馈

---

## 附录：安全规则完整清单

**【版本】: v1.2 : 2026-02-20 08:14:42: 补充白名单黑名单完整清单**

### 一、危险命令黑名单（DANGEROUS_COMMANDS）

**说明**：匹配以下命令直接返回10分（最高危险等级）

#### 1.1 系统破坏类 - 递归删除

| 命令 | 平台 | 危险等级 |
|------|------|---------|
| `rm -rf /` | Linux | 10分 |
| `rm -rf /*` | Linux | 10分 |
| `rm -rf .` | Linux | 10分 |
| `rm -rf *` | Linux | 10分 |
| `rm -rf /bin` | Linux | 10分 |
| `rm -rf /usr` | Linux | 10分 |
| `rm -rf /etc` | Linux | 10分 |
| `rm -rf /home` | Linux | 10分 |
| `rm -rf /root` | Linux | 10分 |
| `rm -rf /var` | Linux | 10分 |
| `rm -rf /tmp` | Linux | 10分 |
| `rm -rf $HOME` | Linux | 10分 |
| `rm -rf ~` | Linux | 10分 |
| `rmdir /` | Linux | 10分 |
| `rmdir /*` | Linux | 10分 |
| `rmdir /etc` | Linux | 10分 |
| `del /f /s /q` | Windows | 10分 |
| `deltree /` | Windows | 10分 |
| `rd /s /q` | Windows | 10分 |

#### 1.2 磁盘格式化类

| 命令 | 平台 | 危险等级 |
|------|------|---------|
| `format` | 通用 | 10分 |
| `format c:` | Windows | 10分 |
| `format d:` | Windows | 10分 |
| `mkfs` | Linux | 10分 |
| `mkfs.ext4` | Linux | 10分 |
| `mkfs.ext3` | Linux | 10分 |
| `mkfs.ntfs` | Linux | 10分 |
| `dd if=/dev/zero` | Linux | 10分 |
| `dd if=/dev/urandom` | Linux | 10分 |
| `dd of=/dev/sda` | Linux | 10分 |
| `shred -n` | Linux | 10分 |
| `shred -z` | Linux | 10分 |

#### 1.3 权限提升类

| 命令 | 平台 | 危险等级 |
|------|------|---------|
| `sudo` | Linux | 10分 |
| `sudo -i` | Linux | 10分 |
| `sudo -s` | Linux | 10分 |
| `sudo su` | Linux | 10分 |
| `su -` | Linux | 10分 |
| `su root` | Linux | 10分 |
| `chmod 777 /` | Linux | 10分 |
| `chmod -R 777` | Linux | 10分 |
| `chmod 000` | Linux | 10分 |
| `chown -R` | Linux | 10分 |

#### 1.4 网络攻击类

| 命令 | 平台 | 危险等级 |
|------|------|---------|
| `nc -e` | Linux | 10分 |
| `ncat -e` | Linux | 10分 |
| `bash -i` | Linux | 10分 |
| `sh -i` | Linux | 10分 |
| `/dev/tcp/` | Linux | 10分 |
| `nmap` | Linux | 10分 |
| `nikto` | Linux | 10分 |
| `sqlmap` | Linux | 10分 |
| `nc -l -p` | Linux | 10分 |
| `nc -lvnp` | Linux | 10分 |

#### 1.5 数据泄露类

| 命令 | 平台 | 危险等级 |
|------|------|---------|
| `cat /etc/passwd` | Linux | 10分 |
| `cat /etc/shadow` | Linux | 10分 |
| `cat /etc/sudoers` | Linux | 10分 |
| `cat ~/.ssh/id_rsa` | Linux | 10分 |
| `type C:\Windows\System32\config\SAM` | Windows | 10分 |
| `type C:\Windows\System32\config\SYSTEM` | Windows | 10分 |
| `reg query HKLM\` | Windows | 10分 |

#### 1.6 进程终止类

| 命令 | 平台 | 危险等级 |
|------|------|---------|
| `kill -9 -1` | Linux | 10分 |
| `taskkill /f /im` | Windows | 10分 |
| `pkill -9` | Linux | 10分 |
| `killall -9` | Linux | 10分 |
| `taskkill /im explorer.exe` | Windows | 10分 |
| `shutdown -r now` | Linux | 10分 |
| `reboot` | Linux | 10分 |
| `init 6` | Linux | 10分 |
| `init 0` | Linux | 10分 |

#### 1.7 中文危险命令

| 命令 | 危险等级 |
|------|---------|
| `读取密码` | 10分 |
| `读取shadow` | 10分 |
| `查看密码` | 10分 |
| `获取密码` | 10分 |
| `格式化硬盘` | 10分 |
| `格式化磁盘` | 10分 |
| `删除所有` | 10分 |
| `删除全部` | 10分 |
| `清除硬盘` | 10分 |
| `清除磁盘` | 10分 |

---

### 二、危险命令模式（DANGEROUS_PATTERNS）

**说明**：使用正则表达式匹配的危险命令模式

| 模式 | 匹配示例 | 危险等级 |
|-------|---------|---------|
| `rm\s+-[rf]+\s+[/\\*]+` | `rm -rf /`, `rm -rf /*` | 10分 |
| `rmdir\s+[/\\*]+` | `rmdir /`, `rmdir /etc` | 10分 |
| `del\s+.*/s\s+/q` | `del /s /q` | 10分 |
| `format\s+[a-zA-Z]:?` | `format c:` | 10分 |
| `mkfs\.` | `mkfs.ext4` | 10分 |
| `dd\s+.*of=/dev/` | `dd of=/dev/sda` | 10分 |
| `sudo\s+` | `sudo rm -rf /` | 10分 |
| `chmod\s+777\s+[/\\]` | `chmod 777 /` | 10分 |
| `nc\s+-[elvp]\s+` | `nc -e /bin/bash` | 10分 |
| `bash\s+-i` | `bash -i` | 10分 |
| `nmap\s+` | `nmap -sS 192.168.1.1` | 10分 |
| `kill\s+-9\s+-1` | `kill -9 -1` | 10分 |
| `shutdown\s+` | `shutdown -h now` | 10分 |

---

### 三、系统关键目录列表（SYSTEM_CRITICAL_DIRS）

**说明**：以下目录被识别为系统关键目录，对这些目录的危险操作将被拦截

#### 3.1 Windows系统目录

| 目录 | 说明 |
|------|------|
| `C:\Windows` | Windows系统主目录 |
| `C:\Windows\System32` | 系统32位DLL目录 |
| `C:\Windows\SysWOW64` | 64位系统32位DLL目录 |
| `C:\Program Files` | 程序安装目录 |
| `C:\Program Files (x86)` | 32位程序目录 |
| `C:\Users\Public` | 公共用户目录 |
| `C:\Recovery` | 系统恢复目录 |

#### 3.2 Linux系统目录

| 目录 | 说明 |
|------|------|
| `/bin` | 系统二进制文件 |
| `/sbin` | 系统管理员二进制 |
| `/usr/bin` | 用户二进制 |
| `/usr/sbin` | 用户管理员二进制 |
| `/etc` | 系统配置文件 |
| `/sys` | 系统内核参数 |
| `/proc` | 进程信息 |
| `/dev` | 设备文件 |
| `/boot` | 启动文件 |
| `/root` | root用户目录 |
| `/var` | 可变数据 |
| `/opt` | 可选软件 |
| `/srv` | 服务数据 |

---

### 四、项目保护目录列表（PROJECT_PROTECTED_DIRS）

**说明**：OmniAgentAs-desk项目需要保护的关键文件和目录

| 目录/文件 | 说明 |
|----------|------|
| `backend/` | 后端源代码 |
| `frontend/` | 前端源代码 |
| `config/` | 配置文件目录 |
| `tests/` | 测试文件目录 |
| `doc-阶段2.1/` | 阶段2.1文档 |
| `notes/` | 开发笔记 |
| `src/` | 源代码目录 |
| `.git/` | Git版本控制 |
| `package.json` | Node.js配置 |
| `requirements.txt` | Python依赖 |
| `version.txt` | 版本文件 |

---

### 五、操作类型权重表（OPERATION_WEIGHTS）

**说明**：根据操作类型计算风险分数

| 操作类型 | 权重范围 | 默认分数 | 关键词 |
|---------|---------|---------|---------|
| **READ** | 0-2 | 1分 | cat, ls, grep, 查看, 读取, type, dir, 运行 |
| **CREATE** | 2-4 | 3分 | mkdir, touch, 创建, 新建, md |
| **UPDATE** | 4-7 | 5分 | edit, sed, 修改, 编辑, 更新, echo, write |
| **DELETE** | 6-10 | 8分 | rm, del, 删除, remove, 清除, rmdir, rd |
| **EXEC** | 5-10 | 7分 | sudo, run, exec, 执行, start |

---

### 六、操作对象权重表（TARGET_WEIGHTS）

**说明**：根据操作对象类型计算风险分数

| 对象类型 | 权重范围 | 默认分数 | 匹配模式 |
|---------|---------|---------|---------|
| **TEMP** | 0-2 | 1分 | .tmp, .cache, temp, .log, log |
| **USER** | 3-5 | 4分 | ~, /home/, 文档, 用户, documents |
| **PROJECT** | 6-8 | 7分 | src/, app/, backend/, frontend/, .py, .js, .ts, tests/, config/, .git |
| **SYSTEM** | 8-10 | 9分 | C:\Windows, /bin, /etc, /sbin, /usr, 系统, windows\system32, registry, 密码, shadow, passwd, SAM, 配置, 注册表 |

---

### 七、影响范围系数（SCOPE_MULTIPLIERS）

**说明**：根据操作影响范围调整风险分数

| 范围类型 | 系数 | 说明 | 示例 |
|---------|------|------|------|
| **SINGLE_FILE** | 1.0 | 单文件 | `rm tests/11.txt` |
| **DIRECTORY** | 1.5 | 目录 | `rmdir tests/` |
| **CROSS_DIR** | 2.0 | 跨目录/批量 | `rm tests/*.txt` |
| **SYSTEM** | 3.0 | 系统级 | `rm -rf /` |

---

### 八、范围识别模式（SCOPE_PATTERNS）

**说明**：用于识别操作影响范围的关键词模式

| 范围类型 | 识别模式 |
|---------|---------|
| **SINGLE_FILE** | `^[^*?]+\.[a-zA-Z0-9]+$`, `^[^*?/]+$` |
| **DIRECTORY** | `[/\\]$`, `\$` |
| **CROSS_DIR** | `\*`, `\?`, 所有, 批量, 全部, `\*\.` |
| **SYSTEM** | `-rf`, `/s\s+/q`, `^[/\\]$`, 根目录, 全盘, `-r\s+-f` |

---

### 九、风险等级划分

| 分数段 | 等级 | UI组件 | 用户提示 |
|--------|------|--------|---------|
| 0-3分 | SAFE | 无 | 操作安全 |
| 4-6分 | MEDIUM | Notification通知 | 操作存在风险，请注意 |
| 7-8分 | HIGH | Modal确认框 | 检测到风险操作，是否确认？ |
| 9-10分 | CRITICAL | Alert警告 | 危险操作已被系统拦截 |

---

**更新时间**: 2026-02-20 08:14:42  
**更新人**: 小沈

**相关章节引用**:
- 第14章：安全问题修复完成（问题背景）
- 第17章：安全分级分析与方法（初步方案）
- 第18章：10级安全分类体系方案（CRSS核心设计）- 原文采用
- 第22章：安全分级方案实施分工（分工计划）- 原文采用
- 第23章：前端分工补充（前端详细设计）- 部分采用，接口部分替换为第24章
- 第24章：API契约设计优化（精简版接口）- 原文采用
