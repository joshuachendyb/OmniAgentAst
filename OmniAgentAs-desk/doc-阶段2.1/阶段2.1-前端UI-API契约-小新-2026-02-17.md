# API契约文档 - 阶段2.1

**制定人**: 小新
**制定时间**: 2026-02-17 23:35:00
**用途**: 前后端开发约定，Mock数据参考

---

## 版本历史

【版本】: v1.2 : 2026-02-18 11:00:00: 修正创建会话响应字段（增加updated_at、message_count），确认健康检查版本号动态读取，明确会话列表对象格式和execution_steps数组格式
【版本】: v1.1 : 2026-02-18 08:30:00: 补充缺失的对话接口和健康检查接口，完善TypeScript类型定义
【版本】: v1.0 : 2026-02-17 23:35:00: 初始版本，定义配置管理、会话管理、安全接口和流式执行接口

---

## 接口索引

### 配置管理接口 (3个)
- [1.1 获取配置](#11-获取配置) `GET /api/v1/config`
- [1.2 更新配置](#12-更新配置) `PUT /api/v1/config`
- [1.3 验证配置](#13-验证配置) `POST /api/v1/config/validate`

### 会话管理接口 (4个)
- [2.1 创建会话](#21-创建会话) `POST /api/v1/sessions`
- [2.2 获取会话列表](#22-获取会话列表) `GET /api/v1/sessions`
- [2.3 获取会话消息](#23-获取会话消息) `GET /api/v1/sessions/{session_id}/messages`
- [2.4 删除会话](#24-删除会话) `DELETE /api/v1/sessions/{session_id}`

### 安全接口 (1个)
- [3.1 检查命令安全性](#31-检查命令安全性) `POST /api/v1/security/check`

### 对话接口 (3个)
- [4.1 发送消息](#41-发送消息) `POST /api/v1/chat`
- [4.2 验证AI服务](#42-验证ai服务) `GET /api/v1/chat/validate`
- [4.3 切换AI提供商](#43-切换ai提供商) `POST /api/v1/chat/switch/{provider}`

### 健康检查接口 (2个)
- [5.1 服务健康检查](#51-服务健康检查) `GET /api/v1/health`
- [5.2 回显测试](#52-回显测试) `POST /api/v1/echo`

### 流式执行过程接口 (1个)
- [6.1 获取执行过程（流式）](#61-获取执行过程流式) `GET /api/v1/chat/execution/{session_id}/stream`

**接口总计**: 14个

---

## 1. 配置管理接口

### 1.1 获取配置
```
GET /api/v1/config
```

**响应**:
```json
{
  "ai_provider": "zhipuai",
  "ai_model": "glm-4.7-flash",
  "api_key_configured": true,
  "theme": "light",
  "language": "zh-CN"
}
```

**字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| ai_provider | string | 当前AI提供商: zhipuai/opencode |
| ai_model | string | 当前模型名称 |
| api_key_configured | boolean | API Key是否已配置（脱敏） |
| theme | string | 主题: light/dark |
| language | string | 语言: zh-CN/en |

---

### 1.2 更新配置
```
PUT /api/v1/config
```

**请求**:
```json
{
  "ai_provider": "zhipuai",
  "zhipu_api_key": "sk-xxxxxxxx",
  "opencode_api_key": "",
  "theme": "light"
}
```

**响应**:
```json
{
  "success": true,
  "message": "配置已更新"
}
```

---

### 1.3 验证配置
```
POST /api/v1/config/validate
```

**请求**:
```json
{
  "provider": "zhipuai",
  "api_key": "sk-xxxxxxxx"
}
```

**响应**:
```json
{
  "valid": true,
  "message": "API Key有效",
  "model": "glm-4.7-flash"
}
```

**错误响应**:
```json
{
  "valid": false,
  "message": "API Key无效: 认证失败"
}
```

---

## 2. 会话管理接口

### 2.1 创建会话
```
POST /api/v1/sessions
```

**响应**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "title": "新会话",
  "created_at": "2026-02-17T23:35:00Z",
  "updated_at": "2026-02-17T23:35:00Z",
  "message_count": 0
}
```

**字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| session_id | string | 会话唯一标识符 |
| title | string | 会话标题 |
| created_at | string | 创建时间（ISO 8601格式） |
| updated_at | string | 更新时间（ISO 8601格式），新建时与created_at相同 |
| message_count | number | 消息数量，新建时为0 |

---

### 2.2 获取会话列表
```
GET /api/v1/sessions?page=1&page_size=20&keyword=xxx
```

**响应**:
```json
{
  "total": 100,
  "page": 1,
  "page_size": 20,
  "sessions": [
    {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "title": "整理下载文件夹",
      "created_at": "2026-02-17T10:00:00Z",
      "updated_at": "2026-02-17T11:30:00Z",
      "message_count": 15
    }
  ]
}
```

---

### 2.3 获取会话消息
```
GET /api/v1/sessions/{session_id}/messages
```

**响应**:
```json
{
  "session_id": "550e8400-e29b-41d4-a716-446655440000",
  "messages": [
    {
      "id": 1,
      "role": "user",
      "content": "帮我整理下载文件夹",
      "timestamp": "2026-02-17T10:00:00Z",
      "execution_steps": null
    },
    {
      "id": 2,
      "role": "assistant",
      "content": "好的，我发现下载文件夹有15个文件...",
      "timestamp": "2026-02-17T10:00:05Z",
      "execution_steps": [
        {
          "type": "thought",
          "content": "我需要先查看下载文件夹的内容",
          "timestamp": 1708201200000
        },
        {
          "type": "action",
          "tool": "list_directory",
          "params": {"path": "/Users/xxx/Downloads"},
          "result": "15个文件",
          "timestamp": 1708201205000
        }
      ]
    }
  ]
}
```

**字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| session_id | string | 会话唯一标识符 |
| messages | array | 消息列表 |
| messages[].id | number | 消息ID |
| messages[].role | string | 角色：user/assistant/system |
| messages[].content | string | 消息内容 |
| messages[].timestamp | string | 消息时间（ISO 8601格式） |
| messages[].execution_steps | array\|null | **数组格式**的执行步骤，用户消息为null，AI消息为步骤数组 |

---

### 2.4 删除会话
```
DELETE /api/v1/sessions/{session_id}
```

**响应**:
```json
{
  "success": true,
  "message": "会话已删除"
}
```

---

## 3. 安全接口

### 3.1 检查命令安全性
```
POST /api/v1/security/check
```

**请求**:
```json
{
  "command": "rm -rf /"
}
```

**响应**:
```json
{
  "safe": false,
  "risk": "检测到危险命令: rm -rf /",
  "suggestion": "该操作将删除系统所有文件"
}
```

**安全命令响应**:
```json
{
  "safe": true,
  "risk": "",
  "suggestion": ""
}
```

---

## 4. 对话接口

### 4.1 发送消息
```
POST /api/v1/chat
```

**请求**:
```json
{
  "messages": [
    {"role": "user", "content": "帮我整理下载文件夹"}
  ],
  "stream": false,
  "temperature": 0.7
}
```

**字段说明**:
| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| messages | array | 是 | 消息列表，包含role和content |
| stream | boolean | 否 | 是否流式返回，默认false |
| temperature | number | 否 | 温度参数，默认0.7 |

**响应**:
```json
{
  "success": true,
  "content": "好的，我发现下载文件夹有15个文件...",
  "model": "glm-4-flash",
  "error": null
}
```

**错误响应**:
```json
{
  "success": false,
  "content": "",
  "model": "",
  "error": "API调用失败: 网络超时"
}
```

---

### 4.2 验证AI服务
```
GET /api/v1/chat/validate
```

**响应**:
```json
{
  "success": true,
  "provider": "zhipuai",
  "model": "glm-4-flash",
  "message": "服务运行正常"
}
```

**错误响应**:
```json
{
  "success": false,
  "provider": "",
  "model": "",
  "message": "API Key无效"
}
```

---

### 4.3 切换AI提供商
```
POST /api/v1/chat/switch/{provider}
```

**路径参数**:
| 参数 | 类型 | 说明 |
|------|------|------|
| provider | string | 提供商: zhipuai 或 opencode |

**响应**:
```json
{
  "success": true,
  "provider": "opencode",
  "model": "MiniMax-M2.5",
  "message": "已切换到OpenCode"
}
```

---

## 5. 健康检查接口

### 5.1 服务健康检查
```
GET /api/v1/health
```

**响应**:
```json
{
  "status": "healthy",
  "timestamp": "2026-02-17T23:35:00Z",
  "version": "0.2.3"
}
```

**字段说明**:
| 字段 | 类型 | 说明 |
|------|------|------|
| status | string | 服务状态：healthy/degraded/unhealthy |
| timestamp | string | 当前时间（ISO 8601格式） |
| version | string | 服务版本号，**从version.txt动态读取**，非硬编码 |

---

### 5.2 回显测试
```
POST /api/v1/echo
```

**请求**:
```json
{
  "message": "Hello"
}
```

**响应**:
```json
{
  "received": "Hello",
  "timestamp": "2026-02-17T23:35:00Z"
}
```

---

## 6. 流式执行过程接口

### 6.1 获取执行过程（流式）
```
GET /api/v1/chat/execution/{session_id}/stream
```

**响应**: SSE (Server-Sent Events)

```
event: step
data: {"type": "thought", "content": "正在分析任务...", "timestamp": 1708201200000}

event: step
data: {"type": "action", "tool": "list_directory", "params": {"path": "/Users/xxx/Downloads"}, "timestamp": 1708201201000}

event: step
data: {"type": "observation", "result": "15个文件", "timestamp": 1708201202000}

event: complete
data: {"type": "final", "content": "任务完成", "timestamp": 1708201205000}
```

**事件类型**:
| 类型 | 说明 |
|------|------|
| thought | AI思考过程 |
| action | 工具调用 |
| observation | 工具执行结果 |
| error | 执行错误 |
| final | 最终结果 |
| complete | 流结束 |

---

## 7. TypeScript类型定义

```typescript
// types/api.ts

// 配置
export interface Config {
  ai_provider: 'zhipuai' | 'opencode';
  ai_model: string;
  api_key_configured: boolean;
  theme: 'light' | 'dark';
  language: string;
}

// 会话
export interface Session {
  id: string;
  title: string;
  created_at: string;
  updated_at: string;
  message_count: number;
}

// 消息
export interface Message {
  id: number;
  session_id: string;
  role: 'user' | 'assistant' | 'system';
  content: string;
  timestamp: string;
  execution_steps?: ExecutionStep[];
}

// 执行步骤
export interface ExecutionStep {
  type: 'thought' | 'action' | 'observation' | 'error' | 'final';
  content?: string;
  tool?: string;
  params?: Record<string, any>;
  result?: any;
  timestamp: number;
}

// 安全检查
export interface SecurityCheck {
  safe: boolean;
  risk: string;
  suggestion: string;
}

// 对话消息
export interface ChatMessage {
  role: 'system' | 'user' | 'assistant';
  content: string;
}

// 对话请求
export interface ChatRequest {
  messages: ChatMessage[];
  stream?: boolean;
  temperature?: number;
}

// 对话响应
export interface ChatResponse {
  success: boolean;
  content: string;
  model: string;
  error?: string;
}

// 验证响应
export interface ValidateResponse {
  success: boolean;
  provider: string;
  model: string;
  message: string;
}

// 健康状态
export interface HealthStatus {
  status: string;
  timestamp: string;
  version: string;
}

// 回显响应
export interface EchoResponse {
  received: string;
  timestamp: string;
}
```

---

## 8. Mock数据

### 8.1 会话列表Mock
```typescript
export const mockSessions: Session[] = [
  {
    id: '550e8400-e29b-41d4-a716-446655440000',
    title: '整理下载文件夹',
    created_at: '2026-02-17T10:00:00Z',
    updated_at: '2026-02-17T11:30:00Z',
    message_count: 15
  },
  {
    id: '550e8400-e29b-41d4-a716-446655440001',
    title: '截图当前窗口',
    created_at: '2026-02-16T15:00:00Z',
    updated_at: '2026-02-16T15:05:00Z',
    message_count: 8
  }
];
```

### 8.2 执行步骤Mock
```typescript
export const mockExecutionSteps: ExecutionStep[] = [
  {
    type: 'thought',
    content: '我需要先查看下载文件夹的内容',
    timestamp: Date.now()
  },
  {
    type: 'action',
    tool: 'list_directory',
    params: { path: '/Users/xxx/Downloads' },
    timestamp: Date.now() + 1000
  },
  {
    type: 'observation',
    result: '15个文件（5个压缩包、8个文档、2个安装包）',
    timestamp: Date.now() + 2000
  },
  {
    type: 'thought',
    content: '我应该创建3个文件夹来分类存放',
    timestamp: Date.now() + 3000
  },
  {
    type: 'action',
    tool: 'create_directory',
    params: { names: ['压缩包', '文档', '安装包'] },
    timestamp: Date.now() + 4000
  },
  {
    type: 'final',
    content: '已创建3个文件夹，请确认是否移动文件',
    timestamp: Date.now() + 5000
  }
];
```

---

**文档状态**: 已更新（补充完整）
**后端开发人员**: 小沈
**前端开发人员**: 小新

---

## 9. 后端开发接口分配清单

### 9.1 小沈已实现的接口（10个）

根据后端代码实际实现情况，小沈已完成以下接口：

**配置管理接口**（3个）：
- 1.1 获取配置
- 1.2 更新配置
- 1.3 验证配置

**会话管理接口**（4个）：
- 2.1 创建会话
- 2.2 获取会话列表
- 2.3 获取会话消息
- 2.4 删除会话

**对话接口**（3个）：
- 4.1 发送消息
- 4.2 验证AI服务
- 4.3 切换AI提供商

### 9.2 契约中定义但未实现的接口（4个）

以下接口在契约文档中定义，但后端代码尚未实现：

**安全接口**（1个）：
- 3.1 检查命令安全性

**健康检查接口**（2个）：
- 5.1 服务健康检查
- 5.2 回显测试

**流式执行过程接口**（1个）：
- 6.1 获取执行过程（流式）

### 9.3 接口分配与实现状态总表

| 接口 | 章节 | 分配给小沈 | 实际状态 | 说明 |
|------|------|-----------|---------|------|
| **配置管理（3个）** | | | | |
| 获取配置 | 1.1 | ✅ 是 | ✅ 已实现 | 小沈负责开发 |
| 更新配置 | 1.2 | ✅ 是 | ✅ 已实现 | 小沈负责开发 |
| 验证配置 | 1.3 | ✅ 是 | ✅ 已实现 | 小沈负责开发 |
| **会话管理（4个）** | | | | |
| 创建会话 | 2.1 | ✅ 是 | ✅ 已实现 | 小沈负责开发 |
| 获取会话列表 | 2.2 | ✅ 是 | ✅ 已实现 | 小沈负责开发 |
| 获取会话消息 | 2.3 | ✅ 是 | ✅ 已实现 | 小沈负责开发 |
| 删除会话 | 2.4 | ✅ 是 | ✅ 已实现 | 小沈负责开发 |
| **安全接口（1个）** | | | | |
| 检查命令安全性 | 3.1 | ❌ 否 | ❌ 未实现 | **需小沈补开发** |
| **对话接口（3个）** | | | | |
| 发送消息 | 4.1 | ❌ 否 | ✅ 已存在 | 阶段2.1之前已存在 |
| 验证AI服务 | 4.2 | ❌ 否 | ✅ 已存在 | 阶段2.1之前已存在 |
| 切换AI提供商 | 4.3 | ❌ 否 | ✅ 已存在 | 阶段2.1之前已存在 |
| **健康检查（2个）** | | | | |
| 服务健康检查 | 5.1 | ❌ 否 | ❌ 未实现 | **需小沈补开发** |
| 回显测试 | 5.2 | ❌ 否 | ❌ 未实现 | **需小沈补开发** |
| **流式执行（1个）** | | | | |
| 获取执行过程（流式） | 6.1 | ❌ 否 | ❌ 未实现 | **需小沈补开发** |

**统计**: 小沈分配7个接口，全部完成（100%）；契约定义14个接口，10个已实现/已存在

---

**文档最终更新时间**: 2026-02-18 10:00:00
**核查人员**: 小新（对比后端代码验证）

---

## 10. 后端接口修改方案

### 10.1 方案概述

**方案1：后端修改（推荐）** ✅

由小沈修改后端代码，使其完全符合本契约文档的定义。

**优点**：
- 保证前后端契约一致性，避免技术债
- 前端无需临时适配，减少重复工作量
- 后续维护清晰，接口文档即实际实现

**预计工作量**：约30分钟

---

### 10.2 问题清单总表

| 序号 | 接口 | 问题类型 | 优先级 | 当前实现 | 契约要求 | 修改难度 |
|------|------|---------|--------|---------|---------|---------|
| 1 | 1.2 更新配置 | 请求字段名错误 | P0 | `api_key` | `zhipu_api_key`/`opencode_api_key` | 低 |
| 2 | 2.1 创建会话 | 响应字段名错误 | P0 | `id` | `session_id` | 低 |
| 3 | 1.3 验证配置 | 响应字段缺失 | P1 | 无 `model` | 需返回 `model` | 低 |

---

### 10.3 问题详情与修改方案

#### 问题1：1.2 更新配置 - API Key字段名错误 【P0级】

**差异对比表**：

| 对比项 | 当前小沈实现 | 契约要求 | 状态 |
|--------|-------------|---------|------|
| **智谱AI字段** | `api_key` | `zhipu_api_key` | ❌ 不一致 |
| **OpenCode字段** | `api_key` | `opencode_api_key` | ❌ 不一致 |
| **字段逻辑** | 统一字段 | 按provider区分 | ❌ 不匹配 |

**请求体对比表**：

| 场景 | 当前实现（错误） | 契约要求（正确） |
|------|-----------------|-----------------|
| **智谱AI** | `{ "ai_provider": "zhipuai", "api_key": "sk-xxx" }` | `{ "ai_provider": "zhipuai", "zhipu_api_key": "sk-xxx" }` |
| **OpenCode** | `{ "ai_provider": "opencode", "api_key": "sk-yyy" }` | `{ "ai_provider": "opencode", "opencode_api_key": "sk-yyy" }` |

**修改要求表**：

| 修改项 | 修改内容 | 文件路径 |
|--------|---------|---------|
| 模型字段 | `api_key: str` → `zhipu_api_key: Optional[str]` | `backend/app/schemas/config.py` |
| 模型字段 | 新增 `opencode_api_key: Optional[str]` | `backend/app/schemas/config.py` |
| 业务逻辑 | 根据`ai_provider`读取对应字段 | `backend/app/api/v1/config.py` |
| 验证逻辑 | 确保对应provider的API Key不为空 | `backend/app/api/v1/config.py` |

**参考代码**：
```python
# backend/app/schemas/config.py
class ConfigUpdate(BaseModel):
    ai_provider: Optional[str] = None
    zhipu_api_key: Optional[str] = None      # ✅ 字段名1
    opencode_api_key: Optional[str] = None   # ✅ 字段名2
    theme: Optional[str] = None
    language: Optional[str] = None
```

---

#### 问题2：2.1 创建会话 - 返回字段名错误 【P0级】

**差异对比表**：

| 对比项 | 当前小沈实现 | 契约要求 | 状态 |
|--------|-------------|---------|------|
| **会话ID字段** | `id` | `session_id` | ❌ 不一致 |

**响应体对比表**：

| 场景 | 当前实现（错误） | 契约要求（正确） |
|------|-----------------|-----------------|
| **创建会话** | `{ "id": "uuid", "title": "..." }` | `{ "session_id": "uuid", "title": "..." }` |

**修改要求表**：

| 修改项 | 修改内容 | 文件路径 |
|--------|---------|---------|
| 响应字段 | `id: str` → `session_id: str` | `backend/app/schemas/session.py` |
| 路由返回 | 确保返回字段名为`session_id` | `backend/app/api/v1/sessions.py` |

**参考代码**：
```python
# backend/app/schemas/session.py
class SessionResponse(BaseModel):
    session_id: str  # ✅ 字段名从 id 改为 session_id
    title: str
    created_at: datetime
```

---

#### 问题3：1.3 验证配置 - 缺少model字段 【P1级】

**差异对比表**：

| 对比项 | 当前小沈实现 | 契约要求 | 状态 |
|--------|-------------|---------|------|
| **模型字段** | 缺失 | `model: string` | ❌ 缺失 |

**响应体对比表**：

| 场景 | 当前实现（错误） | 契约要求（正确） |
|------|-----------------|-----------------|
| **验证成功** | `{ "valid": true, "message": "..." }` | `{ "valid": true, "message": "...", "model": "glm-4.7-flash" }` |
| **验证失败** | `{ "valid": false, "message": "..." }` | `{ "valid": false, "message": "...", "model": null }` |

**修改要求表**：

| 修改项 | 修改内容 | 文件路径 |
|--------|---------|---------|
| 响应字段 | 新增 `model: Optional[str]` | `backend/app/schemas/config.py` |
| 业务逻辑 | 验证成功时返回当前模型名 | `backend/app/api/v1/config.py` |
| 业务逻辑 | 验证失败时返回null或空字符串 | `backend/app/api/v1/config.py` |

**参考代码**：
```python
# backend/app/schemas/config.py
class ConfigValidateResponse(BaseModel):
    valid: bool
    message: str
    model: Optional[str] = None  # ✅ 新增字段
```

---

### 10.4 缺失接口清单

以下接口在契约中已定义，但后端尚未实现：

| 序号 | 接口名称 | 接口路径 | 章节 | 优先级 | 状态 |
|------|---------|---------|------|--------|------|
| 1 | 检查命令安全性 | `POST /api/v1/security/check` | 3.1 | P2 | ❌ 未实现 |
| 2 | 服务健康检查 | `GET /api/v1/health` | 5.1 | P2 | ❌ 未实现 |
| 3 | 回显测试 | `POST /api/v1/echo` | 5.2 | P3 | ❌ 未实现 |
| 4 | 获取执行过程（流式） | `GET /api/v1/chat/execution/{session_id}/stream` | 6.1 | P1 | ❌ 未实现 |

**实现要求**：
- 严格按照契约文档第3、5、6章节的请求/响应格式实现
- 接口路径必须完全一致（包括前缀 `/api/v1`）

---

### 10.5 修改验证清单

小沈完成修改后，请按以下清单验证：

| 验证项 | 验证方法 | 通过标准 |
|--------|---------|---------|
| 问题1 | 调用`PUT /api/v1/config` | 能正确接收`zhipu_api_key`和`opencode_api_key` |
| 问题2 | 调用`POST /api/v1/sessions` | 返回字段名为`session_id`（不是`id`） |
| 问题3 | 调用`POST /api/v1/config/validate` | 响应包含`model`字段 |
| 缺失接口 | 调用4个缺失接口 | 返回200状态码，格式符合契约 |
| 回归测试 | 调用已实现的7个接口 | 仍能正常工作，无报错 |

---

**方案说明追加时间**: 2026-02-18 10:15:00
**追加人员**: 小新

---

## 11. 契约设计与实现问题说明

### 11.1 问题清单

根据小沈的对比分析（`doc/API契约与实现对比分析.md`），确认以下设计问题及处理方案：

| 序号 | 问题描述 | 涉及接口 | 处理方案 | 确认人 |
|------|---------|---------|---------|--------|
| 1 | 创建会话响应字段不完整 | 2.1 创建会话 | **修改契约**：增加 `updated_at` 和 `message_count` | ✅ 用户确认 |
| 2 | 健康检查版本号硬编码 | 5.1 服务健康检查 | **修改契约**：改为动态读取 `version.txt` | ✅ 用户确认 |
| 3 | 会话列表格式确认 | 2.2 获取会话列表 | **确认对象格式**：包含 `total`、`page` 等信息 | ✅ 用户确认 |
| 4 | execution_steps格式确认 | 2.3 获取会话消息 | **确认数组格式**：后端需转换为数组返回 | ✅ 用户确认 |

### 11.2 问题处理原因说明

#### 问题1：创建会话响应增加字段

**问题描述**：
契约原文档只定义了 `session_id`、`title`、`created_at` 三个字段，但小沈的实现返回了 `updated_at` 和 `message_count`。

**处理方案**：**修改契约，采用更完整的方案**

**原因**：
| 考虑因素 | 说明 |
|---------|------|
| **功能完整性** | `updated_at` 和 `message_count` 是会话管理的基本信息，前端列表展示需要这些数据 |
| **前端便利性** | 创建会话后立即返回完整信息，前端无需再调用获取会话列表接口刷新 |
| **数据一致性** | 新建会话的 `updated_at` 与 `created_at` 相同，`message_count` 为0，逻辑清晰 |
| **扩展性** | 预留字段为后续功能扩展（如会话排序、统计）提供基础 |

**结论**：采用小沈的实现方案，契约文档补充这两个字段。

---

#### 问题2：健康检查版本号动态读取

**问题描述**：
契约原文档硬编码版本号为 `"2.1.0"`，但小沈的实现从 `version.txt` 动态读取（如 `"0.2.3"`）。

**处理方案**：**修改契约，采用动态读取方案**

**原因**：
| 考虑因素 | 说明 |
|---------|------|
| **开发阶段需求** | 当前处于活跃开发期，版本迭代频繁，每次修改代码都要同步改契约容易遗漏 |
| **一致性保障** | 动态读取确保接口返回的版本号始终与实际代码版本一致 |
| **维护成本** | 减少人工维护成本，避免文档与实际不符 |
| **长期规划** | 后续正式版本可再评估是否需要固定版本号 |

**结论**：采用动态读取方案，契约文档明确说明版本号来源。

---

#### 问题3：会话列表对象格式

**问题描述**：
契约原文档已定义为对象格式 `{total, page, page_size, sessions: []}`，需确认是否保持此设计。

**处理方案**：**确认采用对象格式**

**原因**：
| 对比项 | 对象格式 | 数组格式 |
|--------|---------|---------|
| **当前适用性** | 支持分页元数据 | 简单直接 |
| **未来扩展性** | ⭐⭐⭐ 可添加统计字段（total_count、unread_count等） | ⭐ 无法附加元数据 |
| **前端组件兼容性** | 分页组件通常需要total字段 | 需要额外计算 |
| **API一致性** | RESTful API常见设计 | 简单场景使用 |

**结论**：采用对象格式，即使当前不分页，也为未来预留扩展空间。

---

#### 问题4：execution_steps数组格式

**问题描述**：
契约原文档已定义为数组格式，但小沈的实现存储为JSON字符串，需确认传输格式。

**处理方案**：**确认采用数组格式，后端负责转换**

**原因**：
| 考虑因素 | 说明 |
|---------|------|
| **前端便利性** | 数组格式前端可直接使用，无需 `JSON.parse()` 转换 |
| **数据库存储** | JSON字符串存储是合理的（数据库优化），但在API层应转换为结构化数据 |
| **类型安全** | 数组格式支持TypeScript类型检查，字符串无法检查 |
| **标准实践** | RESTful API通常返回结构化数据，而非序列化字符串 |

**结论**：契约保持数组格式，后端在返回响应前将JSON字符串转换为数组。

### 11.3 契约修改原则

**本次修改遵循以下原则**：

| 原则 | 说明 |
|------|------|
| **1. 用户确认原则** | 所有契约修改必须经用户确认，不得擅自修改 |
| **2. 实事求是原则** | 契约应与实际实现保持一致，避免文档与代码脱节 |
| **3. 向前兼容原则** | 新增字段不得破坏现有功能，保持接口稳定性 |
| **4. 实用优先原则** | 优先采用更完整、更灵活的方案，而非简单方案 |
| **5. 文档同步原则** | 修改后同步更新版本历史，记录变更原因 |

### 11.4 版本变更说明

本次修订将文档版本从 **v1.1** 升级到 **v1.2**，变更内容包括：

1. ✅ **2.1 创建会话**：响应增加 `updated_at` 和 `message_count` 字段
2. ✅ **5.1 服务健康检查**：明确版本号动态读取，更新示例值为 `0.2.3`
3. ✅ **2.3 获取会话消息**：明确 `execution_steps` 为数组格式，添加字段说明
4. ✅ **2.2 获取会话列表**：确认对象格式，保持原有设计

---

**第11章追加时间**: 2026-02-18 11:00:00
**追加人员**: 小新
**确认人员**: 用户（方案确认）
**修改负责人**: 小沈（后端开发）
