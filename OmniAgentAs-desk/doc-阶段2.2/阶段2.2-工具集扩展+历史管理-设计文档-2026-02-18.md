# 阶段2.2：工具集扩展+历史管理 - 设计文档

**文档编号**: OMA-DESIGN-2.2-TOOLS  
**版本**: v1.0  
**创建时间**: 2026-02-18 17:46:08  
**阶段状态**: ⏸️待启动  
**前置依赖**: 阶段2.1 Web对话界面+配置+安全（已完成）

---

> **设计说明**：
> 本阶段在阶段2.1的基础上，扩展工具集能力（P1/P2级工具）和实现对话历史管理。
> 设计遵循阶段2.1确立的技术栈和架构风格，保持前后端一致性。

---

## 1. 设计目标

### 1.1 核心目标
在阶段2.1基础上，扩展AI助手的工具能力和历史管理功能：

1. **工具集扩展**：实现P1级系统工具（窗口管理、截图、shell执行）和P2级辅助工具（剪贴板、系统信息）
2. **历史管理**：实现对话历史的持久化存储、查询和恢复
3. **用户体验**：支持多会话管理，提升长期使用价值

### 1.2 设计原则

- **能力增强**：在现有文件操作基础上，增加系统级操作能力
- **安全第一**：所有系统工具必须经过严格的安全校验
- **数据持久**：对话历史和系统配置持久化到SQLite数据库
- **向后兼容**：新功能不影响阶段2.1已实现的对话功能

---

## 2. 功能需求

### 2.1 P1级工具集（高优先级）

#### 2.1.1 窗口管理工具

**功能说明**：管理系统窗口，支持窗口切换和信息获取

**工具列表**：

| 工具名 | 功能 | 参数 | 返回值 | 安全级别 |
|--------|------|------|--------|----------|
| `list_windows` | 列出所有窗口 | - | 窗口列表（标题、PID、句柄） | 低 |
| `get_active_window` | 获取当前活动窗口 | - | 窗口信息（标题、应用名） | 低 |
| `switch_window` | 切换到指定窗口 | window_id | 成功/失败 | 中 |
| `close_window` | 关闭指定窗口 | window_id, force | 成功/失败 | **高** |

**实现限制**：
- Windows平台使用Win32 API（pywin32）
- macOS平台使用AppleScript/AppKit
- Linux平台使用xdotool
- Web版仅提供信息展示，实际操作用桌面版

**安全机制**：
- 关闭窗口需二次确认
- 禁止关闭系统关键窗口（任务管理器、桌面等）

#### 2.1.2 截图工具

**功能说明**：屏幕截图功能，支持全屏、窗口、区域截图

**工具列表**：

| 工具名 | 功能 | 参数 | 返回值 | 格式 |
|--------|------|------|--------|------|
| `screenshot_full` | 全屏截图 | - | 图片路径 | PNG |
| `screenshot_window` | 窗口截图 | window_id | 图片路径 | PNG |
| `screenshot_region` | 区域截图 | x, y, width, height | 图片路径 | PNG |

**实现方案**：
- 使用Pillow/PIL库实现截图
- 图片保存到临时目录，返回路径
- Web版通过前端实现（html2canvas）

#### 2.1.3 Shell命令执行（受限）

**功能说明**：执行安全的shell命令，支持文件和系统查询

**工具名**：`run_shell`

**参数**：
```typescript
{
  command: string;    // 命令字符串
  timeout?: number;   // 超时时间（秒），默认30s
  cwd?: string;       // 工作目录
}
```

**返回值**：
```typescript
{
  success: boolean;
  stdout: string;
  stderr: string;
  exit_code: number;
  execution_time: number;
}
```

**安全限制（已在阶段2.1实现基础上扩展）**：
- ✅ 黑名单机制（rm -rf、format、mkfs等）
- ✅ 白名单机制（可配置允许执行的命令）
- ✅ 危险操作确认（删除、修改系统文件）
- ✅ 超时控制（防止长时间阻塞）
- ✅ 输出长度限制（防止返回过多数据）

**允许命令示例**：
```bash
# 文件查询
ls -la
dir
find . -name "*.py"

# 系统查询
pwd
whoami
date
env | grep PATH

# 网络查询
ping -c 4 google.com
curl -I https://api.example.com

# Git操作（只读）
git status
git log --oneline -10
git diff --stat
```

#### 2.1.4 文件操作增强

**新增工具**：

| 工具名 | 功能 | 说明 |
|--------|------|------|
| `create_directory` | 创建文件夹 | 支持多级目录 |
| `copy_file` | 复制文件 | 支持大文件分块 |
| `get_file_info` | 获取文件信息 | 大小、修改时间、权限等 |
| `compress_files` | 压缩文件 | ZIP格式 |
| `decompress_file` | 解压文件 | ZIP格式 |

### 2.2 P2级工具集（可选/增强）

#### 2.2.1 剪贴板工具

**工具列表**：

| 工具名 | 功能 | 说明 |
|--------|------|------|
| `clipboard_read` | 读取剪贴板 | 文本内容 |
| `clipboard_write` | 写入剪贴板 | 文本内容 |
| `clipboard_clear` | 清空剪贴板 | - |

**限制**：
- Web版不支持（浏览器安全限制）
- 桌面版使用pyperclip库

#### 2.2.2 系统信息工具

**工具列表**：

| 工具名 | 功能 | 返回值 |
|--------|------|--------|
| `get_system_info` | 系统基本信息 | OS、版本、架构 |
| `get_cpu_info` | CPU信息 | 型号、核心数、使用率 |
| `get_memory_info` | 内存信息 | 总量、可用、使用率 |
| `get_disk_info` | 磁盘信息 | 各分区使用情况 |
| `get_network_info` | 网络信息 | IP、网卡、连接状态 |

**实现**：使用psutil库

#### 2.2.3 进程管理工具

**工具列表**：

| 工具名 | 功能 | 安全级别 |
|--------|------|----------|
| `list_processes` | 列出进程 | 低 |
| `get_process_info` | 获取进程详情 | 低 |
| `kill_process` | 结束进程 | **高** |

**安全限制**：
- 禁止结束系统关键进程
- 危险进程结束需二次确认

### 2.3 对话历史管理

#### 2.3.1 需求说明

实现对话历史的持久化存储，支持：
- 多会话管理（创建、删除、切换）
- 历史消息存储和查询
- 会话元数据（标题、时间、消息数）
- 会话恢复（断点续聊）

#### 2.3.2 数据库设计

**表结构**：

```sql
-- 会话表
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,           -- UUID
    title TEXT NOT NULL,           -- 会话标题
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    message_count INTEGER DEFAULT 0,
    is_archived BOOLEAN DEFAULT FALSE,
    metadata JSON                  -- 扩展字段
);

-- 消息表
CREATE TABLE messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK(role IN ('user', 'assistant', 'system')),
    content TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    execution_steps JSON,          -- ReAct执行步骤（AI消息）
    metadata JSON,                 -- 扩展字段（token数、模型等）
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX idx_messages_session ON messages(session_id, timestamp);
CREATE INDEX idx_sessions_updated ON sessions(updated_at DESC);
```

#### 2.3.3 功能清单

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 创建会话 | 新建对话会话 | P0 |
| 获取会话列表 | 分页查询会话 | P0 |
| 获取会话消息 | 查询某会话的所有消息 | P0 |
| 删除会话 | 软删除/硬删除 | P0 |
| 更新会话标题 | 修改会话标题 | P1 |
| 归档会话 | 归档不常用的会话 | P2 |
| 搜索会话 | 按关键词搜索 | P2 |
| 会话恢复 | 从某条消息继续对话 | P2 |

---

## 3. 技术方案

### 3.1 后端技术方案

#### 3.1.1 数据库选型

**选择SQLite**：
- ✅ 零配置，无需独立服务
- ✅ 单文件存储，便于备份和迁移
- ✅ Python原生支持（sqlite3）
- ✅ 足够支撑个人级应用

**数据库文件位置**：
```
OmniAgentAs-desk/
├── data/
│   └── sessions.db    # SQLite数据库文件
```

#### 3.1.2 工具服务架构

```
backend/app/services/
├── tools/                    # 工具服务目录
│   ├── __init__.py
│   ├── base.py              # 工具基类
│   ├── file_tools.py        # 文件操作工具（P0，已存在）
│   ├── window_tools.py      # 窗口管理工具（P1，新增）
│   ├── screenshot_tools.py  # 截图工具（P1，新增）
│   ├── shell_tools.py       # Shell工具（P1，扩展）
│   ├── system_tools.py      # 系统信息工具（P2，新增）
│   ├── clipboard_tools.py   # 剪贴板工具（P2，新增）
│   └── process_tools.py     # 进程管理工具（P2，新增）
├── database/                 # 数据库服务
│   ├── __init__.py
│   ├── connection.py        # 数据库连接管理
│   ├── session_repository.py # 会话数据访问
│   └── message_repository.py # 消息数据访问
└── ...
```

#### 3.1.3 工具基类设计

```python
from abc import ABC, abstractmethod
from typing import Any, Dict, Optional
from pydantic import BaseModel

class ToolParameters(BaseModel):
    """工具参数基类"""
    pass

class ToolResult(BaseModel):
    """工具结果基类"""
    success: bool
    message: str
    data: Optional[Dict[str, Any]] = None

class BaseTool(ABC):
    """工具基类"""
    
    name: str
    description: str
    parameters_schema: type[ToolParameters]
    
    # 安全级别
    SAFETY_LOW = "low"      # 只读查询
    SAFETY_MEDIUM = "medium" # 有限修改
    SAFETY_HIGH = "high"     # 系统级操作
    safety_level: str = SAFETY_LOW
    
    @abstractmethod
    async def execute(self, params: ToolParameters) -> ToolResult:
        """执行工具"""
        pass
    
    def validate_params(self, params: dict) -> ToolParameters:
        """参数校验"""
        return self.parameters_schema(**params)
    
    def requires_confirmation(self) -> bool:
        """是否需要二次确认"""
        return self.safety_level in [self.SAFETY_MEDIUM, self.SAFETY_HIGH]
```

#### 3.1.4 API接口设计

**会话管理API**：

```yaml
# 创建会话
POST /api/v1/sessions
Request:
  title: string  # 可选，默认"新会话"
Response:
  session_id: string
  title: string
  created_at: string

# 获取会话列表
GET /api/v1/sessions?page=1&page_size=20
Response:
  total: number
  sessions: [
    {
      id: string
      title: string
      created_at: string
      updated_at: string
      message_count: number
    }
  ]

# 获取会话消息
GET /api/v1/sessions/{session_id}/messages
Response:
  session_id: string
  messages: [
    {
      id: number
      role: "user" | "assistant" | "system"
      content: string
      timestamp: string
      execution_steps: object  # AI消息有此项
    }
  ]

# 删除会话
DELETE /api/v1/sessions/{session_id}
Response:
  success: boolean

# 更新会话标题
PUT /api/v1/sessions/{session_id}
Request:
  title: string
```

**工具执行API**：

```yaml
# 执行工具（扩展现有API）
POST /api/v1/tools/execute
Request:
  tool_name: string
  parameters: object
  require_confirmation: boolean  # 是否已确认
Response:
  success: boolean
  result: object
  need_confirmation: boolean     # 是否需要二次确认
  confirmation_message: string   # 确认提示信息
```

### 3.2 前端技术方案

#### 3.2.1 组件扩展

在阶段2.1基础上，新增/修改组件：

```
frontend/src/
├── components/
│   ├── Chat/
│   │   └── ...（阶段2.1已有）
│   ├── History/                 # 新增：历史会话管理
│   │   ├── SessionList.tsx     # 会话列表
│   │   ├── SessionItem.tsx     # 会话项
│   │   └── SessionSearch.tsx   # 会话搜索
│   ├── Tools/                   # 新增：工具执行展示
│   │   ├── ToolExecution.tsx   # 工具执行面板
│   │   ├── WindowInfo.tsx      # 窗口信息展示
│   │   ├── ScreenshotResult.tsx # 截图结果展示
│   │   └── SystemInfo.tsx      # 系统信息展示
│   └── ...
├── services/
│   └── api.ts                   # 扩展：添加会话API
├── hooks/
│   └── useSessions.ts          # 新增：会话管理Hook
└── types/
    └── session.ts              # 新增：会话类型定义
```

#### 3.2.2 状态管理扩展

**SessionContext**：管理当前会话状态

```typescript
interface SessionContextType {
  // 当前会话
  currentSession: Session | null;
  setCurrentSession: (session: Session | null) => void;
  
  // 会话列表
  sessions: Session[];
  loadingSessions: boolean;
  refreshSessions: () => Promise<void>;
  
  // 消息
  messages: Message[];
  loadingMessages: boolean;
  loadMessages: (sessionId: string) => Promise<void>;
  
  // 操作
  createSession: (title?: string) => Promise<Session>;
  deleteSession: (sessionId: string) => Promise<void>;
  updateSessionTitle: (sessionId: string, title: string) => Promise<void>;
}
```

#### 3.2.3 界面设计

**历史会话侧边栏**：

```
┌─────────────────────────────────────────────────────────┐
│ 📁 文件    💬 历史    ⚙️ 设置                          │
├─────────────────────────────────────────────────────────┤
│ 🔍 搜索会话...                                          │
├─────────────────────────────────────────────────────────┤
│ ➕ 新建会话                                             │
├─────────────────────────────────────────────────────────┤
│ 💬 项目需求分析                          2小时前        │
│ 💬 代码重构方案                          昨天           │
│ 💬 Python学习笔记                        3天前         │
│ ...                                                     │
└─────────────────────────────────────────────────────────┘
```

**工具执行面板**：

```
┌─────────────────────────────────────────────────────────┐
│ 🛠️ 工具执行                                            │
├─────────────────────────────────────────────────────────┤
│ 执行: screenshot_full                                   │
│ 状态: ✅ 成功                                           │
│ 结果:                                                   │
│ ┌─────────────────────────────────────────────────────┐ │
│ │ [截图预览]                                          │ │
│ │ /tmp/screenshot_20240218_174608.png                 │ │
│ └─────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

---

## 4. 数据库详细设计

### 4.1 实体关系图

```
┌──────────────┐       ┌──────────────┐
│   sessions   │ 1   N │   messages   │
├──────────────┤───────┼──────────────┤
│ id (PK)      │       │ id (PK)      │
│ title        │       │ session_id   │
│ created_at   │       │ role         │
│ updated_at   │       │ content      │
│ message_count│       │ timestamp    │
│ is_archived  │       │ execution_   │
│ metadata     │       │   steps      │
└──────────────┘       │ metadata     │
                       └──────────────┘
```

### 4.2 完整SQL Schema

```sql
-- ============================================
-- OmniAgentAst 会话管理数据库 Schema
-- 版本: v1.0
-- 创建时间: 2026-02-18
-- ============================================

-- 会话表
CREATE TABLE IF NOT EXISTS sessions (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL DEFAULT '新会话',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    message_count INTEGER DEFAULT 0,
    is_archived BOOLEAN DEFAULT 0,
    metadata TEXT  -- JSON格式
);

-- 消息表
CREATE TABLE IF NOT EXISTS messages (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT NOT NULL,
    role TEXT NOT NULL CHECK(role IN ('user', 'assistant', 'system')),
    content TEXT NOT NULL,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    execution_steps TEXT,  -- JSON格式，存储ReAct执行步骤
    metadata TEXT,         -- JSON格式
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_messages_session_time 
    ON messages(session_id, timestamp);

CREATE INDEX IF NOT EXISTS idx_sessions_updated 
    ON sessions(updated_at DESC);

-- 触发器：自动更新会话消息数
CREATE TRIGGER IF NOT EXISTS update_message_count
AFTER INSERT ON messages
BEGIN
    UPDATE sessions 
    SET message_count = message_count + 1,
        updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.session_id;
END;

-- 触发器：自动更新会话更新时间
CREATE TRIGGER IF NOT EXISTS update_session_timestamp
AFTER UPDATE ON sessions
BEGIN
    UPDATE sessions 
    SET updated_at = CURRENT_TIMESTAMP
    WHERE id = NEW.id;
END;
```

---

## 5. 验收标准

### 5.1 功能验收

| AC编号 | 验收项 | 验收标准 | 优先级 |
|--------|--------|----------|--------|
| AC001 | 窗口列表获取 | `list_windows`返回当前所有窗口信息 | P1 |
| AC002 | 窗口切换 | `switch_window`成功切换到指定窗口 | P1 |
| AC003 | 截图功能 | `screenshot_full`成功保存截图并返回路径 | P1 |
| AC004 | Shell执行 | `run_shell`执行安全命令并返回结果 | P1 |
| AC005 | Shell安全 | 危险命令被拦截并返回错误 | P1 |
| AC006 | 系统信息 | `get_system_info`返回准确的系统信息 | P2 |
| AC007 | 剪贴板操作 | 桌面版可读写剪贴板内容 | P2 |
| AC008 | 会话创建 | 可创建新会话并返回ID | P0 |
| AC009 | 会话列表 | 可分页获取会话列表 | P0 |
| AC010 | 消息存储 | 对话消息正确存储到数据库 | P0 |
| AC011 | 消息查询 | 可查询会话的所有历史消息 | P0 |
| AC012 | 会话删除 | 可删除会话及其所有消息 | P0 |

### 5.2 性能验收

| 验收项 | 标准 |
|--------|------|
| 会话列表查询 | < 100ms（100个会话） |
| 消息查询 | < 200ms（1000条消息） |
| 截图保存 | < 500ms |
| Shell执行 | < 5s（默认超时30s） |
| 数据库初始化 | < 1s |

### 5.3 安全验收

| 验收项 | 标准 |
|--------|------|
| 危险命令拦截 | 100%拦截黑名单命令 |
| 窗口关闭确认 | 关闭窗口前弹窗确认 |
| 进程结束确认 | 结束进程前弹窗确认 |
| 数据隔离 | 会话数据不泄露 |

---

## 6. 开发计划

### 6.1 任务分解

| 任务 | 负责人 | 估计工时 | 依赖 |
|------|--------|----------|------|
| **后端开发** | | | |
| 1. 数据库模块 | 小沈 | 4h | - |
| 2. 窗口管理工具 | 小沈 | 6h | - |
| 3. 截图工具 | 小沈 | 4h | - |
| 4. Shell工具增强 | 小沈 | 3h | 阶段2.1基础 |
| 5. 系统信息工具 | 小沈 | 4h | - |
| 6. 会话管理API | 小沈 | 6h | 数据库模块 |
| 7. 剪贴板工具 | 小沈 | 2h | - |
| 8. 进程管理工具 | 小沈 | 3h | - |
| **前端开发** | | | |
| 9. 会话管理组件 | 小新 | 6h | API就绪 |
| 10. 历史会话界面 | 小新 | 4h | 会话组件 |
| 11. 工具执行展示 | 小新 | 4h | - |
| 12. 系统集成 | 小新 | 4h | 全部完成 |
| **测试** | | | |
| 13. 单元测试 | 小沈/小新 | 6h | - |
| 14. 集成测试 | 联调 | 4h | - |
| **总计** | | **60h** | |

### 6.2 里程碑

| 里程碑 | 时间 | 交付物 |
|--------|------|--------|
| M1 | 第2天 | 数据库模块+会话API完成 |
| M2 | 第4天 | P1级工具全部完成 |
| M3 | 第6天 | 前端历史管理界面完成 |
| M4 | 第7天 | P2级工具完成 |
| M5 | 第8天 | 集成测试完成 |

---

## 7. 风险分析

### 7.1 技术风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| 跨平台窗口管理差异大 | 中 | 高 | 优先实现Windows，其他平台后续支持 |
| 截图权限问题 | 中 | 中 | 添加权限申请和错误处理 |
| SQLite并发性能 | 低 | 中 | 单用户使用场景，足够支撑 |
| Web版功能受限 | 高 | 低 | 文档说明Web版限制 |

### 7.2 安全风险

| 风险 | 概率 | 影响 | 缓解措施 |
|------|------|------|----------|
| Shell命令注入 | 低 | 高 | 黑名单+白名单双重验证 |
| 进程误杀 | 低 | 高 | 系统进程保护+二次确认 |
| 敏感信息截图 | 低 | 中 | 用户授权机制 |

---

## 8. 依赖和约束

### 8.1 前置依赖

- ✅ 阶段2.1 Web对话界面（已完成）
- ✅ 阶段2.1 配置管理（已完成）
- ✅ 阶段2.1 安全框架（已完成）

### 8.2 技术约束

- **后端**：Python 3.11+, FastAPI, SQLite
- **前端**：React 18, TypeScript, Ant Design 5
- **平台**：Windows优先，支持macOS/Linux

### 8.3 新增依赖

```python
# requirements.txt 新增
pywin32>=306; platform_system=="Windows"  # Windows API
pyperclip>=1.8.2                          # 剪贴板
psutil>=5.9.0                             # 系统信息
Pillow>=10.0.0                            # 截图
```

---

## 9. 附录

### 9.1 参考文档

- [阶段2.1设计文档](doc/阶段2.1-Web版设计文档-2026-02-17.md)
- [开发优先级计划](doc/桌面omni开发优先级计划.md)
- [阶段跟踪表](doc/桌面omni阶段跟踪表.md)

### 9.2 术语表

| 术语 | 说明 |
|------|------|
| P0工具 | 核心文件操作工具（阶段1.3） |
| P1工具 | 系统级工具（窗口、截图、Shell） |
| P2工具 | 辅助工具（剪贴板、系统信息） |
| ReAct | 思考-行动-观察循环模式 |
| Win32 API | Windows系统编程接口 |

---

**文档编写人**: 小沈  
**审核人**: 北京老陈  
**版本历史**:
| 版本 | 日期 | 更新内容 | 作者 |
|------|------|---------|------|
| v1.0 | 2026-02-18 17:46:08 | 初始版本 | 小沈 |
