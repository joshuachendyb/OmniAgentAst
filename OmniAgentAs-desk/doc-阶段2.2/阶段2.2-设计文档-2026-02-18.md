# 阶段2.2：工具集扩展+历史管理 - 设计文档

**文档编号**: OMA-DESIGN-2.2-TOOLS  
**版本**: v1.0  
**创建时间**: 2026-02-18 18:22:33  
**阶段状态**: ⏸️待启动  

---

## 1. 设计目标

### 1.1 核心目标

实现P1/P2级工具集扩展和对话历史管理功能，增强AI Agent的系统控制能力和用户交互体验。

**设计原则**：
- **工具完整性**：覆盖窗口管理、截图、Shell命令、剪贴板、系统信息等常见场景
- **安全优先**：危险操作需要用户确认，Shell命令受限执行
- **渐进增强**：P1级工具优先实现，P2级工具作为可选扩展
- **用户体验**：工具调用结果友好展示，支持历史会话快速切换

### 1.2 与阶段2.1的关系

阶段2.2是阶段2.1的延续：
- 阶段2.1：Web对话界面 + 配置管理 + 安全增强 + 后端会话管理
- 阶段2.2：工具集扩展 + 前端历史管理集成

### 1.3 验收策略

1. 先实现P1级工具（6个），通过验收后再扩展P2级
2. 工具实现后立即测试，确保每个工具可独立运行
3. 历史管理前端集成与后端API对接验证

---

## 2. P1级工具设计

### 2.1 工具列表

| 工具名 | 功能 | 场景 | 优先级 |
|--------|------|------|--------|
| `list_windows` | 列出所有窗口 | 窗口管理 | P1 |
| `switch_window` | 切换到指定窗口 | 窗口管理 | P1 |
| `screenshot` | 截图当前屏幕/窗口 | 系统控制 | P1 |
| `run_shell` | 执行shell命令（受限） | 系统控制 | P1 |
| `create_directory` | 创建文件夹 | 文件管理 | P1 |
| `delete_file` | 删除文件（需确认） | 文件管理 | P1 |

### 2.2 窗口管理工具

#### list_windows（列出窗口）

**功能**：获取当前桌面上所有窗口的列表信息

**输入参数**：
```python
{
    "include_minimized": bool = False  # 是否包含最小化窗口
}
```

**输出结果**：
```python
{
    "windows": [
        {
            "handle": "窗口句柄",
            "title": "窗口标题",
            "process_name": "进程名",
            "is_visible": true/false,
            "is_focused": true/false
        }
    ],
    "count": 窗口数量
}
```

**实现方案**：
- 使用Python的`pygetwindow`库或`win32gui`
- 返回窗口句柄、标题、进程名、可见状态

#### switch_window（切换窗口）

**功能**：将焦点切换到指定窗口

**输入参数**：
```python
{
    "handle": "窗口句柄" | "窗口标题(部分匹配)"
}
```

**输出结果**：
```python
{
    "success": true/false,
    "message": "切换结果描述"
}
```

**实现方案**：
- 使用`win32gui.SetForegroundWindow`
- 支持句柄精确切换和标题模糊匹配

### 2.3 截图工具

#### screenshot（屏幕截图）

**功能**：截取当前屏幕或指定窗口的内容

**输入参数**：
```python
{
    "mode": "screen" | "window",  # 截图模式
    "handle": "窗口句柄(可选)",   # window模式时指定
    "save_path": "保存路径",      # 可选，默认临时目录
    "format": "png" | "jpg"      # 截图格式
}
```

**输出结果**：
```python
{
    "success": true/false,
    "file_path": "保存的文件路径",
    "size": "文件大小",
    "message": "截图结果描述"
}
```

**实现方案**：
- 使用`PIL(Pillow)`库进行截图
- 使用`mss`库作为备选方案
- 保存到指定路径或返回Base64

### 2.4 Shell工具

#### run_shell（执行Shell命令）

**功能**：在受限环境下执行Shell命令

**输入参数**：
```python
{
    "command": "命令内容",
    "timeout": 30  # 超时时间(秒)
}
```

**输出结果**：
```python
{
    "success": true/false,
    "stdout": "标准输出",
    "stderr": "错误输出",
    "return_code": 0,
    "execution_time": "执行时间(秒)"
}
```

**安全机制**：
- **黑名单拦截**：禁止执行危险命令（rm -rf, mkfs, del /s等）
- **路径限制**：禁止访问系统敏感目录
- **命令白名单**：只允许执行特定类型的命令（dir, type, echo等）
- **超时限制**：防止命令挂起

**黑名单示例**：
```python
SHELL_BLACKLIST = [
    r"rm\s+-rf",
    r"del\s+/[sq]",
    r"mkfs",
    r"format\s+[a-z]:",
    r"shutdown",
    r"reboot",
    r"powershell.*-enc",
]
```

### 2.5 文件管理增强工具

#### create_directory（创建目录）

**功能**：创建新目录/文件夹

**输入参数**：
```python
{
    "path": "目录路径",
    "parents": false  # 是否创建父目录
}
```

**输出结果**：
```python
{
    "success": true/false,
    "path": "创建的目录路径",
    "message": "操作结果描述"
}
```

**说明**：此工具在阶段1.3已有基础实现，阶段2.2进行功能增强（支持递归创建）

#### delete_file（删除文件）

**功能**：删除指定文件或目录

**输入参数**：
```python
{
    "path": "文件/目录路径",
    "permanent": false  # false=移至回收站, true=永久删除
}
```

**输出结果**：
```python
{
    "success": true/false,
    "original_path": "原路径",
    "deleted_to": "回收站路径或已删除",
    "message": "操作结果描述"
}
```

**安全机制**：
- 默认移至回收站（可恢复）
- 永久删除需要`permanent: true`
- 大文件删除前提示用户
- 与阶段2.1的DangerConfirmModal组件集成

---

## 3. P2级工具设计

### 3.1 工具列表

| 工具名 | 功能 | 场景 | 优先级 |
|--------|------|------|--------|
| `clipboard_read` | 读取剪贴板 | 剪贴板管理 | P2 |
| `clipboard_write` | 写入剪贴板 | 剪贴板管理 | P2 |
| `get_system_info` | 获取系统信息 | 系统监控 | P2 |

### 3.2 剪贴板工具

#### clipboard_read（读取剪贴板）

**功能**：读取当前剪贴板内容

**输入参数**：
```python
{
    "format": "text" | "image" | "auto"  # 默认auto自动检测
}
```

**输出结果**：
```python
{
    "success": true/false,
    "content": "文本内容或Base64图片",
    "format": "text" | "image",
    "message": "读取结果描述"
}
```

#### clipboard_write（写入剪贴板）

**功能**：将内容写入剪贴板

**输入参数**：
```python
{
    "content": "要写入的内容",
    "format": "text" | "image"
}
```

**输出结果**：
```python
{
    "success": true/false,
    "message": "写入结果描述"
}
```

**实现方案**：
- 使用Python的`pyperclip`库
- 支持文本和图片格式

### 3.3 系统信息工具

#### get_system_info（获取系统信息）

**功能**：获取计算机系统基本信息

**输入参数**：
```python
{
    "categories": ["os", "cpu", "memory", "disk", "network"]  # 可选，默认全部
}
```

**输出结果**：
```python
{
    "success": true/false,
    "system": {
        "os": "Windows 11 Pro",
        "hostname": "DESKTOP-XXXX",
        "architecture": "x64",
        "version": "23H2"
    },
    "cpu": {
        "name": "Intel(R) Core(TM) i7-12700K",
        "cores": 12,
        "usage_percent": 45.5
    },
    "memory": {
        "total_gb": 32,
        "available_gb": 16,
        "usage_percent": 50.0
    },
    "disk": [
        {"drive": "C:", "total_gb": 500, "free_gb": 200},
        {"drive": "D:", "total_gb": 1000, "free_gb": 600}
    ],
    "network": {
        "hostname": "DESKTOP-XXXX",
        "ip_address": "192.168.1.100"
    }
}
```

**实现方案**：
- 使用Python的`psutil`库
- 分模块获取各类信息

---

## 4. 历史管理（前端集成）

### 4.1 需求说明

**后端API已实现**（阶段2.1）：
- `POST /api/v1/sessions` - 创建会话
- `GET /api/v1/sessions` - 获取会话列表
- `DELETE /api/v1/sessions/{id}` - 删除会话
- `GET /api/v1/sessions/{id}/messages` - 获取消息历史

**阶段2.2需要实现**：
- 前端历史会话列表组件
- 消息历史展示组件
- 与现有Chat组件的集成

### 4.2 前端组件设计

#### HistoryPanel（历史会话面板）

**功能**：展示历史会话列表，支持搜索和切换

**接口设计**：
```typescript
interface HistoryPanelProps {
  onSessionSelect: (sessionId: string) => void;
  onNewSession: () => void;
  currentSessionId?: string;
}
```

**功能列表**：
- 展示会话列表（按更新时间倒序）
- 搜索会话（支持标题关键字）
- 创建新会话
- 删除会话（带确认弹窗）
- 会话时间显示（刚刚、几分钟前、昨天等）

#### MessageHistory（消息历史）

**功能**：展示指定会话的消息历史

**接口设计**：
```typescript
interface MessageHistoryProps {
  sessionId: string;
  onLoadComplete: () => void;
}
```

**功能列表**：
- 加载会话消息历史
- 分页加载（如果消息量大）
- 显示消息时间戳
- 支持滚动查看

### 4.3 与现有组件的集成

**集成到Chat/index.tsx**：
```typescript
// 在Sidebar中添加历史会话入口
// 点击后切换到历史会话视图
// 支持从历史会话恢复对话
```

---

## 5. 技术方案

### 5.1 技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| **窗口管理** | pygetwindow / win32gui | Windows窗口API封装 |
| **截图** | Pillow / mss | 图像捕获和处理 |
| **Shell执行** | subprocess (受限) | 命令执行 |
| **剪贴板** | pyperclip | 跨平台剪贴板 |
| **系统信息** | psutil | 系统信息获取 |
| **前端集成** | React + Ant Design | 历史管理UI |

### 5.2 项目结构

```
backend/
├── app/
│   ├── services/
│   │   ├── file_operations/
│   │   │   ├── tools.py          # P0级工具（已实现）
│   │   │   ├── agent.py          # ReAct执行器（已实现）
│   │   │   └── safety.py         # 安全机制（已实现）
│   │   └── tool_extensions/      # 新增：工具扩展目录
│   │       ├── __init__.py
│   │       ├── window_tools.py   # 窗口管理工具（P1）
│   │       ├── screenshot_tools.py # 截图工具（P1）
│   │       ├── shell_tools.py    # Shell工具（P1）
│   │       ├── clipboard_tools.py # 剪贴板工具（P2）
│   │       └── system_tools.py   # 系统信息工具（P2）
│   └── api/
│       └── v1/
│           ├── chat.py           # 对话API（已实现）
│           ├── sessions.py       # 会话管理（已实现）
│           └── tools.py          # 工具执行API
```

### 5.3 工具注册机制

**扩展现有ToolParser**：
```python
# 现有P0级工具
from app.services.file_operations.tools import FileTools

# 新增P1/P2级工具
from app.services.tool_extensions.window_tools import WindowTools
from app.services.tool_extensions.screenshot_tools import ScreenshotTools
from app.services.tool_extensions.shell_tools import ShellTools
from app.services.tool_extensions.clipboard_tools import ClipboardTools
from app.services.tool_extensions.system_tools import SystemTools

# 统一注册
class ToolRegistry:
    def __init__(self):
        self.tools = {
            # P0级文件工具
            **FileTools.get_tool_definitions(),
            # P1级窗口管理
            **WindowTools.get_tool_definitions(),
            # P1级截图
            **ScreenshotTools.get_tool_definitions(),
            # P1级Shell
            **ShellTools.get_tool_definitions(),
            # P2级剪贴板
            **ClipboardTools.get_tool_definitions(),
            # P2级系统信息
            **SystemTools.get_tool_definitions(),
        }
```

---

## 6. API接口设计

### 6.1 工具执行接口

**已有接口**（阶段1.3）：
```
POST /api/v1/chat
```

**扩展接口**：
```
# 工具列表查询
GET /api/v1/tools
Response: { tools: ToolDefinition[] }

# 工具执行（可选，工具也可通过chat接口调用）
POST /api/v1/tools/execute
Request: { tool_name: string, parameters: object }
Response: { success: boolean, result: object, error?: string }
```

### 6.2 历史管理接口

**已有接口**（阶段2.1后端）：
```
POST /api/v1/sessions           # 创建会话 ✅已实现
GET /api/v1/sessions            # 获取会话列表 ✅已实现
GET /api/v1/sessions/{id}      # 获取会话详情 ✅已实现
DELETE /api/v1/sessions/{id}   # 删除会话 ✅已实现
GET /api/v1/sessions/{id}/messages  # 获取消息历史 ✅已实现
```

**新增接口**：
```
# 更新会话标题
PUT /api/v1/sessions/{id}
Request: { title: string }
Response: { success: boolean, session: Session }
```

---

## 7. 开发计划

### 7.1 开发顺序

```
阶段2.2开发顺序：
├── 1. 窗口管理工具（list_windows, switch_window）
├── 2. 截图工具（screenshot）
├── 3. Shell工具（run_shell）
├── 4. 文件管理增强（create_directory, delete_file）
├── 5. P2级工具（clipboard, system_info）
├── 6. 工具注册和测试
├── 7. 历史管理前端集成
└── 8. 端到端测试和验收
```

### 7.2 工时估算

| 任务 | 工具数 | 工时 | 说明 |
|------|--------|------|------|
| 窗口管理工具 | 2个 | 6h | list_windows + switch_window |
| 截图工具 | 1个 | 4h | screenshot |
| Shell工具 | 1个 | 8h | 含安全机制 |
| 文件管理增强 | 2个 | 3h | 基于现有代码增强 |
| P2级工具 | 3个 | 6h | clipboard + system_info |
| 工具注册和测试 | - | 4h | 集成测试 |
| 历史管理前端 | - | 6h | 前端组件开发 |
| 端到端测试 | - | 4h | 完整流程测试 |
| **总计** | **9个** | **41h** | |

### 7.3 里程碑

| 里程碑 | 目标 | 预计时间 |
|--------|------|----------|
| M1 | P1级6个工具完成 | 第5天 |
| M2 | P2级3个工具完成 | 第7天 |
| M3 | 历史管理前端完成 | 第9天 |
| M4 | 验收通过 | 第11天 |

---

## 8. 测试计划

### 8.1 单元测试

**工具函数测试**（目标：30个）：
| 工具 | 测试数量 | 测试内容 |
|------|---------|---------|
| list_windows | 4个 | 空结果、单窗口、多窗口、异常处理 |
| switch_window | 4个 | 正常切换、句柄无效、标题匹配、异常处理 |
| screenshot | 4个 | 全屏截图、窗口截图，保存失败、格式测试 |
| run_shell | 5个 | 正常执行，黑名单拦截、超时、路径限制、异常 |
| create_directory | 3个 | 正常创建、递归创建、已存在 |
| delete_file | 3个 | 回收站、永久删除、不存在 |
| clipboard_read | 3个 | 文本、图片、空剪贴板 |
| clipboard_write | 2个 | 文本写入、图片写入 |
| get_system_info | 2个 | 全部类别、指定类别 |

### 8.2 集成测试

**场景测试**（目标：10个）：
| 场景 | 测试内容 |
|------|---------|
| 窗口管理 | 列出窗口→切换窗口→验证切换成功 |
| 截图 | 截取屏幕→保存→验证文件存在 |
| Shell执行 | 白名单命令→黑名单命令→验证拦截 |
| 文件删除 | 删除到回收站→验证可恢复 |
| 剪贴板 | 写入→读取→验证内容一致 |
| 系统信息 | 获取信息→验证字段完整 |
| 历史会话 | 创建会话→添加消息→查询历史→验证显示 |

### 8.3 验收测试

**AC验收**：
| 编号 | 验收项 | 验收标准 |
|------|--------|----------|
| AC001 | list_windows | 列出当前桌面所有窗口，显示标题和进程名 |
| AC002 | switch_window | 输入窗口标题，焦点切换到该窗口 |
| AC003 | screenshot | 点击截图按钮，保存PNG/JPG到指定路径 |
| AC004 | run_shell | 执行dir命令成功，执行rm -rf被拦截 |
| AC005 | delete_file | 删除文件到回收站，可从回收站恢复 |
| AC006 | clipboard_read | 读取剪贴板文本，显示内容 |
| AC007 | clipboard_write | 写入剪贴板，粘贴到其他应用验证 |
| AC008 | get_system_info | 显示CPU、内存、磁盘、网络信息 |
| AC009 | 历史会话 | 创建会话→发送消息→查看历史→切换会话 |
| AC010 | 工具集成 | 通过自然语言调用工具，执行并返回结果 |

---

## 9. 验收标准

### 9.1 功能验收（共10个AC）

| 编号 | 验收项 | 验收标准 | 测试方式 | 优先级 |
|------|--------|----------|----------|--------|
| AC001 | 窗口列表 | list_windows返回当前桌面所有窗口信息 | 自动化测试 | P1 |
| AC002 | 窗口切换 | switch_window可切换焦点到指定窗口 | 自动化测试 | P1 |
| AC003 | 屏幕截图 | screenshot可截取屏幕或窗口并保存 | 自动化测试 | P1 |
| AC004 | Shell执行 | run_shell执行白名单命令，黑名单被拦截 | 自动化测试 | P1 |
| AC005 | 文件删除 | delete_file支持回收站和永久删除 | 自动化测试 | P1 |
| AC006 | 剪贴板读 | clipboard_read读取剪贴板内容 | 自动化测试 | P2 |
| AC007 | 剪贴板写 | clipboard_write写入剪贴板 | 自动化测试 | P2 |
| AC008 | 系统信息 | get_system_info返回完整系统信息 | 自动化测试 | P2 |
| AC009 | 历史会话 | 前端历史面板可查看和切换会话 | Playwright | P1 |
| AC010 | 工具集成 | 通过对话调用工具并返回结果 | Playwright | P1 |

### 9.2 质量验收

| 指标 | 验收标准 | 检查方式 |
|------|----------|----------|
| 单元测试覆盖率 | ≥80% | pytest --coverage |
| 集成测试通过率 | 100% (10/10) | pytest |
| 类型检查 | 0错误 | mypy |
| 代码规范 | 0警告 | pylint |

---

## 10. 与现有代码的关系

### 10.1 复用的代码

| 模块 | 复用方式 |
|------|---------|
| FileTools (P0级) | 直接复用现有实现 |
| ReAct执行器 | 复用agent.py，扩展工具列表 |
| 安全机制 | 复用safety.py，扩展Shell黑名单 |
| 会话管理后端 | 完全复用sessions.py |
| DangerConfirmModal | 复用现有组件用于删除确认 |

### 10.2 扩展的代码

| 模块 | 扩展内容 |
|------|---------|
| ToolParser | 添加9个新工具定义 |
| tools.py | 新增工具实现文件 |
| 前端Chat组件 | 集成历史会话面板 |

### 10.3 不需要修改的代码

| 模块 | 说明 |
|------|------|
| 智谱AI集成 | 无需修改 |
| 配置管理 | 无需修改 |
| 健康检查 | 无需修改 |

---

## 11. 风险提示

| 风险 | 影响 | 应对 |
|------|------|------|
| Windows API兼容性 | 不同Windows版本API差异 | 使用跨版本兼容库，异常降级 |
| 截图权限问题 | 某些应用禁止截图 | 提示用户权限不足 |
| Shell安全问题 | 黑名单可能不全 | 持续更新黑名单，用户可反馈 |
| 剪贴板并发 | 多程序同时访问冲突 | 添加重试机制 |
| 测试环境限制 | CI环境无桌面环境 | 使用虚拟显示服务器 |

---

**下一步**：用户审批设计文档后，启动阶段2.2开发。

**参考文档**：
- [桌面omni开发优先级计划v1.1](../doc/桌面omni开发优先级计划.md)
- [桌面omni阶段跟踪表v0.3.2](../doc/桌面omni阶段跟踪表.md)
- [阶段2.1-Web版设计文档](doc/阶段2.1-Web版设计文档-2026-02-17.md)
- [阶段1.3-设计文档](doc/阶段1.3-设计文档-2026-02-16.md)
