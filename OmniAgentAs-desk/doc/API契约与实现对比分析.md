# API契约与实现对比分析文档

**制定人**: 小沈
**制定时间**: 2026-02-18 10:30:00
**用途**: 对比契约文档与实际实现的差异，供团队讨论

---

## 一、契约设计问题分析

### 1.1 会话管理接口设计问题

| 问题 | 契约描述 | 问题分析 | 建议 |
|------|---------|---------|------|
| **创建会话响应缺少字段** | 只返回 `session_id`, `title`, `created_at` | 后续获取会话列表接口需要 `updated_at` 排序和 `message_count` 展示 | 建议增加 `updated_at` 和 `message_count` |

### 1.2 获取会话列表响应格式问题

| 问题 | 契约描述 | 问题分析 |
|------|---------|---------|
| **响应格式不一致** | 契约定义返回 `{total, page, page_size, sessions: []}` | 返回的是嵌套对象，但实际实现返回 `List[SessionResponse]` 数组 |

### 1.3 版本号问题

| 问题 | 契约描述 | 问题分析 |
|------|---------|---------|
| **版本号硬编码** | 契约写死 `"version": "2.1.0"` | 实际项目版本应从 `version.txt` 动态读取 |

---

## 二、实现与契约不一致清单

### 2.1 健康检查接口 (5.1)

| 项目 | 契约要求 | 实际实现 | 差异 |
|------|---------|---------|------|
| 路径 | `GET /api/v1/health` | ✅ 一致 | - |
| 响应 status | `"healthy"` | ✅ 已修正为 `"healthy"` | - |
| 响应 version | `"2.1.0"` | `"0.2.3"` | ⚠️ 不一致 |

**建议**: 契约改为动态版本号，或确认使用 `0.2.3`

---

### 2.2 回显测试接口 (5.2)

| 项目 | 契约要求 | 实际实现 | 差异 |
|------|---------|---------|------|
| 路径 | `POST /api/v1/echo` | ✅ 一致 | - |
| 请求格式 | `{"message": "Hello"}` | ✅ 一致 | - |
| 响应格式 | `{"received": "Hello", "timestamp": "..."}` | ✅ 一致 | - |

**状态**: ✅ 完全一致

---

### 2.3 安全检查接口 (3.1)

| 项目 | 契约要求 | 实际实现 | 差异 |
|------|---------|---------|------|
| 路径 | `POST /api/v1/security/check` | ✅ 一致 | - |
| 请求格式 | `{"command": "rm -rf /"}` | ✅ 一致 | - |
| 响应 safe | `false` | ✅ 一致 | - |
| 响应 risk | `"检测到危险命令: rm -rf /"` | ✅ 一致 | - |
| 响应 suggestion | `"该操作将删除系统所有文件"` | `"该操作将造成系统破坏或数据丢失，禁止执行"` | ⚠️ 文字略有不同 |

**建议**: 统一 suggestion 文字

---

### 2.4 流式执行接口 (6.1)

| 项目 | 契约要求 | 实际实现 | 差异 |
|------|---------|---------|------|
| 路径 | `GET /api/v1/chat/execution/{session_id}/stream` | ✅ 一致 | - |
| 响应格式 | SSE 事件流 | ✅ 一致 | - |
| 事件类型 | thought/action/observation/final/complete | ✅ 一致 | - |

**状态**: ✅ 格式一致

**注意**: 当前实现是从数据库读取历史消息的 `execution_steps`，如果需要实时流式执行（Agent边执行边推送），需要额外开发。

---

### 2.5 会话管理接口 (2.1-2.4)

#### 2.5.1 创建会话 (2.1)

| 项目 | 契约要求 | 实际实现 | 差异 |
|------|---------|---------|------|
| 路径 | `POST /api/v1/sessions` | ✅ 一致 | - |
| 响应 session_id | ✅ 一致 | ✅ 一致 | - |
| 响应 title | ✅ 一致 | ✅ 一致 | - |
| 响应 created_at | ✅ 一致 | ✅ 一致 | - |
| 响应 updated_at | ❌ 缺失 | ✅ 有 | ⚠️ 契约缺少此字段 |
| 响应 message_count | ❌ 缺失 | ✅ 有 | ⚠️ 契约缺少此字段 |

**结论**: 实现比契约多返回字段，不影响功能

---

#### 2.5.2 获取会话列表 (2.2)

| 项目 | 契约要求 | 实际实现 | 差异 |
|------|---------|---------|------|
| 路径 | `GET /api/v1/sessions?page=1&page_size=20&keyword=xxx` | ✅ 一致 | - |
| 响应格式 | `{total, page, page_size, sessions: []}` | `List[SessionResponse]` | ❌ **严重不一致** |

**问题**: 契约要求返回对象包含 total 字段，但实现直接返回数组

---

#### 2.5.3 获取会话消息 (2.3)

| 项目 | 契约要求 | 实际实现 | 差异 |
|------|---------|---------|------|
| 路径 | `GET /api/v1/sessions/{session_id}/messages` | ✅ 一致 | - |
| execution_steps 格式 | 数组格式 `[{type, content, ...}]` | JSON字符串 | ⚠️ 需转换 |

---

## 三、修复建议

### 3.1 方案A：修正实现，匹配契约

需要修改的接口：

1. **健康检查**: 修改 version 返回值为 `"2.1.0"` 或契约改为动态版本
2. **安全检查**: 统一 suggestion 文字
3. **获取会话列表**: 修改响应格式，添加 total 字段

### 3.2 方案B：修正契约，匹配实现

需要修改的文档：

1. **创建会话**: 增加 `updated_at` 和 `message_count` 字段说明
2. **获取会话列表**: 修改响应为数组格式，或明确分页需求
3. **健康检查**: 使用动态版本号

### 3.3 方案C：混合方案

- 优先保持实现稳定性，修正文档描述
- 对于关键字段不一致（如会话列表格式），讨论确认后再定

---

## 四、待确认问题

1. **版本号策略**: 使用固定 `"2.1.0"` 还是动态读取？
2. **会话列表格式**: 坚持契约的嵌套对象还是使用数组？
3. **流式执行**: 是否需要实时推送还是仅回放历史？

---

**文档状态**: 待讨论
**下一步**: 与小新确认处理方案
