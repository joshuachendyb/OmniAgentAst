# OmniAgentAst. 开发策略规范

**文档编号**: OMA-DEV-001  
**版本**: v1.0  
**创建时间**: 2026-02-15 22:05:53  
**适用范围**: OmniAgentAst. 桌面版项目全生命周期  
**制定原则**: 质量优先，稳扎稳打，杜绝"快但烂"

---

## 1. 核心理念

### 1.1 开发铁律

| 优先级 | 铁律 | 违反后果 |
|--------|------|---------|
| **P0** | **质量 > 速度** | 宁可慢，不可用 |
| **P0** | **测试先行** | 无测试 = 未完成 |
| **P0** | **阶段锁定** | 前一阶段未验收，绝不开始下一阶段 |
| **P1** | **文档驱动** | 先设计，后编码，再验证 |
| **P1** | **用户验收** | 每个阶段必须用户确认可用 |
| **P2** | **渐进累加** | 每个阶段输出是可验证的增量 |

### 1.2 失败案例警示

> **反面教材**: "AI七里哐啷开发完成，结果啥都不能用"
> 
> **根本原因**:
> 1. 追求速度，忽视质量
> 2. 缺少测试，问题累积
> 3. 阶段跳跃，基础不牢
> 4. 没有Review，代码失控
> 
> **本规范目标**: 杜绝此类情况再次发生

---

## 2. 阶段开发流程（标准SOP）

### 2.1 阶段生命周期

```
┌─────────────────────────────────────────────────────────────┐
│                    阶段 N 开发流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 阶段启动                                                 │
│     ├─ 读取本规范                                            │
│     ├─ 明确阶段目标                                          │
│     └─ 准备开发环境                                          │
│                        ↓                                    │
│  2. 设计文档编写 （必须！）                                   │
│     ├─ 阶段目标描述                                          │
│     ├─ 技术方案设计                                          │
│     ├─ 接口定义                                              │
│     └─ 验收标准清单                                          │
│                        ↓                                    │
│  3. 功能开发                                                │
│     ├─ 编写功能代码                                          │
│     ├─ 同步编写单元测试                                      │
│     └─ 代码规范检查                                          │
│                        ↓                                    │
│  4. 测试验证                                                │
│     ├─ 运行单元测试（100%通过）                               │
│     ├─ 运行集成测试                                          │
│     ├─ 边界情况测试                                          │
│     └─ 生成测试报告                                          │
│                        ↓                                    │
│  5. 代码审查                                                │
│     ├─ 静态代码分析                                          │
│     ├─ 逻辑正确性检查                                        │
│     ├─ 安全漏洞扫描                                          │
│     └─ 性能初步评估                                          │
│                        ↓                                    │
│  6. 阶段总结文档                                            │
│     ├─ 完成功能清单                                          │
│     ├─ 技术实现说明                                          │
│     ├─ 问题与解决方案                                        │
│     └─ 待改进项                                              │
│                        ↓                                    │
│  7. 用户验收                                                │
│     ├─ 演示阶段成果                                          │
│     ├─ 用户实际使用测试                                      │
│     ├─ 收集反馈                                              │
│     └─ 确认验收或打回修改                                    │
│                        ↓                                    │
│  8. 阶段锁定                                                │
│     ├─ Git标签（如 v0.1.0-phase1）                           │
│     ├─ 归档阶段文档                                          │
│     └─ 禁止后续修改（如需修改走补丁流程）                     │
│                        ↓                                    │
│  9. 进入下一阶段                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 阶段状态定义

| 状态 | 定义 | 转换条件 |
|------|------|---------|
| **待启动** | 阶段尚未开始 | 前一阶段已锁定 |
| **进行中** | 正在进行开发 | 设计文档已批准 |
| **待测试** | 功能开发完成 | 代码已提交 |
| **测试中** | 正在进行测试 | 测试用例已编写 |
| **待审查** | 测试已通过 | 测试报告已生成 |
| **审查中** | 正在进行代码审查 | 代码审查发起 |
| **待验收** | 审查已通过 | 问题已修复 |
| **验收中** | 用户正在验收 | 阶段总结已完成 |
| **已锁定** | 阶段已完成并锁定 | 用户确认验收 |
| **已打回** | 验收未通过需修改 | 用户提出修改意见 |

---

## 3. 文档规范

### 3.1 必须产出的文档

每个阶段必须产出以下文档，缺一不可：

#### 3.1.1 阶段设计文档（开发前）

**文件名**: `阶段X-设计文档-YYYY-MM-DD.md`

**必须包含**:
```markdown
# 阶段X：阶段名称 - 设计文档

## 1. 阶段目标
- 本阶段要实现什么功能
- 解决什么问题
- 预期效果

## 2. 技术方案
- 架构设计
- 关键技术选型
- 接口定义
- 数据结构设计

## 3. 验收标准（可验证！）
- [ ] 验收项1：具体描述 + 验证方法
- [ ] 验收项2：具体描述 + 验证方法
- [ ] 验收项3：具体描述 + 验证方法

## 4. 风险与应对
- 可能遇到的问题
- 应对方案

## 5. 参考资料
- 相关文档链接
```

#### 3.1.2 测试报告（测试后）

**文件名**: `阶段X-测试报告-YYYY-MM-DD.md`

**必须包含**:
```markdown
# 阶段X：阶段名称 - 测试报告

## 1. 测试概述
- 测试时间
- 测试环境
- 测试人员

## 2. 测试用例清单
| 用例ID | 用例描述 | 测试类型 | 状态 | 备注 |
|--------|---------|---------|------|------|
| TC001 | ... | 单元测试 | ✅通过 | ... |
| TC002 | ... | 边界测试 | ❌失败 | ... |

## 3. 测试统计
- 总用例数：X
- 通过数：Y
- 失败数：Z
- 覆盖率：XX%

## 4. 问题清单
- 发现的问题
- 修复状态

## 5. 测试结论
- 是否通过阶段测试
- 遗留问题
```

#### 3.1.3 阶段总结文档（验收前）

**文件名**: `阶段X-阶段总结-YYYY-MM-DD.md`

**必须包含**:
```markdown
# 阶段X：阶段名称 - 阶段总结

## 1. 完成情况
- 计划功能：X项
- 实际完成：Y项
- 未完成：Z项（说明原因）

## 2. 技术实现
- 关键代码说明
- 架构图
- 技术难点及解决方案

## 3. 问题记录
- 开发中遇到的问题
- 解决方法
- 经验教训

## 4. 待改进项
- 已知缺陷
- 优化建议
- 后续阶段需要注意的问题

## 5. 阶段资产
- 代码变更清单
- 新增文件清单
- 修改的文件清单
```

### 3.2 文档质量要求

| 检查项 | 标准 | 检查方法 |
|--------|------|---------|
| **完整性** | 文档结构完整，不缺章节 | 对照模板检查 |
| **准确性** | 技术描述准确，无错误 | 技术Review |
| **可追溯性** | 每个决策有依据 | 检查参考资料 |
| **可验证性** | 验收标准可测试 | 用例验证 |
| **时效性** | 文档日期准确 | 检查时间戳 |

---

## 4. 测试规范

### 4.1 测试金字塔

```
        /\
       /  \
      / E2E \           端到端测试（少而精）
     /--------\
    / 集成测试 \         模块间交互（关键路径）
   /------------\
  /   单元测试    \      函数/组件（大量覆盖）
 /----------------\
```

### 4.2 单元测试要求

**必须测试的内容**:
- [ ] 正常输入（Happy Path）
- [ ] 边界值（最小值、最大值、空值）
- [ ] 异常输入（null、undefined、类型错误）
- [ ] 错误处理（异常抛出、错误码）

**覆盖率要求**:
| 阶段 | 语句覆盖率 | 分支覆盖率 | 函数覆盖率 |
|------|-----------|-----------|-----------|
| MVP阶段 | ≥80% | ≥70% | ≥90% |
| 增强阶段 | ≥85% | ≥75% | ≥95% |
| 完善阶段 | ≥90% | ≥80% | ≥100% |

### 4.3 测试代码规范

**测试文件命名**:
- 前端: `ComponentName.test.tsx` 或 `*.spec.ts`
- 后端: `test_*.py` 或 `*_test.py`

**测试代码结构**:
```python
# 后端示例（Python）
def test_function_name():
    """测试功能描述"""
    # Arrange（准备）
    input_data = ...
    expected = ...
    
    # Act（执行）
    result = function(input_data)
    
    # Assert（断言）
    assert result == expected
    
    # Cleanup（清理）
    ...
```

```typescript
// 前端示例（React）
describe('ComponentName', () => {
  it('should do something', () => {
    // Arrange
    render(<Component {...props} />)
    
    // Act
    fireEvent.click(screen.getByText('Button'))
    
    // Assert
    expect(screen.getByText('Result')).toBeInTheDocument()
  })
})
```

---

## 5. 代码审查规范

### 5.1 审查清单

**功能性**:
- [ ] 代码实现了设计文档中的功能
- [ ] 边界情况已处理
- [ ] 错误处理完善
- [ ] 无明显逻辑错误

**可读性**:
- [ ] 命名清晰（变量、函数、类）
- [ ] 有适当的注释（非显而易见处）
- [ ] 代码结构清晰，无过度复杂
- [ ] 无死代码、无调试代码

**规范性**:
- [ ] 符合项目代码风格（ESLint/Pylint通过）
- [ ] 类型定义完整（TypeScript/Python类型注解）
- [ ] 无硬编码（配置化）

**安全性**:
- [ ] 无敏感信息泄露（密钥、密码）
- [ ] 输入已验证
- [ ] 无SQL注入、XSS等漏洞

**性能**:
- [ ] 无明显性能问题
- [ ] 无内存泄漏风险

### 5.2 审查记录

**必须记录**:
```markdown
# 代码审查记录

**审查日期**: YYYY-MM-DD  
**审查人**: XXX  
**被审查代码**: 阶段X

## 审查发现

### 严重问题（必须修复）
1. 问题描述
   - 位置：文件路径，行号
   - 影响：... 
   - 建议：...

### 一般问题（建议修复）
1. 问题描述
   - 位置：...
   - 建议：...

### 建议改进
1. ...

## 审查结论
- [ ] 通过
- [ ] 有条件通过（需修复严重问题）
- [ ] 不通过（需全面修改）

## 修复验证
- [ ] 所有严重问题已修复
- [ ] 重新审查通过
```

---

## 6. 阶段锁定机制

### 6.1 锁定条件

阶段必须同时满足以下条件才能锁定：

1. ✅ 所有设计文档已归档
2. ✅ 所有测试用例100%通过
3. ✅ 代码审查已通过
4. ✅ 阶段总结文档已完成
5. ✅ **用户验收已通过**（最关键！）

### 6.2 锁定操作

```bash
# 1. 打Git标签
git tag -a v0.X.0-phaseN -m "阶段N完成并锁定"

# 2. 推送标签
git push origin v0.X.0-phaseN

# 3. 创建阶段归档目录
mkdir -p docs/阶段归档/阶段N-阶段名称
cp 阶段N-*.md docs/阶段归档/阶段N-阶段名称/

# 4. 在阶段跟踪表中更新状态
```

### 6.3 锁定后规则

**严禁**:
- ❌ 修改已锁定阶段的代码
- ❌ 在已锁定阶段新增功能
- ❌ 覆盖阶段标签

**如需修改必须**:
1. 走"补丁流程"（见6.4）
2. 或进入下一阶段统一处理

### 6.4 补丁流程（Hotfix）

如果发现已锁定阶段有严重bug必须修复：

```
1. 发起补丁申请
   └─ 说明bug影响、修复方案
   
2. 用户批准
   └─ 确认需要修复
   
3. 创建补丁分支
   └─ git checkout -b hotfix/阶段N-修复描述
   
4. 修复并测试
   └─ 必须补充测试用例
   
5. 代码审查
   └─ 审查修复代码
   
6. 用户验收
   └─ 确认修复有效
   
7. 合并补丁
   └─ git merge + 新标签 v0.X.1-phaseN
   
8. 更新补丁记录
```

---

## 7. 阶段跟踪与监控

### 7.1 阶段跟踪表

**文件名**: `阶段跟踪表.md`（根目录下，实时更新）

```markdown
# OmniAgentAst. 阶段跟踪表

**最后更新**: YYYY-MM-DD HH:MM:SS

| 阶段 | 阶段名称 | 状态 | 设计文档 | 测试报告 | 阶段总结 | 锁定标签 | 验收人 |
|------|---------|------|---------|---------|---------|---------|--------|
| 1.0 | 项目骨架搭建 | ✅已锁定 | [链接] | [链接] | [链接] | v0.1.0-phase1 | XXX |
| 1.1 | GLM基础对话 | 🟡进行中 | [链接] | - | - | - | - |
| 1.2 | 流式响应 | ⏸️待启动 | - | - | - | - | - |
| 1.3 | 工具框架 | ⏸️待启动 | - | - | - | - | - |
| 1.4 | P0工具集 | ⏸️待启动 | - | - | - | - | - |

## 统计信息
- 总阶段数：X
- 已完成：Y
- 进行中：Z
- 待启动：W
```

### 7.2 每日状态更新

**规则**: 每天结束工作前，更新阶段跟踪表

**更新内容**:
- 当前阶段进展百分比
- 遇到的问题
- 需要的支持

---

## 8. 违规处理

### 8.1 违规行为定义

| 违规行为 | 示例 | 处理措施 |
|---------|------|---------|
| **跳阶段开发** | 阶段1未完成就开始阶段2 | 立即停止，回退到上一阶段 |
| **无文档开发** | 直接写代码，后补文档 | 暂停开发，补全文档 |
| **无测试提交** | 功能代码无对应测试 | 拒绝合并，补充测试 |
| **验收未过强行锁定** | 用户未确认就标记完成 | 解锁，重新验收 |
| **修改已锁定阶段** | 直接在已锁定代码上修改 | 回滚，走补丁流程 |

### 8.2 违规记录

**文件名**: `违规记录-YYYY-MM-DD.md`

```markdown
# 违规记录

**日期**: YYYY-MM-DD  
**违规人**: AI助手（小欧）  
**违规类型**: 跳阶段开发

## 违规描述
- 阶段1.1未完成，提前开始阶段1.2开发
- 具体行为：...

## 处理措施
1. 立即停止阶段1.2工作
2. 删除阶段1.2代码（已Git备份）
3. 回到阶段1.1继续完善
4. 补全阶段1.1缺失的测试

## 预防措施
- 加强阶段状态检查
- 每天核对阶段跟踪表
- 用户提醒机制

## 用户确认
- [ ] 处理完成，确认接受
```

---

## 9. 附录

### 9.1 术语表

| 术语 | 定义 |
|------|------|
| **阶段** | 有明确目标、可验收的独立开发单元 |
| **锁定** | 阶段完成并归档，禁止修改 |
| **验收** | 用户确认阶段输出符合预期 |
| **覆盖率** | 测试代码覆盖的功能代码比例 |
| **补丁** | 对已锁定阶段的紧急修复 |

### 9.2 参考文档

- 《代码整洁之道》
- 《测试驱动开发》
- 《持续交付》

### 9.3 修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|---------|
| v1.0 | 2026-02-15 | AI助手小欧 | 初始版本，制定开发策略规范 |

---

## 10. 第二版改进说明（基于历史经验）

**修订时间**: 2026-02-15 22:08:47  
**修订依据**: D:\50RuleTool\规范与规则 历史经验文档

### 10.1 整合的核心经验

#### 经验1：代码迭代规范（不求快，只求稳）

**来源**: 《软件代码迭代规范》

**核心原则**:
- ✅ 先分析，再动手
- ✅ 分步骤，慢慢走
- ✅ 改之前，先备份
- ✅ 不改名，只改值
- ✅ 每步完，要验证

**在本规范中的体现**:
- 阶段开发流程中的"设计文档编写"强制要求先分析再动手
- 阶段锁定机制确保每步完要验证
- 补丁流程规范改之前先备份的原则

#### 经验2：代码检查方法（闭环整改）

**来源**: 《代码检查方法》

**核心原则**:
- 建设性：以帮助改进为目的
- 闭环整改：发现问题 + 整改问题 = 代码没问题
- 专注核心：仅审查核心功能代码
- 立即执行：完成功能后立刻检查

**审查维度**（已整合到本规范5.1节）:
1. **代码逻辑审查**: 业务逻辑正确性、算法和数据结构
2. **代码质量审查**: 代码风格、可读性和可维护性
3. **技术实现审查**: 类型安全、组件设计
4. **性能和安全性审查**: 性能优化、安全性检查

**新增要求**:
- 每个阶段必须包含代码审查清单
- 审查发现的问题必须形成闭环（发现→修复→验证）

#### 经验3：代码风险分析（六步分析法）

**来源**: 《代码风险分析方法》

**风险严重程度分级**（已整合）:
| 级别 | 定义 | 处理方式 |
|------|------|---------|
| **P0-紧急** | 可能导致系统崩溃、数据丢失 | 必须立即修复，阶段验收不通过 |
| **P1-高** | 功能异常、性能严重下降 | 必须修复后才能进入下一阶段 |
| **P2-中** | 边界问题、轻微性能影响 | 建议修复，可延期到下一阶段 |
| **P3-低** | 体验问题、代码质量问题 | 可选修复，记录待改进项 |

**六步分析方法论**（新增到阶段开发流程）:
1. **收集上下文**: 理解函数目的和业务逻辑
2. **静态代码走读**: 逐行分析，识别可疑模式
3. **边界条件测试**: 测试null、undefined、空字符串、极值
4. **依赖和约束分析**: 第三方库安全性、系统资源限制
5. **时序和状态分析**: 并发访问、异步操作时序
6. **综合风险评估**: 风险评分 = 影响程度 × 发生概率 × 暴露范围

**应用时机**:
- 阶段代码审查时必须执行风险评估
- 高风险项必须修复后才能验收

#### 经验4：版本号变更管理（分级授权）

**来源**: 《版本号变更规范》

**版本号格式**: MAJOR.MINOR.PATCH（语义化版本）

**变更权限**（已整合到阶段锁定机制）:
| 版本位 | 变更场景 | 决策权限 | 在本规范中的对应 |
|--------|----------|----------|-----------------|
| **第1位(MAJOR)** | 重大架构变更 | ❌ 用户明确指令 | 整体项目里程碑 |
| **第2位(MINOR)** | 新功能模块 | ⚠️ 必须用户同意 | 大阶段完成（如Phase 1完成） |
| **第3位(PATCH)** | Bug修复、优化 | ✅ 可自主决定 | 阶段内补丁版本 |

**Git标签规范**:
```
阶段标签: v0.X.0-phaseN  （阶段锁定）
补丁标签: v0.X.Y-phaseN  （阶段内修复）
```

#### 经验5：Git分支策略（feature分支模式）

**来源**: 《git使用规范》

**分支类型**（已整合）:
| 分支类型 | 命名格式 | 用途 | 生命周期 |
|---------|---------|------|---------|
| **主线分支** | `main` | 稳定版本 | 永久 |
| **阶段分支** | `phase/阶段号` | 阶段开发 | 阶段完成后合并 |
| **修复分支** | `bugfix/描述` | 阶段内修复 | 修复后合并 |
| **补丁分支** | `hotfix/描述` | 已锁定阶段补丁 | 补丁后合并 |

**应用规则**:
- 每个阶段创建独立分支 `phase/1.1-glm基础对话`
- 阶段开发在主分支上进行，保持线性历史
- 阶段锁定后如需要修复，创建补丁分支

### 10.2 第二版新增内容

#### 新增1：风险分析环节（阶段开发流程）

在原有流程中新增**风险分析**环节：

```
3. 功能开发
   └─ 编写功能代码
      
   【新增】3.5 风险分析
   ├─ 静态代码走读
   ├─ 边界条件测试
   ├─ 依赖和约束分析
   └─ 风险评估报告
   
4. 测试验证
```

**风险评估报告模板**:
```markdown
## 阶段X 风险评估报告

### 风险清单
| 风险ID | 位置 | 描述 | 级别 | 状态 |
|--------|------|------|------|------|
| R001 | src/api.ts:45 | 未处理API超时 | P1 | 已修复 |
| R002 | src/utils.ts:23 | 可能返回null | P2 | 待修复 |

### 评估结论
- 高风险项: X个（必须修复）
- 中风险项: Y个（建议修复）
- 阶段验收: [ ] 通过 [ ] 有条件通过 [ ] 不通过
```

#### 新增2：备份检查清单（阶段启动时）

**来源**: 《软件迭代代码备份规则》

**阶段启动前必须执行**:
- [ ] 确认前一阶段已备份（Git标签已打）
- [ ] 确认当前工作区干净（无未提交修改）
- [ ] 创建阶段分支（如 `phase/1.1`）
- [ ] 备份当前配置文件

#### 新增3：代码迭代检查点（开发过程中）

**来源**: 《软件代码迭代规范》

**开发过程中的强制检查点**:

**检查点1：分析完成**
- [ ] 设计文档已批准
- [ ] 技术方案已确认
- [ ] 接口定义已完成

**检查点2：编码规范**
- [ ] 命名规范符合约定
- [ ] 代码格式统一（ESLint/Pylint通过）
- [ ] 适当注释（非显而易见处）

**检查点3：单元测试同步**
- [ ] 功能代码与测试代码同步编写
- [ ] 测试用例覆盖正常路径
- [ ] 测试用例覆盖边界条件
- [ ] 测试用例覆盖异常情况

**检查点4：验证通过**
- [ ] 单元测试100%通过
- [ ] 集成测试通过
- [ ] 手动验证通过

### 10.3 第二版修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|---------|
| v1.0 | 2026-02-15 22:05:53 | AI助手小欧 | 初始版本，建立阶段开发基本流程 |
| v2.0 | 2026-02-15 22:08:47 | AI助手小欧 | 第二版，整合历史经验文档，新增风险分析、备份检查、代码迭代检查点等 |

### 10.4 经验文档对照表

| 本规范章节 | 对应经验文档 | 对应章节 |
|-----------|-------------|---------|
| 4.2 单元测试要求 | 《软件代码迭代规范》 | 第7章测试验证 |
| 5.1 代码审查清单 | 《代码检查方法》 | 第四章审查内容清单 |
| 新增3.5 风险分析 | 《代码风险分析方法》 | 第二章六步分析方法论 |
| 6.3 版本号管理 | 《版本号变更规范》 | 第二章版本位变更权限 |
| 8.1 Git使用 | 《git使用规范》 | 第0章分支策略 |
| 6.1 备份检查 | 《软件迭代代码备份规则》 | 第4章备份方法 |

---

**文档结束**

**重要提醒**: 本文档是开发的"宪法"，所有参与开发的人员（包括AI助手）必须严格遵守。任何违反本规范的行为都将被记录并纠正。

**版本确认**:
- [ ] 已阅读v1.0基础版本
- [ ] 已阅读v2.0改进说明
- [ ] 理解并同意所有条款（含经验整合内容）
- [ ] 确认按此规范执行

**确认人**: _______________  
**确认日期**: YYYY-MM-DD  
**确认版本**: v2.0
