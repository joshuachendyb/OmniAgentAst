# OmniAgentAst. 开发策略规范

**文档编号**: OMA-DEV-001  
**版本**: v1.0  
**创建时间**: 2026-02-15 22:05:53  
**适用范围**: OmniAgentAst. 桌面版项目全生命周期  
**制定原则**: 质量优先，稳扎稳打，杜绝"快但烂"

---

## 1. 核心理念

### 1.1 开发铁律

| 优先级 | 铁律 | 违反后果 |
|--------|------|---------|
| **P0** | **质量 > 速度** | 宁可慢，不可用 |
| **P0** | **测试先行** | 无测试 = 未完成 |
| **P0** | **阶段锁定** | 前一阶段未验收，绝不开始下一阶段 |
| **P1** | **文档驱动** | 先设计，后编码，再验证 |
| **P1** | **用户验收** | 每个阶段必须用户确认可用 |
| **P2** | **渐进累加** | 每个阶段输出是可验证的增量 |

### 1.2 失败案例警示

> **反面教材**: "AI七里哐啷开发完成，结果啥都不能用"
> 
> **根本原因**:
> 1. 追求速度，忽视质量
> 2. 缺少测试，问题累积
> 3. 阶段跳跃，基础不牢
> 4. 没有Review，代码失控
> 
> **本规范目标**: 杜绝此类情况再次发生

---

## 2. 阶段开发流程（标准SOP）

### 2.1 阶段生命周期

```
┌─────────────────────────────────────────────────────────────┐
│                    阶段 N 开发流程                           │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. 阶段启动                                                 │
│     ├─ 读取本规范                                            │
│     ├─ 明确阶段目标                                          │
│     └─ 准备开发环境                                          │
│                        ↓                                    │
│  2. 设计文档编写 （必须！）                                   │
│     ├─ 阶段目标描述                                          │
│     ├─ 技术方案设计                                          │
│     ├─ 接口定义                                              │
│     └─ 验收标准清单                                          │
│                        ↓                                    │
│  3. 功能开发                                                │
│     ├─ 编写功能代码                                          │
│     ├─ 同步编写单元测试                                      │
│     └─ 代码规范检查                                          │
│                        ↓                                    │
│  4. 测试验证                                                │
│     ├─ 运行单元测试（100%通过）                               │
│     ├─ 运行集成测试                                          │
│     ├─ 边界情况测试                                          │
│     └─ 生成测试报告                                          │
│                        ↓                                    │
│  5. 代码审查                                                │
│     ├─ 静态代码分析                                          │
│     ├─ 逻辑正确性检查                                        │
│     ├─ 安全漏洞扫描                                          │
│     └─ 性能初步评估                                          │
│                        ↓                                    │
│  6. 阶段总结文档                                            │
│     ├─ 完成功能清单                                          │
│     ├─ 技术实现说明                                          │
│     ├─ 问题与解决方案                                        │
│     └─ 待改进项                                              │
│                        ↓                                    │
│  7. 用户验收                                                │
│     ├─ 演示阶段成果                                          │
│     ├─ 用户实际使用测试                                      │
│     ├─ 收集反馈                                              │
│     └─ 确认验收或打回修改                                    │
│                        ↓                                    │
│  8. 阶段锁定                                                │
│     ├─ Git标签（如 v0.1.0-phase1）                           │
│     ├─ 归档阶段文档                                          │
│     └─ 禁止后续修改（如需修改走补丁流程）                     │
│                        ↓                                    │
│  9. 进入下一阶段                                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 阶段状态定义

| 状态 | 定义 | 转换条件 |
|------|------|---------|
| **待启动** | 阶段尚未开始 | 前一阶段已锁定 |
| **进行中** | 正在进行开发 | 设计文档已批准 |
| **待测试** | 功能开发完成 | 代码已提交 |
| **测试中** | 正在进行测试 | 测试用例已编写 |
| **待审查** | 测试已通过 | 测试报告已生成 |
| **审查中** | 正在进行代码审查 | 代码审查发起 |
| **待验收** | 审查已通过 | 问题已修复 |
| **验收中** | 用户正在验收 | 阶段总结已完成 |
| **已锁定** | 阶段已完成并锁定 | 用户确认验收 |
| **已打回** | 验收未通过需修改 | 用户提出修改意见 |

---

## 3. 文档规范

### 3.1 必须产出的文档

每个阶段必须产出以下文档，缺一不可：

#### 3.1.1 阶段设计文档（开发前）

**文件名**: `阶段X-设计文档-YYYY-MM-DD.md`

**必须包含**:
```markdown
# 阶段X：阶段名称 - 设计文档

## 1. 阶段目标
- 本阶段要实现什么功能
- 解决什么问题
- 预期效果

## 2. 技术方案
- 架构设计
- 关键技术选型
- 接口定义
- 数据结构设计

## 3. 验收标准（可验证！）
- [ ] 验收项1：具体描述 + 验证方法
- [ ] 验收项2：具体描述 + 验证方法
- [ ] 验收项3：具体描述 + 验证方法

## 4. 风险与应对
- 可能遇到的问题
- 应对方案

## 5. 参考资料
- 相关文档链接
```

#### 3.1.2 测试报告（测试后）

**文件名**: `阶段X-测试报告-YYYY-MM-DD.md`

**必须包含**:
```markdown
# 阶段X：阶段名称 - 测试报告

## 1. 测试概述
- 测试时间
- 测试环境
- 测试人员

## 2. 测试用例清单
| 用例ID | 用例描述 | 测试类型 | 状态 | 备注 |
|--------|---------|---------|------|------|
| TC001 | ... | 单元测试 | ✅通过 | ... |
| TC002 | ... | 边界测试 | ❌失败 | ... |

## 3. 测试统计
- 总用例数：X
- 通过数：Y
- 失败数：Z
- 覆盖率：XX%

## 4. 问题清单
- 发现的问题
- 修复状态

## 5. 测试结论
- 是否通过阶段测试
- 遗留问题
```

#### 3.1.3 阶段总结文档（验收前）

**文件名**: `阶段X-阶段总结-YYYY-MM-DD.md`

**必须包含**:
```markdown
# 阶段X：阶段名称 - 阶段总结

## 1. 完成情况
- 计划功能：X项
- 实际完成：Y项
- 未完成：Z项（说明原因）

## 2. 技术实现
- 关键代码说明
- 架构图
- 技术难点及解决方案

## 3. 问题记录
- 开发中遇到的问题
- 解决方法
- 经验教训

## 4. 待改进项
- 已知缺陷
- 优化建议
- 后续阶段需要注意的问题

## 5. 阶段资产
- 代码变更清单
- 新增文件清单
- 修改的文件清单
```

### 3.2 文档质量要求

| 检查项 | 标准 | 检查方法 |
|--------|------|---------|
| **完整性** | 文档结构完整，不缺章节 | 对照模板检查 |
| **准确性** | 技术描述准确，无错误 | 技术Review |
| **可追溯性** | 每个决策有依据 | 检查参考资料 |
| **可验证性** | 验收标准可测试 | 用例验证 |
| **时效性** | 文档日期准确 | 检查时间戳 |

---

## 4. 测试规范

### 4.1 测试金字塔

```
        /\
       /  \
      / E2E \           端到端测试（少而精）
     /--------\
    / 集成测试 \         模块间交互（关键路径）
   /------------\
  /   单元测试    \      函数/组件（大量覆盖）
 /----------------\
```

### 4.2 单元测试要求

**必须测试的内容**:
- [ ] 正常输入（Happy Path）
- [ ] 边界值（最小值、最大值、空值）
- [ ] 异常输入（null、undefined、类型错误）
- [ ] 错误处理（异常抛出、错误码）

**覆盖率要求**:
| 阶段 | 语句覆盖率 | 分支覆盖率 | 函数覆盖率 |
|------|-----------|-----------|-----------|
| MVP阶段 | ≥80% | ≥70% | ≥90% |
| 增强阶段 | ≥85% | ≥75% | ≥95% |
| 完善阶段 | ≥90% | ≥80% | ≥100% |

### 4.3 测试代码规范

**测试文件命名**:
- 前端: `ComponentName.test.tsx` 或 `*.spec.ts`
- 后端: `test_*.py` 或 `*_test.py`

**测试代码结构**:
```python
# 后端示例（Python）
def test_function_name():
    """测试功能描述"""
    # Arrange（准备）
    input_data = ...
    expected = ...
    
    # Act（执行）
    result = function(input_data)
    
    # Assert（断言）
    assert result == expected
    
    # Cleanup（清理）
    ...
```

```typescript
// 前端示例（React）
describe('ComponentName', () => {
  it('should do something', () => {
    // Arrange
    render(<Component {...props} />)
    
    // Act
    fireEvent.click(screen.getByText('Button'))
    
    // Assert
    expect(screen.getByText('Result')).toBeInTheDocument()
  })
})
```

---

## 5. 代码审查规范

### 5.1 审查清单

**功能性**:
- [ ] 代码实现了设计文档中的功能
- [ ] 边界情况已处理
- [ ] 错误处理完善
- [ ] 无明显逻辑错误

**可读性**:
- [ ] 命名清晰（变量、函数、类）
- [ ] 有适当的注释（非显而易见处）
- [ ] 代码结构清晰，无过度复杂
- [ ] 无死代码、无调试代码

**规范性**:
- [ ] 符合项目代码风格（ESLint/Pylint通过）
- [ ] 类型定义完整（TypeScript/Python类型注解）
- [ ] 无硬编码（配置化）

**安全性**:
- [ ] 无敏感信息泄露（密钥、密码）
- [ ] 输入已验证
- [ ] 无SQL注入、XSS等漏洞

**性能**:
- [ ] 无明显性能问题
- [ ] 无内存泄漏风险

### 5.2 审查记录

**必须记录**:
```markdown
# 代码审查记录

**审查日期**: YYYY-MM-DD  
**审查人**: XXX  
**被审查代码**: 阶段X

## 审查发现

### 严重问题（必须修复）
1. 问题描述
   - 位置：文件路径，行号
   - 影响：... 
   - 建议：...

### 一般问题（建议修复）
1. 问题描述
   - 位置：...
   - 建议：...

### 建议改进
1. ...

## 审查结论
- [ ] 通过
- [ ] 有条件通过（需修复严重问题）
- [ ] 不通过（需全面修改）

## 修复验证
- [ ] 所有严重问题已修复
- [ ] 重新审查通过
```

---

## 6. 阶段锁定机制

### 6.1 锁定条件

阶段必须同时满足以下条件才能锁定：

1. ✅ 所有设计文档已归档
2. ✅ 所有测试用例100%通过
3. ✅ 代码审查已通过
4. ✅ 阶段总结文档已完成
5. ✅ **用户验收已通过**（最关键！）

### 6.2 锁定操作

```bash
# 1. 打Git标签
git tag -a v0.X.0-phaseN -m "阶段N完成并锁定"

# 2. 推送标签
git push origin v0.X.0-phaseN

# 3. 创建阶段归档目录
mkdir -p docs/阶段归档/阶段N-阶段名称
cp 阶段N-*.md docs/阶段归档/阶段N-阶段名称/

# 4. 在阶段跟踪表中更新状态
```

### 6.3 锁定后规则

**严禁**:
- ❌ 修改已锁定阶段的代码
- ❌ 在已锁定阶段新增功能
- ❌ 覆盖阶段标签

**如需修改必须**:
1. 走"补丁流程"（见6.4）
2. 或进入下一阶段统一处理

### 6.4 补丁流程（Hotfix）

如果发现已锁定阶段有严重bug必须修复：

```
1. 发起补丁申请
   └─ 说明bug影响、修复方案
   
2. 用户批准
   └─ 确认需要修复
   
3. 创建补丁分支
   └─ git checkout -b hotfix/阶段N-修复描述
   
4. 修复并测试
   └─ 必须补充测试用例
   
5. 代码审查
   └─ 审查修复代码
   
6. 用户验收
   └─ 确认修复有效
   
7. 合并补丁
   └─ git merge + 新标签 v0.X.1-phaseN
   
8. 更新补丁记录
```

---

## 7. 阶段跟踪与监控

### 7.1 阶段跟踪表

**文件名**: `阶段跟踪表.md`（根目录下，实时更新）

```markdown
# OmniAgentAst. 阶段跟踪表

**最后更新**: YYYY-MM-DD HH:MM:SS

| 阶段 | 阶段名称 | 状态 | 设计文档 | 测试报告 | 阶段总结 | 锁定标签 | 验收人 |
|------|---------|------|---------|---------|---------|---------|--------|
| 1.0 | 项目骨架搭建 | ✅已锁定 | [链接] | [链接] | [链接] | v0.1.0-phase1 | XXX |
| 1.1 | GLM基础对话 | 🟡进行中 | [链接] | - | - | - | - |
| 1.2 | 流式响应 | ⏸️待启动 | - | - | - | - | - |
| 1.3 | 工具框架 | ⏸️待启动 | - | - | - | - | - |
| 1.4 | P0工具集 | ⏸️待启动 | - | - | - | - | - |

## 统计信息
- 总阶段数：X
- 已完成：Y
- 进行中：Z
- 待启动：W
```

### 7.2 每日状态更新

**规则**: 每天结束工作前，更新阶段跟踪表

**更新内容**:
- 当前阶段进展百分比
- 遇到的问题
- 需要的支持

---

## 8. 违规处理

### 8.1 违规行为定义

| 违规行为 | 示例 | 处理措施 |
|---------|------|---------|
| **跳阶段开发** | 阶段1未完成就开始阶段2 | 立即停止，回退到上一阶段 |
| **无文档开发** | 直接写代码，后补文档 | 暂停开发，补全文档 |
| **无测试提交** | 功能代码无对应测试 | 拒绝合并，补充测试 |
| **验收未过强行锁定** | 用户未确认就标记完成 | 解锁，重新验收 |
| **修改已锁定阶段** | 直接在已锁定代码上修改 | 回滚，走补丁流程 |

### 8.2 违规记录

**文件名**: `违规记录-YYYY-MM-DD.md`

```markdown
# 违规记录

**日期**: YYYY-MM-DD  
**违规人**: AI助手（小欧）  
**违规类型**: 跳阶段开发

## 违规描述
- 阶段1.1未完成，提前开始阶段1.2开发
- 具体行为：...

## 处理措施
1. 立即停止阶段1.2工作
2. 删除阶段1.2代码（已Git备份）
3. 回到阶段1.1继续完善
4. 补全阶段1.1缺失的测试

## 预防措施
- 加强阶段状态检查
- 每天核对阶段跟踪表
- 用户提醒机制

## 用户确认
- [ ] 处理完成，确认接受
```

---

## 9. 附录

### 9.1 术语表

| 术语 | 定义 |
|------|------|
| **阶段** | 有明确目标、可验收的独立开发单元 |
| **锁定** | 阶段完成并归档，禁止修改 |
| **验收** | 用户确认阶段输出符合预期 |
| **覆盖率** | 测试代码覆盖的功能代码比例 |
| **补丁** | 对已锁定阶段的紧急修复 |

### 9.2 参考文档

- 《代码整洁之道》
- 《测试驱动开发》
- 《持续交付》

### 9.3 修订历史

| 版本 | 日期 | 修订人 | 修订内容 |
|------|------|--------|---------|
| v1.0 | 2026-02-15 | AI助手小欧 | 初始版本，制定开发策略规范 |

---

**文档结束**

**重要提醒**: 本文档是开发的"宪法"，所有参与开发的人员（包括AI助手）必须严格遵守。任何违反本规范的行为都将被记录并纠正。

**用户确认**:
- [ ] 已阅读全文
- [ ] 理解并同意所有条款
- [ ] 确认按此规范执行

**确认人**: _______________  
**确认日期**: YYYY-MM-DD
