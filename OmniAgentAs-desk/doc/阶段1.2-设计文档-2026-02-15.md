# 阶段1.2：AI模型接入 - 设计文档

**文档编号**: OMA-DESIGN-1.2  
**版本**: v1.0  
**创建时间**: 2026-02-15 23:40:00  
**阶段状态**: 待启动（等待设计文档批准）  
**关联文档**: 开发策略规范-v2.0、开发优先级计划

---

## 1. 阶段目标

### 1.1 要实现的功能
集成智谱GLM API，实现基础对话功能，让系统能够与AI模型进行交互。

### 1.2 解决的问题
- 提供AI对话能力
- 封装API调用细节
- 实现错误处理和重试机制
- 管理API Key（开发阶段）

### 1.3 预期效果
- 能够调用智谱GLM API进行对话
- 支持发送消息和接收回复
- 有基本的错误处理
- 前端能够展示对话内容

---

## 2. 技术方案

### 2.1 架构设计

```
┌─────────────────────────────────────────┐
│           前端 (React)                   │
│  ┌─────────────┐    ┌─────────────┐     │
│  │  对话界面    │◄──►│  消息组件   │     │
│  └──────┬──────┘    └─────────────┘     │
└─────────┼───────────────────────────────┘
          │ HTTP /api/v1/chat
┌─────────▼───────────────────────────────┐
│      后端 (FastAPI)                     │
│  ┌─────────────────┐                    │
│  │  Chat API路由    │                    │
│  │  /api/v1/chat   │                    │
│  └────────┬────────┘                    │
│           │                             │
│  ┌────────▼────────┐                   │
│  │  ZhipuAI服务    │                   │
│  │  - 封装API调用  │                   │
│  │  - 错误处理     │                   │
│  └────────┬────────┘                   │
└───────────┼─────────────────────────────┘
            │ HTTPS
┌───────────▼─────────────────────────────┐
│      智谱AI API (BigModel)              │
│         glm-4.7-flash                   │
└─────────────────────────────────────────┘
```

### 2.2 关键技术选型

| 组件 | 技术 | 说明 |
|------|------|------|
| AI模型 | 智谱GLM-4.7-flash | 免费、中文优化好 |
| HTTP客户端 | httpx | 异步支持、性能好 |
| API管理 | 配置文件 | 开发阶段使用明文配置 |

### 2.3 接口定义

#### 2.3.1 对话接口

```yaml
POST /api/v1/chat

Request:
  {
    "message": "string",      // 用户消息
    "history": [              // 可选：历史消息
      {"role": "user", "content": "..."},
      {"role": "assistant", "content": "..."}
    ]
  }

Response (200 OK):
  {
    "response": "string",     // AI回复
    "model": "glm-4.7-flash", // 使用的模型
    "timestamp": "2026-02-15T23:40:00Z"
  }

Response (Error):
  {
    "error": "错误描述",
    "code": "ERROR_CODE"
  }
```

### 2.4 项目结构

```
backend/
├── app/
│   ├── api/v1/
│   │   ├── health.py       # 已有
│   │   └── chat.py         # 新增：对话API
│   ├── services/
│   │   └── zhipuai.py      # 新增：智谱AI服务封装
│   └── config.py           # 新增：配置管理
├── config/
│   └── config.yaml         # 新增：配置文件（API Key等）
└── tests/
    └── test_chat.py        # 新增：对话测试
```

---

## 3. 验收标准（可验证！）

### 3.1 后端验收

- [ ] **AC001**: 能够成功调用智谱GLM API
  - 验证方法: 发送测试消息，收到有效回复
  - 通过标准: HTTP 200，response字段不为空

- [ ] **AC002**: 能够处理API错误
  - 验证方法: 使用无效API Key测试
  - 通过标准: 返回友好错误信息，不崩溃

- [ ] **AC003**: 支持上下文历史
  - 验证方法: 发送带history的请求
  - 通过标准: AI能参考历史消息回复

- [ ] **AC004**: 配置管理功能正常
  - 验证方法: 读取config.yaml中的API Key
  - 通过标准: 配置正确加载

### 3.2 集成验收

- [ ] **AC005**: 前端能够调用对话接口
  - 验证方法: 前端发送消息，显示AI回复
  - 通过标准: 对话流程完整

---

## 4. 风险与应对

| 风险 | 可能性 | 影响 | 应对方案 |
|------|--------|------|---------|
| 智谱API网络问题 | 中 | 高 | 实现重试机制（3次），超时设置（30s） |
| API Key泄露 | 低 | 高 | 开发阶段使用环境变量，文档提醒生产环境加密 |
| 响应时间过长 | 中 | 中 | 添加加载状态，超时处理 |

---

## 5. 参考资料

- [开发策略规范-v2.0](../doc/开发策略规范-v2.0.md) - 第11.1节
- [开发优先级计划](../doc/开发优先级计划.md) - 第1.2节
- 智谱AI文档: https://open.bigmodel.cn/

---

## 6. 设计评审记录

### 评审人
- [ ] 用户确认

### 评审意见
（待填写）

### 批准状态
- [ ] 批准（可以开始编码）
- [ ] 有条件批准（需修改后重新评审）
- [ ] 不批准（需重新设计）

**批准人**: _______________  
**批准日期**: _______________

---

**重要提示**: 本设计文档必须经用户批准后，才能开始阶段1.2的编码工作。
