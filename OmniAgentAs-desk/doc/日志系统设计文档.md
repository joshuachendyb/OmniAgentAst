# OmniAgentAst 日志系统设计文档

**版本**: v1.0  
**创建时间**: 2026-02-16  
**设计原则**: 全面、可配置、易监控、生产就绪

---

## 一、设计目标

### 1.1 核心目标
1. **全面记录**: 所有关键操作和错误都自动记录，无需人工粘贴
2. **分级管理**: 支持DEBUG/INFO/WARNING/ERROR/CRITICAL五级日志
3. **分类存储**: 按功能模块分类存储（API请求、系统错误、业务逻辑）
4. **自动轮转**: 按日期和大小自动轮转，防止日志文件过大
5. **生产就绪**: 支持debug模式和生产模式的不同配置

### 1.2 使用场景
- **开发调试**: 详细日志帮助定位问题
- **生产监控**: 错误日志及时告警
- **故障排查**: 历史日志追溯问题根因
- **性能分析**: 请求耗时统计分析

---

## 二、日志分类设计

### 2.1 按功能分类

```
logs/
├── app_2026-02-16.log          # 主应用日志
├── api_requests_2026-02-16.log # API请求/响应日志
├── errors_2026-02-16.log       # 错误日志（ERROR级别以上）
└── audit_2026-02-16.log        # 审计日志（重要操作）
```

### 2.2 按级别分类

| 级别 | 值 | 使用场景 | 生产环境 |
|------|-----|---------|---------|
| DEBUG | 10 | 调试信息、详细流程 | 不记录 |
| INFO | 20 | 正常流程、关键操作 | 记录 |
| WARNING | 30 | 警告、异常情况 | 记录 |
| ERROR | 40 | 错误、异常 | 记录 |
| CRITICAL | 50 | 严重错误、系统故障 | 记录+告警 |

---

## 三、配置设计

### 3.1 配置项（config.yaml）

```yaml
# 日志配置
logging:
  # 日志级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
  level: "INFO"
  
  # 是否开启调试模式（详细日志）
  debug: false
  
  # 文件配置
  file:
    # 日志目录
    directory: "logs"
    # 单个文件最大大小（MB）
    max_size: 10
    # 备份文件数量
    backup_count: 5
    # 是否按日期分割
    rotate_by_date: true
  
  # 控制台输出
  console:
    # 是否输出到控制台
    enabled: true
    # 控制台日志级别（通常比文件高）
    level: "WARNING"
  
  # 格式配置
  format:
    # 是否包含时间戳
    timestamp: true
    # 是否包含文件名和行号
    location: false
    # 是否包含进程ID
    process_id: false
```

### 3.2 模式差异

**Debug模式** (`debug: true`):
- 日志级别: DEBUG
- 详细格式: 包含文件名、行号、函数名
- 控制台输出: 所有级别
- 请求/响应详情: 记录完整内容（脱敏）

**生产模式** (`debug: false`):
- 日志级别: INFO
- 简洁格式: 时间、级别、消息
- 控制台输出: WARNING及以上
- 请求/响应详情: 仅记录摘要

---

## 四、日志内容规范

### 4.1 API请求日志

**格式**:
```
[时间] [INFO] [API] 请求开始 | 提供商: zhipuai | 模型: glm-4.7-flash | 消息长度: 100 | 历史消息数: 5
[时间] [INFO] [API] 请求完成 | 提供商: zhipuai | 状态码: 200 | 响应长度: 500 | 耗时: 2.5s
[时间] [ERROR] [API] 请求失败 | 提供商: zhipuai | 错误: 请求超时 | 耗时: 60s
```

**包含字段**:
- 提供商名称
- 模型名称
- 请求时间
- 消息长度
- 历史消息数
- 响应状态码
- 响应内容长度
- 请求耗时
- 错误信息

### 4.2 系统错误日志

**格式**:
```
[时间] [ERROR] [System] 数据库连接失败 | 错误: Connection refused | 重试次数: 3
[时间] [CRITICAL] [System] 配置文件加载失败 | 错误: File not found | 退出程序
```

**包含字段**:
- 错误类型
- 错误消息
- 堆栈跟踪（debug模式）
- 重试次数
- 影响范围

### 4.3 业务审计日志

**格式**:
```
[时间] [INFO] [Audit] 用户切换提供商 | 从: zhipuai | 到: opencode | 结果: 成功
[时间] [INFO] [Audit] 配置更新 | 文件: config.yaml | 修改项: provider
```

**包含字段**:
- 操作类型
- 操作对象
- 操作结果
- 修改前后值
- 操作时间

---

## 五、安全考虑

### 5.1 敏感信息脱敏

**必须脱敏的内容**:
- API Key: 只显示前8位，如 `sk-123456...`
- 用户消息: 生产环境不记录完整内容
- 响应内容: 只记录长度，不记录内容
- 配置文件路径: 使用相对路径

**脱敏示例**:
```python
# 脱敏API Key
def mask_api_key(key: str) -> str:
    if len(key) > 10:
        return f"{key[:8]}..."
    return "***"
```

### 5.2 日志文件权限

- 日志文件权限: 640 (rw-r-----)
- 日志目录权限: 750 (rwxr-x---)
- 禁止其他用户读取

---

## 六、性能优化

### 6.1 异步写入

- 使用异步日志处理器
- 避免阻塞主线程
- 批量写入减少IO

### 6.2 缓冲机制

- 设置缓冲区大小（如100条）
- 定时刷新（如5秒）
- 程序退出时强制刷新

### 6.3 日志过滤

- 生产环境过滤DEBUG日志
- 按提供商过滤（只记录特定提供商）
- 按错误类型过滤

---

## 七、监控和告警

### 7.1 关键指标监控

- 错误率: ERROR日志数 / 总请求数
- 响应时间: 平均/最大响应时间
- 超时率: 超时请求数 / 总请求数
- 提供商可用性: 各提供商成功率

### 7.2 告警规则

- **CRITICAL级别**: 立即告警（短信/邮件）
- **ERROR级别**: 5分钟内超过10条告警
- **超时率**: 超过20%告警
- **连续失败**: 同一提供商连续5次失败告警

---

## 八、实现计划

### 8.1 第一阶段：基础功能
- [x] 日志模块基础框架
- [x] 配置文件读取
- [ ] API请求/响应日志
- [ ] 错误日志记录

### 8.2 第二阶段：完善功能
- [ ] 日志轮转和归档
- [ ] 脱敏处理
- [ ] 性能优化
- [ ] 审计日志

### 8.3 第三阶段：高级功能
- [ ] 日志分析工具
- [ ] 监控告警
- [ ] 可视化面板
- [ ] 日志导出

---

## 九、使用示例

### 9.1 在AI服务中使用

```python
from app.utils.logger import api_logger

class ZhipuAIService(BaseAIService):
    async def chat(self, message: str, history=None):
        # 记录请求
        api_logger.log_request(
            provider="zhipuai",
            model=self.model,
            message_len=len(message),
            history_count=len(history) if history else 0
        )
        
        try:
            # 发送请求...
            response = await self.client.post(...)
            
            # 记录响应
            api_logger.log_response(
                provider="zhipuai",
                status_code=response.status_code,
                content_len=len(content)
            )
            
        except TimeoutException:
            api_logger.log_timeout("zhipuai", timeout=60)
```

### 9.2 查看日志

```bash
# 查看最新日志
tail -f logs/app_2026-02-16.log

# 查看错误日志
tail -f logs/errors_2026-02-16.log

# 查看特定提供商日志
grep "zhipuai" logs/api_requests_2026-02-16.log

# 统计错误数量
grep "ERROR" logs/app_2026-02-16.log | wc -l
```

---

## 十、总结

本日志系统设计目标：
1. **无需人工干预** - 所有错误自动记录
2. **易于排查** - 详细上下文信息
3. **生产安全** - 敏感信息脱敏
4. **性能友好** - 异步写入，不影响主流程
5. **可扩展** - 模块化设计，易于扩展

**下一步行动**:
1. 更新config.yaml添加日志配置
2. 实现日志模块核心功能
3. 集成到AI服务中
4. 测试验证日志记录

---

**文档版本**: v1.0  
**更新人**: AI开发助手  
**更新时间**: 2026-02-16
