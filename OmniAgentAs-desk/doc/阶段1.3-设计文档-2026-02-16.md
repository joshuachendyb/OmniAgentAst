# Phase 1.3: ReAct æ‰§è¡Œå™¨å®ç° - è®¾è®¡æ–‡æ¡£

**æ–‡æ¡£ç¼–å·**: OMA-DESIGN-103  
**é˜¶æ®µ**: 1.3  
**é˜¶æ®µåç§°**: ReAct æ‰§è¡Œå™¨å®ç°ï¼ˆæ ¸å¿ƒï¼‰  
**åˆ›å»ºæ—¶é—´**: 2026-02-16 09:17:14  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.4  
**è®¾è®¡çŠ¶æ€**: ğŸŸ¡ å¾…æ‰¹å‡†  

---

## 1. é˜¶æ®µç›®æ ‡

### 1.1 æ€»ä½“ç›®æ ‡
å®ç° OmniAgentAst çš„æ ¸å¿ƒæ™ºèƒ½æ‰§è¡Œå¼•æ“â€”â€”**ReAct (Reasoning + Acting) å¾ªç¯**ï¼Œä½¿ Agent å…·å¤‡è‡ªä¸»æ€è€ƒå’Œæ‰§è¡Œèƒ½åŠ›ã€‚

### 1.2 å…·ä½“ç›®æ ‡
1. **å·¥å…·æ¡†æ¶**: å»ºç«‹å¯æ‰©å±•çš„å·¥å…·å®šä¹‰å’Œæ³¨å†Œæœºåˆ¶
2. **P0 å·¥å…·é›†**: å®ç° 4 ä¸ªåŸºç¡€æ–‡ä»¶æ“ä½œå·¥å…·
3. **ReAct å¾ªç¯**: å®ç° æ€è€ƒâ†’è¡ŒåŠ¨â†’è§‚å¯Ÿ çš„å®Œæ•´é—­ç¯
4. **é”™è¯¯æ¢å¤**: å®ç° 3 æ¬¡é‡è¯•æœºåˆ¶å’ŒåŸºç¡€é”™è¯¯å¤„ç†

### 1.3 ä¸ Phase 1.2 çš„å…³ç³»
```
Phase 1.2 (AIæ¨¡å‹æ¥å…¥) â†’ Phase 1.3 (ReActæ‰§è¡Œå™¨) â†’ Phase 1.4 (å¯¹è¯ç•Œé¢)
      æä¾›AIèƒ½åŠ›            å®ç°æ™ºèƒ½æ‰§è¡Œ               æä¾›ç”¨æˆ·äº¤äº’
```

---

## 2. æŠ€æœ¯æ–¹æ¡ˆ

### 2.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ReAct æ‰§è¡Œå™¨æ¶æ„                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Thought   â”‚ --> â”‚   Action    â”‚ --> â”‚Observation â”‚   â”‚
â”‚  â”‚   (æ€è€ƒ)    â”‚     â”‚   (è¡ŒåŠ¨)    â”‚     â”‚  (è§‚å¯Ÿ)     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â†‘                                            â”‚      â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                          (åé¦ˆå¾ªç¯)                          â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    å·¥å…·å±‚ (Tool Layer)               â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚read_file â”‚ â”‚write_fileâ”‚ â”‚list_dir  â”‚ â”‚move_file â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒç»„ä»¶

#### 2.2.1 å·¥å…·å®šä¹‰ Schema

æ¯ä¸ªå·¥å…·å¿…é¡»éµå¾ªä»¥ä¸‹ Schemaï¼š

```python
{
    "name": "å·¥å…·åç§°",                    # å¿…é¡»æ˜¯è‹±æ–‡ï¼Œä¸‹åˆ’çº¿åˆ†éš”
    "description": "åŠŸèƒ½æè¿°",              # ç»™ AI çœ‹çš„æè¿°
    "parameters": {
        "param1": {
            "type": "string",              # å‚æ•°ç±»å‹
            "description": "å‚æ•°æè¿°",      # å‚æ•°è¯´æ˜
            "required": True,              # æ˜¯å¦å¿…éœ€
            "default": None                # é»˜è®¤å€¼
        }
    },
    "returns": {
        "type": "object",
        "description": "è¿”å›ç»“æœè¯´æ˜"
    },
    "danger_level": "low|medium|high",     # é£é™©ç­‰çº§
    "examples": [                          # ä½¿ç”¨ç¤ºä¾‹
        {
            "input": {"path": "/tmp/test.txt"},
            "output": {"content": "æ–‡ä»¶å†…å®¹...", "success": True}
        }
    ]
}
```

#### 2.2.2 å·¥å…·åŸºç±»è®¾è®¡

```python
# app/tools/base.py
from abc import ABC, abstractmethod
from typing import Any, Dict, Optional
from pydantic import BaseModel, Field

class ToolParameter(BaseModel):
    """å·¥å…·å‚æ•°å®šä¹‰"""
    type: str
    description: str
    required: bool = True
    default: Optional[Any] = None

class ToolDefinition(BaseModel):
    """å·¥å…·å®šä¹‰Schema"""
    name: str
    description: str
    parameters: Dict[str, ToolParameter]
    returns: Dict[str, Any]
    danger_level: str = "low"  # low, medium, high
    examples: list = []

class ToolResult(BaseModel):
    """å·¥å…·æ‰§è¡Œç»“æœ"""
    success: bool
    data: Optional[Any] = None
    error: Optional[str] = None
    execution_time: float = 0.0

class BaseTool(ABC):
    """å·¥å…·åŸºç±»"""
    
    def __init__(self):
        self.definition = self._get_definition()
    
    @abstractmethod
    def _get_definition(self) -> ToolDefinition:
        """è¿”å›å·¥å…·å®šä¹‰"""
        pass
    
    @abstractmethod
    async def execute(self, **kwargs) -> ToolResult:
        """æ‰§è¡Œå·¥å…·"""
        pass
    
    def validate_params(self, params: Dict[str, Any]) -> bool:
        """éªŒè¯å‚æ•°æ˜¯å¦åˆæ³•"""
        # æ£€æŸ¥å¿…éœ€å‚æ•°
        for name, param in self.definition.parameters.items():
            if param.required and name not in params:
                return False
        return True
```

#### 2.2.3 P0 å·¥å…·å®ç°æ¸…å•

| å·¥å…· | åŠŸèƒ½ | é£é™©ç­‰çº§ | å…³é”®å‚æ•° | è¿”å›å€¼ |
|------|------|---------|---------|--------|
| **read_file** | è¯»å–æ–‡ä»¶å†…å®¹ | ğŸŸ¢ low | path: æ–‡ä»¶è·¯å¾„ | content: æ–‡ä»¶å†…å®¹ |
| **write_file** | å†™å…¥/åˆ›å»ºæ–‡ä»¶ | ğŸŸ¡ medium | path, content, mode | success: æ˜¯å¦æˆåŠŸ |
| **list_directory** | åˆ—å‡ºç›®å½•å†…å®¹ | ğŸŸ¢ low | path, recursive | files: æ–‡ä»¶åˆ—è¡¨ |
| **move_file** | ç§»åŠ¨/é‡å‘½å | ğŸŸ¡ medium | source, destination | success: æ˜¯å¦æˆåŠŸ |

#### 2.2.4 ReAct å¾ªç¯æ ¸å¿ƒ

```python
# app/core/react_executor.py
from typing import List, Dict, Any, Optional
import json

class ReActExecutor:
    """ReAct æ‰§è¡Œå™¨ï¼šæ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿå¾ªç¯"""
    
    def __init__(self, ai_service, tool_registry):
        self.ai = ai_service
        self.tools = tool_registry
        self.max_iterations = 10  # æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œé˜²æ­¢æ­»å¾ªç¯
        self.retry_attempts = 3   # é”™è¯¯é‡è¯•æ¬¡æ•°
    
    async def execute(self, user_input: str, history: List[Dict] = None) -> Dict[str, Any]:
        """
        æ‰§è¡Œ ReAct å¾ªç¯
        
        Args:
            user_input: ç”¨æˆ·è¾“å…¥
            history: å†å²æ¶ˆæ¯
            
        Returns:
            æ‰§è¡Œç»“æœ
        """
        iterations = 0
        context = {
            "user_input": user_input,
            "thoughts": [],
            "actions": [],
            "observations": []
        }
        
        while iterations < self.max_iterations:
            iterations += 1
            
            # Step 1: Thought (æ€è€ƒ)
            thought = await self._think(context, history)
            context["thoughts"].append(thought)
            
            # æ£€æŸ¥æ˜¯å¦åº”è¯¥ç»“æŸ
            if thought.get("should_stop", False):
                return {
                    "success": True,
                    "answer": thought.get("answer", ""),
                    "context": context
                }
            
            # Step 2: Action (è¡ŒåŠ¨)
            action = thought.get("action")
            if not action:
                continue
                
            context["actions"].append(action)
            
            # Step 3: Observation (è§‚å¯Ÿ)
            observation = await self._act(action)
            context["observations"].append(observation)
            
            # å¦‚æœæ‰§è¡Œå¤±è´¥ï¼Œå°è¯•é‡è¯•
            if not observation.get("success", False):
                for attempt in range(self.retry_attempts):
                    retry_observation = await self._retry_action(action, observation, attempt)
                    if retry_observation.get("success", False):
                        observation = retry_observation
                        break
        
        # è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œå¼ºåˆ¶ç»“æŸ
        return {
            "success": False,
            "error": "è¾¾åˆ°æœ€å¤§è¿­ä»£æ¬¡æ•°",
            "context": context
        }
    
    async def _think(self, context: Dict, history: List[Dict]) -> Dict:
        """
        æ€è€ƒé˜¶æ®µï¼šè°ƒç”¨ AI å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨
        
        è¿”å›æ ¼å¼ï¼š
        {
            "thought": "æ€è€ƒè¿‡ç¨‹...",
            "action": {"tool": "tool_name", "params": {...}},
            "should_stop": false,
            "answer": ""  # åªæœ‰åœ¨ should_stop=true æ—¶æ‰æœ‰å€¼
        }
        """
        # æ„å»º prompt
        prompt = self._build_think_prompt(context, history)
        
        # è°ƒç”¨ AI
        response = await self.ai.chat(prompt)
        
        # è§£æå“åº”
        return self._parse_thought_response(response)
    
    async def _act(self, action: Dict) -> Dict:
        """
        è¡ŒåŠ¨é˜¶æ®µï¼šæ‰§è¡Œå·¥å…·
        
        Args:
            action: {"tool": "tool_name", "params": {...}}
        """
        tool_name = action.get("tool")
        params = action.get("params", {})
        
        # æŸ¥æ‰¾å·¥å…·
        tool = self.tools.get(tool_name)
        if not tool:
            return {
                "success": False,
                "error": f"æœªçŸ¥å·¥å…·: {tool_name}"
            }
        
        # æ‰§è¡Œå·¥å…·
        try:
            result = await tool.execute(**params)
            return {
                "success": result.success,
                "data": result.data,
                "error": result.error
            }
        except Exception as e:
            return {
                "success": False,
                "error": str(e)
            }
    
    async def _retry_action(self, action: Dict, last_error: Dict, attempt: int) -> Dict:
        """é‡è¯•å¤±è´¥çš„è¡ŒåŠ¨"""
        # å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é‡è¯•é€»è¾‘ï¼Œæ¯”å¦‚ä¿®æ”¹å‚æ•°ã€æ¢ç”¨å…¶ä»–å·¥å…·ç­‰
        return await self._act(action)
    
    def _build_think_prompt(self, context: Dict, history: List[Dict]) -> str:
        """æ„å»ºæ€è€ƒé˜¶æ®µçš„ prompt"""
        tools_desc = self.tools.get_tools_description()
        
        prompt = f"""ä½ æ˜¯ä¸€ä¸ªæ™ºèƒ½åŠ©æ‰‹ï¼Œéœ€è¦æ ¹æ®ç”¨æˆ·è¾“å…¥å’Œä¸Šä¸‹æ–‡å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ã€‚

å¯ç”¨å·¥å…·ï¼š
{tools_desc}

ç”¨æˆ·è¾“å…¥ï¼š{context['user_input']}

å†å²æ€è€ƒï¼š
{self._format_thoughts(context['thoughts'])}

å†å²è¡ŒåŠ¨ï¼š
{self._format_actions(context['actions'])}

å†å²è§‚å¯Ÿï¼š
{self._format_observations(context['observations'])}

è¯·å†³å®šä¸‹ä¸€æ­¥ï¼š
1. å¦‚æœä»»åŠ¡å·²å®Œæˆï¼Œè¾“å‡ºæœ€ç»ˆç­”æ¡ˆ
2. å¦‚æœéœ€è¦ä½¿ç”¨å·¥å…·ï¼Œè¾“å‡ºå·¥å…·è°ƒç”¨

è¯·æŒ‰ä»¥ä¸‹æ ¼å¼å“åº”ï¼š
{{
    "thought": "ä½ çš„æ€è€ƒè¿‡ç¨‹",
    "action": {{"tool": "å·¥å…·å", "params": {{"å‚æ•°å": "å‚æ•°å€¼"}}}},
    "should_stop": false,
    "answer": ""
}}
"""
        return prompt
```

### 2.3 å·¥å…·æ³¨å†Œæœºåˆ¶

```python
# app/tools/registry.py
from typing import Dict, Type
from .base import BaseTool

class ToolRegistry:
    """å·¥å…·æ³¨å†Œè¡¨"""
    
    _tools: Dict[str, BaseTool] = {}
    
    @classmethod
    def register(cls, tool_instance: BaseTool):
        """æ³¨å†Œå·¥å…·"""
        name = tool_instance.definition.name
        cls._tools[name] = tool_instance
        print(f"[ToolRegistry] æ³¨å†Œå·¥å…·: {name}")
    
    @classmethod
    def get(cls, name: str) -> BaseTool:
        """è·å–å·¥å…·"""
        return cls._tools.get(name)
    
    @classmethod
    def list_tools(cls) -> list:
        """åˆ—å‡ºæ‰€æœ‰å·¥å…·"""
        return list(cls._tools.keys())
    
    @classmethod
    def get_tools_description(cls) -> str:
        """è·å–æ‰€æœ‰å·¥å…·çš„æè¿°ï¼ˆç”¨äº promptï¼‰"""
        descriptions = []
        for name, tool in cls._tools.items():
            desc = f"- {name}: {tool.definition.description}"
            descriptions.append(desc)
        return "\n".join(descriptions)

# æ³¨å†Œè£…é¥°å™¨
def register_tool():
    """å·¥å…·æ³¨å†Œè£…é¥°å™¨"""
    def decorator(tool_class: Type[BaseTool]):
        instance = tool_class()
        ToolRegistry.register(instance)
        return tool_class
    return decorator
```

---

## 2.3 Windows å‘½ä»¤æ‰§è¡Œè§„åˆ™ï¼ˆåŸºäºå®é™…æµ‹è¯•ï¼‰

> **å‚è€ƒæ–‡æ¡£**: ã€ŠWindowså‘½ä»¤ä½¿ç”¨è§„åˆ™ä¸æµ‹è¯•æŠ¥å‘Š.mdã€‹  
> **æ ¸å¿ƒåŸåˆ™**: ä¸å‡è®¾ç›®æ ‡æœºå™¨æœ‰ Git Bashï¼Œä¼˜å…ˆä½¿ç”¨ Python æ ‡å‡†åº“

**æœ¬ç« ä½ç½®è°ƒæ•´è¯´æ˜**: åŸ 2.5 ç« è°ƒæ•´ä¸º 2.3 ç« ï¼Œä¿æŒç« èŠ‚é¡ºåºè¿ç»­æ€§ï¼ˆv1.2 ä¿®æ­£ï¼‰

### 2.3.1 æ‰§è¡Œç¯å¢ƒå‡è®¾

| ç¯å¢ƒ | å‡è®¾ | è¯´æ˜ |
|------|------|------|
| Git Bash | âŒ ä¸å¯ç”¨ | ç›®æ ‡æœºå™¨å¯èƒ½æœªå®‰è£… Git |
| WSL | âŒ ä¸å¯ç”¨ | ä¸ªäººç‰ˆä¸ä¾èµ– Linux å­ç³»ç»Ÿ |
| PowerShell | âœ… å¯ç”¨ | Windows 7+ é»˜è®¤å®‰è£… |
| CMD | âœ… å¯ç”¨ | æ‰€æœ‰ Windows ç‰ˆæœ¬éƒ½æœ‰ |
| Python | âœ… å¯ç”¨ | ä½œä¸ºåº”ç”¨è¿è¡Œæ—¶ç¯å¢ƒ |

### 2.3.2 å‘½ä»¤é€‰æ‹©ä¼˜å…ˆçº§ï¼ˆç»æµ‹è¯•éªŒè¯ï¼‰

```
1. Python æ ‡å‡†åº“ (é¦–é€‰)  â† è·¨å¹³å°ï¼Œæ— ç¼–ç é—®é¢˜
2. PowerShell (æ¬¡é€‰)    â† Windows åŸç”Ÿï¼ŒåŠŸèƒ½å¼ºå¤§
3. CMD (å¤‡é€‰)          â† å…¼å®¹æ€§æœ€å¥½ï¼Œä½†åŠŸèƒ½æœ‰é™
4. å¤–éƒ¨å·¥å…· (é¿å…)      â† å¢åŠ ä¾èµ–ï¼Œä¸ç¨³å®š
```

### 2.3.3 ç»è¿‡æµ‹è¯•éªŒè¯çš„å‘½ä»¤å¯¹ç…§è¡¨

| åŠŸèƒ½ | Python å®ç° (âœ… æ¨è) | PowerShell å®ç° | CMD å®ç° |
|------|---------------------|----------------|---------|
| **åˆ—å‡ºç›®å½•** | `Path.iterdir()` | `Get-ChildItem` | `dir /b` |
| **è¯»å–æ–‡ä»¶** | `Path.read_text(encoding='utf-8')` | `Get-Content -Encoding UTF8` | `type` |
| **å†™å…¥æ–‡ä»¶** | `Path.write_text(content, encoding='utf-8')` | `Set-Content -Encoding UTF8` | `echo >` |
| **åˆ›å»ºç›®å½•** | `Path.mkdir(parents=True)` | `New-Item -ItemType Directory` | `mkdir` |
| **åˆ é™¤æ–‡ä»¶** | `Path.unlink()` | `Remove-Item` | `del` |
| **ç§»åŠ¨æ–‡ä»¶** | `shutil.move()` | `Move-Item` | `move` |
| **å¤åˆ¶æ–‡ä»¶** | `shutil.copy2()` | `Copy-Item` | `copy` |
| **æ£€æŸ¥å­˜åœ¨** | `Path.exists()` | `Test-Path` | `if exist` |

### 2.3.4 å…³é”®ç¼–ç è§„åˆ™

**å¿…é¡»æ˜¾å¼æŒ‡å®š UTF-8 ç¼–ç **ï¼š
```python
# âœ… æ­£ç¡® - æ˜¾å¼æŒ‡å®š UTF-8ï¼Œæ”¯æŒä¸­æ–‡
content = Path("æ–‡ä»¶.txt").read_text(encoding='utf-8')
Path("è¾“å‡º.txt").write_text("ä¸­æ–‡å†…å®¹", encoding='utf-8')

# PowerShell
Get-Content "æ–‡ä»¶.txt" -Encoding UTF8
Set-Content "è¾“å‡º.txt" -Value "ä¸­æ–‡" -Encoding UTF8
```

**è·¯å¾„ä½¿ç”¨åŸå§‹å­—ç¬¦ä¸²**ï¼š
```python
# âœ… æ­£ç¡® - åŸå§‹å­—ç¬¦ä¸²ï¼Œé¿å…è½¬ä¹‰é—®é¢˜
path = r"C:\Users\ç”¨æˆ·å\Documents\file.txt"

# âŒ é”™è¯¯ - éœ€è¦åŒåæ–œæ è½¬ä¹‰
path = "C:\\Users\\ç”¨æˆ·å\\Documents\\file.txt"
```

### 2.3.5 P0 å·¥å…·å®ç°è§„èŒƒï¼ˆåŸºäºæµ‹è¯•ç»“æœï¼‰

**æ‰€æœ‰ P0 å·¥å…·å¿…é¡»ä½¿ç”¨ Python æ ‡å‡†åº“å®ç°**ï¼ŒåŸå› ï¼š
1. âœ… è·¨å¹³å°å…¼å®¹ï¼ˆWindows/Mac/Linuxï¼‰
2. âœ… æ— ç¼–ç é—®é¢˜ï¼ˆPython 3 é»˜è®¤ UTF-8ï¼‰
3. âœ… æ— éœ€å¤–éƒ¨ä¾èµ–
4. âœ… å¼‚å¸¸å¤„ç†æ›´å®Œå–„

**read_file å®ç°ç¤ºä¾‹**ï¼š
```python
from pathlib import Path
from .base import BaseTool, ToolResult

class ReadFileTool(BaseTool):
    """è¯»å–æ–‡ä»¶å·¥å…· - ä½¿ç”¨ç»è¿‡æµ‹è¯•éªŒè¯çš„ Python æ–¹æ³•"""
    
    async def execute(self, path: str, encoding: str = "utf-8") -> ToolResult:
        try:
            file_path = Path(path)
            
            # éªŒè¯è·¯å¾„å­˜åœ¨
            if not file_path.exists():
                return ToolResult(success=False, error=f"æ–‡ä»¶ä¸å­˜åœ¨: {path}")
            
            # è¯»å–å†…å®¹ï¼ˆæµ‹è¯•éªŒè¯çš„æ–¹æ³•ï¼‰
            content = file_path.read_text(encoding=encoding)
            
            return ToolResult(success=True, data={"content": content})
            
        except UnicodeDecodeError:
            return ToolResult(success=False, error="æ–‡ä»¶ç¼–ç é”™è¯¯")
        except PermissionError:
            return ToolResult(success=False, error="æƒé™ä¸è¶³")
        except Exception as e:
            return ToolResult(success=False, error=str(e))
```

---

## 2.4 æ—¥å¿—ä¸å¯è§‚æµ‹æ€§è®¾è®¡ï¼ˆéµå¾ª v2.1 è§„èŒƒï¼‰

**æœ¬ç« ä½ç½®è°ƒæ•´è¯´æ˜**: åŸ 2.6 ç« è°ƒæ•´ä¸º 2.4 ç« ï¼Œä¿æŒç« èŠ‚é¡ºåºè¿ç»­æ€§ï¼ˆv1.2 ä¿®æ­£ï¼‰

> **å‚è€ƒè§„èŒƒ**: ã€Šå¼€å‘ç­–ç•¥è§„èŒƒ-v2.1.mdã€‹ç¬¬ 3.5 ç« 

### 2.4.1 ReAct æ‰§è¡Œå™¨æ—¥å¿—éœ€æ±‚

æ ¹æ® v2.1 æ—¥å¿—è®¾è®¡è§„èŒƒï¼ŒReAct æ‰§è¡Œå™¨å¿…é¡»è®°å½•ï¼š

| æ—¥å¿—ç±»å‹ | è®°å½•å†…å®¹ | çº§åˆ« | ç”¨é€” |
|---------|---------|------|------|
| **æ‰§è¡Œå¼€å§‹** | ç”¨æˆ·è¾“å…¥ã€åˆå§‹ä¸Šä¸‹æ–‡ | INFO | è¿½è¸ªæ‰§è¡Œæµç¨‹ |
| **æ€è€ƒè¿‡ç¨‹** | AI æ€è€ƒå†…å®¹ã€å†³ç­–ä¾æ® | DEBUG | è°ƒè¯•å†³ç­–é€»è¾‘ |
| **å·¥å…·è°ƒç”¨** | å·¥å…·åç§°ã€å‚æ•°ã€æ‰§è¡Œè€—æ—¶ | INFO | ç›‘æ§å·¥å…·ä½¿ç”¨ |
| **å·¥å…·ç»“æœ** | æˆåŠŸ/å¤±è´¥ã€è¿”å›å€¼ã€é”™è¯¯ | INFO/WARNING | è¿½è¸ªæ‰§è¡Œç»“æœ |
| **é‡è¯•è®°å½•** | é‡è¯•æ¬¡æ•°ã€å¤±è´¥åŸå›  | WARNING | ç›‘æ§ç¨³å®šæ€§ |
| **æ‰§è¡Œå®Œæˆ** | æ€»è€—æ—¶ã€æœ€ç»ˆç­”æ¡ˆ | INFO | ç»Ÿè®¡æ‰§è¡Œæ•ˆç‡ |
| **å¼‚å¸¸é”™è¯¯** | å¼‚å¸¸ç±»å‹ã€å †æ ˆ | ERROR | é—®é¢˜æ’æŸ¥ |

### 2.4.2 æ—¥å¿—é›†æˆè®¾è®¡

```python
# app/core/react_executor.py - æ—¥å¿—é›†æˆ
from app.utils.logger import api_logger
import time

class ReActExecutor:
    """ReAct æ‰§è¡Œå™¨ï¼ˆå«æ—¥å¿—è®°å½•ï¼‰"""
    
    async def execute(self, user_input: str, history: List[Dict] = None) -> Dict:
        # ç”Ÿæˆè¯·æ±‚ ID ç”¨äºå…¨é“¾è·¯è¿½è¸ª
        request_id = api_logger.log_request_start(
            provider="react_executor",
            model="react_loop",
            message_len=len(user_input),
            history_count=len(history) if history else 0
        )
        
        start_time = time.time()
        iterations = 0
        
        try:
            while iterations < self.max_iterations:
                iterations += 1
                
                # è®°å½•æ€è€ƒè¿‡ç¨‹
                self.logger.debug(f"[{request_id}] ç¬¬{iterations}è½®æ€è€ƒå¼€å§‹")
                thought = await self._think(context, history)
                self.logger.debug(f"[{request_id}] æ€è€ƒ: {thought.get('thought', '')[:100]}...")
                
                # æ£€æŸ¥æ˜¯å¦ç»“æŸ
                if thought.get("should_stop", False):
                    self.logger.info(f"[{request_id}] ä»»åŠ¡å®Œæˆï¼Œå…±{iterations}è½®")
                    break
                
                # è®°å½•å·¥å…·è°ƒç”¨
                action = thought.get("action")
                if action:
                    tool_name = action.get("tool")
                    self.logger.info(f"[{request_id}] è°ƒç”¨å·¥å…·: {tool_name}")
                    
                    # æ‰§è¡Œå·¥å…·
                    tool_start = time.time()
                    observation = await self._act(action)
                    tool_elapsed = time.time() - tool_start
                    
                    # è®°å½•å·¥å…·ç»“æœ
                    if observation.get("success"):
                        self.logger.info(
                            f"[{request_id}] å·¥å…·æ‰§è¡ŒæˆåŠŸ: {tool_name}, "
                            f"è€—æ—¶: {tool_elapsed:.2f}s"
                        )
                    else:
                        self.logger.warning(
                            f"[{request_id}] å·¥å…·æ‰§è¡Œå¤±è´¥: {tool_name}, "
                            f"é”™è¯¯: {observation.get('error', 'Unknown')}"
                        )
                        
                        # è®°å½•é‡è¯•
                        for attempt in range(self.retry_attempts):
                            self.logger.info(f"[{request_id}] ç¬¬{attempt+1}æ¬¡é‡è¯•...")
                            # ... é‡è¯•é€»è¾‘
            
            # è®°å½•æ‰§è¡Œå®Œæˆ
            total_elapsed = time.time() - start_time
            api_logger.log_response_with_time(
                request_id=request_id,
                provider="react_executor",
                status_code=200 if context.get("success") else 500,
                content_len=len(context.get("final_answer", "")),
                error=None if context.get("success") else context.get("error")
            )
            
            self.logger.info(
                f"[{request_id}] ReActæ‰§è¡Œå®Œæˆ, "
                f"æ€»è€—æ—¶: {total_elapsed:.2f}s, "
                f"è¿­ä»£æ¬¡æ•°: {iterations}"
            )
            
        except Exception as e:
            self.logger.exception(f"[{request_id}] ReActæ‰§è¡Œå¼‚å¸¸")
            api_logger.log_error("react_executor", str(e))
            raise
```

### 2.4.3 å·¥å…·æ‰§è¡Œæ—¥å¿—

**æ¯ä¸ªå·¥å…·å¿…é¡»è®°å½•**ï¼š
```python
# app/tools/file_tools.py - å·¥å…·æ—¥å¿—ç¤ºä¾‹
from app.utils.logger import api_logger

class ReadFileTool(BaseTool):
    async def execute(self, path: str, **kwargs) -> ToolResult:
        request_id = api_logger.log_request_start(
            provider="tool",
            model=self.definition.name,  # "read_file"
            message_len=len(path)
        )
        
        start_time = time.time()
        
        try:
            # ... æ‰§è¡Œé€»è¾‘
            result = ToolResult(success=True, data={...})
            
            api_logger.log_response_with_time(
                request_id=request_id,
                provider="tool",
                status_code=200,
                content_len=len(result.data.get("content", "")),
                error=None
            )
            
            return result
            
        except Exception as e:
            api_logger.log_response_with_time(
                request_id=request_id,
                provider="tool",
                status_code=500,
                error=str(e)
            )
            return ToolResult(success=False, error=str(e))
```

### 2.4.4 æ—¥å¿—æ–‡ä»¶ç»“æ„

æ‰§è¡Œåæ—¥å¿—ç¤ºä¾‹ï¼š
```log
2026-02-16 09:14:01,234 - INFO - [react_executor] è¯·æ±‚å¼€å§‹ | ID: a1b2c3d4 | æ¶ˆæ¯é•¿åº¦: 50 | å†å²æ¶ˆæ¯æ•°: 0
2026-02-16 09:14:01,567 - DEBUG - [a1b2c3d4] ç¬¬1è½®æ€è€ƒå¼€å§‹
2026-02-16 09:14:03,890 - DEBUG - [a1b2c3d4] æ€è€ƒ: ç”¨æˆ·è¦æ±‚è¯»å–æ–‡ä»¶ï¼Œæˆ‘éœ€è¦ä½¿ç”¨read_fileå·¥å…·...
2026-02-16 09:14:03,891 - INFO - [a1b2c3d4] è°ƒç”¨å·¥å…·: read_file
2026-02-16 09:14:03,892 - INFO - [tool] è¯·æ±‚å¼€å§‹ | ID: e5f6g7h8 | æ¨¡å‹: read_file | æ¶ˆæ¯é•¿åº¦: 20
2026-02-16 09:14:03,895 - INFO - [tool] å“åº”æˆåŠŸ | ID: e5f6g7h8 | çŠ¶æ€ç : 200 | å†…å®¹é•¿åº¦: 1024 | è€—æ—¶: 0.01s
2026-02-16 09:14:03,896 - INFO - [a1b2c3d4] å·¥å…·æ‰§è¡ŒæˆåŠŸ: read_file, è€—æ—¶: 0.01s
2026-02-16 09:14:04,123 - INFO - [react_executor] å“åº”æˆåŠŸ | ID: a1b2c3d4 | çŠ¶æ€ç : 200 | å†…å®¹é•¿åº¦: 150 | è€—æ—¶: 2.89s
```

---

## 3. æ•°æ®ç»“æ„è®¾è®¡

### 3.1 æ¶ˆæ¯å†å²

```python
# app/models/message.py
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

class Message(BaseModel):
    """æ¶ˆæ¯æ¨¡å‹"""
    role: str  # "user", "assistant", "system", "tool"
    content: str
    tool_calls: Optional[List[Dict]] = None
    tool_results: Optional[List[Dict]] = None
    timestamp: datetime = datetime.now()
```

### 3.2 æ‰§è¡Œä¸Šä¸‹æ–‡

```python
# app/models/execution.py
from pydantic import BaseModel
from typing import List, Dict, Any, Optional

class ExecutionContext(BaseModel):
    """æ‰§è¡Œä¸Šä¸‹æ–‡"""
    user_input: str
    thoughts: List[Dict] = []
    actions: List[Dict] = []
    observations: List[Dict] = []
    final_answer: Optional[str] = None
    success: bool = False
    error: Optional[str] = None
```

### 3.3 æ–‡ä»¶æ“ä½œå®‰å…¨è®¾è®¡ï¼ˆv1.3 æ–°å¢ï¼‰

> **è®¾è®¡ç†å¿µ**: æ–‡ä»¶æ“ä½œå¿…é¡»å¯è¿½æº¯ã€å¯å›é€€ã€å¯æ¢å¤ï¼Œå»ºç«‹ç”¨æˆ·ä¿¡ä»»

#### 3.3.1 ç”¨æˆ·å¯è§çš„æ“ä½œå†å²è®°å½•

**é—®é¢˜**: AI æ•´ç†æ–‡ä»¶å¤¹åï¼Œç”¨æˆ·éœ€è¦çŸ¥é“å…·ä½“åšäº†ä»€ä¹ˆæ“ä½œ

**è§£å†³æ–¹æ¡ˆ**: æ“ä½œå†å²è¡¨ï¼ˆç”¨æˆ·å¯æŸ¥çœ‹ï¼‰

```python
# app/models/operation_history.py
from pydantic import BaseModel
from typing import Optional, List
from datetime import datetime
from enum import Enum

class OperationType(str, Enum):
    """æ“ä½œç±»å‹"""
    READ = "read"           # è¯»å–ï¼ˆä½é£é™©ï¼‰
    WRITE = "write"         # å†™å…¥ï¼ˆä¸­é£é™©ï¼‰
    CREATE = "create"       # åˆ›å»ºï¼ˆä½é£é™©ï¼‰
    DELETE = "delete"       # åˆ é™¤ï¼ˆé«˜é£é™©ï¼‰
    MOVE = "move"           # ç§»åŠ¨ï¼ˆä¸­é£é™©ï¼‰
    COPY = "copy"           # å¤åˆ¶ï¼ˆä½é£é™©ï¼‰

class OperationStatus(str, Enum):
    """æ“ä½œçŠ¶æ€"""
    SUCCESS = "success"
    FAILED = "failed"
    ROLLED_BACK = "rolled_back"  # å·²å›é€€

class FileOperation(BaseModel):
    """æ–‡ä»¶æ“ä½œè®°å½•ï¼ˆç”¨æˆ·å¯è§ï¼‰"""
    id: str                          # æ“ä½œIDï¼ˆç”¨äºå›é€€ï¼‰
    timestamp: datetime              # æ“ä½œæ—¶é—´
    operation_type: OperationType    # æ“ä½œç±»å‹
    
    # æ–‡ä»¶ä¿¡æ¯
    source_path: str                 # æºæ–‡ä»¶è·¯å¾„
    destination_path: Optional[str] = None  # ç›®æ ‡è·¯å¾„ï¼ˆç§»åŠ¨/å¤åˆ¶ï¼‰
    
    # æ‰§è¡Œä¿¡æ¯
    status: OperationStatus          # æ‰§è¡ŒçŠ¶æ€
    success: bool                    # æ˜¯å¦æˆåŠŸ
    error_message: Optional[str] = None     # é”™è¯¯ä¿¡æ¯
    
    # ReAct ä¸Šä¸‹æ–‡
    execution_id: str                # æ‰€å±æ‰§è¡Œä¼šè¯ID
    iteration: int                   # ReAct è¿­ä»£æ¬¡æ•°
    
    # å›é€€ä¿¡æ¯
    can_rollback: bool               # æ˜¯å¦å¯å›é€€
    rollback_available_until: Optional[datetime] = None  # å›é€€æœ‰æ•ˆæœŸ

class OperationHistoryStore:
    """æ“ä½œå†å²å­˜å‚¨"""
    
    def __init__(self, db_path: str = "data/operation_history.db"):
        self.db_path = db_path
        self._init_db()
    
    def record_operation(self, operation: FileOperation) -> str:
        """è®°å½•æ“ä½œï¼Œè¿”å›æ“ä½œID"""
        # ä¿å­˜åˆ° SQLite
        pass
    
    def get_recent_operations(self, limit: int = 50) -> List[FileOperation]:
        """è·å–æœ€è¿‘çš„æ“ä½œå†å²ï¼ˆç”¨æˆ·æŸ¥çœ‹ï¼‰"""
        pass
    
    def get_operations_by_execution(self, execution_id: str) -> List[FileOperation]:
        """è·å–æŸæ¬¡ ReAct æ‰§è¡Œçš„æ‰€æœ‰æ“ä½œ"""
        pass
    
    def mark_rollbacked(self, operation_id: str) -> bool:
        """æ ‡è®°æ“ä½œå·²å›é€€"""
        pass
```

**ç”¨æˆ·ç•Œé¢å±•ç¤º**:
```
ğŸ“‹ æ“ä½œå†å²è®°å½•

ä¼šè¯: 2026-02-16 10:30:15
ä»»åŠ¡: æ•´ç†ä¸‹è½½æ–‡ä»¶å¤¹

æ“ä½œåˆ—è¡¨:
1. [âœ…] 10:30:16 - è¯»å– C:\Users\xxx\Downloads\file1.txt
2. [âœ…] 10:30:17 - ç§»åŠ¨ C:\Users\xxx\Downloads\doc.pdf â†’ C:\Users\xxx\Documents\doc.pdf
3. [âœ…] 10:30:18 - åˆ é™¤ C:\Users\xxx\Downloads\temp.exe
4. [âš ï¸] 10:30:19 - å†™å…¥ C:\Users\xxx\Downloads\summary.txt (å¤±è´¥: æƒé™ä¸è¶³)

[æŸ¥çœ‹è¯¦æƒ…] [æ’¤é”€æ“ä½œ] [å…¨éƒ¨å›é€€]
```

#### 3.3.2 åˆ é™¤æ–‡ä»¶å¤‡ä»½æœºåˆ¶ï¼ˆå›æ”¶ç«™ï¼‰

**é—®é¢˜**: ç”¨æˆ·è¯´"æ•´ç†ä¸‹è½½æ–‡ä»¶å¤¹"ï¼ŒAI åˆ é™¤äº†é‡è¦æ–‡ä»¶ï¼Œç”¨æˆ·æƒ³æ¢å¤

**è§£å†³æ–¹æ¡ˆ**: åˆ é™¤çš„æ–‡ä»¶å…ˆç§»åŠ¨åˆ°å¤‡ä»½ç›®å½•ï¼ˆç±»ä¼¼å›æ”¶ç«™ï¼‰

```python
# app/utils/recycle_bin.py
from pathlib import Path
import shutil
from datetime import datetime

class RecycleBin:
    """å›æ”¶ç«™ - åˆ é™¤æ–‡ä»¶å¤‡ä»½æœºåˆ¶"""
    
    def __init__(self, base_path: str = "data/recycle_bin"):
        self.base_path = Path(base_path)
        self.base_path.mkdir(parents=True, exist_ok=True)
        
        # æŒ‰æ—¥æœŸç»„ç»‡å¤‡ä»½
        self.current_session = datetime.now().strftime("%Y%m%d_%H%M%S")
        self.session_path = self.base_path / self.current_session
        self.session_path.mkdir(exist_ok=True)
    
    def backup_before_delete(self, original_path: str, operation_id: str) -> str:
        """
        åˆ é™¤å‰å¤‡ä»½æ–‡ä»¶
        
        Args:
            original_path: åŸæ–‡ä»¶è·¯å¾„
            operation_id: æ“ä½œIDï¼ˆç”¨äºåç»­æ¢å¤ï¼‰
            
        Returns:
            backup_path: å¤‡ä»½è·¯å¾„
        """
        original = Path(original_path)
        if not original.exists():
            raise FileNotFoundError(f"æ–‡ä»¶ä¸å­˜åœ¨: {original_path}")
        
        # åˆ›å»ºå¤‡ä»½ç›®å½•ç»“æ„
        backup_dir = self.session_path / operation_id
        backup_dir.mkdir(parents=True, exist_ok=True)
        
        # å¤‡ä»½æ–‡ä»¶
        backup_file = backup_dir / original.name
        if original.is_file():
            shutil.copy2(original, backup_file)
        elif original.is_dir():
            shutil.copytree(original, backup_file)
        
        # ä¿å­˜å…ƒæ•°æ®
        metadata = {
            "operation_id": operation_id,
            "original_path": str(original.absolute()),
            "backup_path": str(backup_file),
            "timestamp": datetime.now().isoformat(),
            "file_size": original.stat().st_size if original.is_file() else 0,
            "is_directory": original.is_dir()
        }
        
        # ä¿å­˜å…ƒæ•°æ®æ–‡ä»¶
        metadata_file = backup_dir / "metadata.json"
        import json
        with open(metadata_file, 'w', encoding='utf-8') as f:
            json.dump(metadata, f, ensure_ascii=False, indent=2)
        
        return str(backup_file)
    
    def restore(self, operation_id: str) -> str:
        """
        æ¢å¤åˆ é™¤çš„æ–‡ä»¶
        
        Args:
            operation_id: æ“ä½œID
            
        Returns:
            restored_path: æ¢å¤åçš„è·¯å¾„
        """
        backup_dir = self.session_path / operation_id
        metadata_file = backup_dir / "metadata.json"
        
        if not metadata_file.exists():
            raise FileNotFoundError(f"å¤‡ä»½ä¸å­˜åœ¨: {operation_id}")
        
        # è¯»å–å…ƒæ•°æ®
        import json
        with open(metadata_file, 'r', encoding='utf-8') as f:
            metadata = json.load(f)
        
        original_path = Path(metadata["original_path"])
        backup_path = Path(metadata["backup_path"])
        
        # æ¢å¤åˆ°åŸä½ç½®ï¼ˆå¦‚æœåŸä½ç½®å·²è¢«å ç”¨ï¼Œæ¢å¤åˆ°åŸä½ç½®_æ¢å¤æ—¶é—´ï¼‰
        if original_path.exists():
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            original_path = original_path.parent / f"{original_path.name}_ restored_{timestamp}"
        
        # æ¢å¤æ–‡ä»¶/ç›®å½•
        if backup_path.is_file():
            shutil.copy2(backup_path, original_path)
        elif backup_path.is_dir():
            shutil.copytree(backup_path, original_path)
        
        return str(original_path)
    
    def list_backups(self) -> List[dict]:
        """åˆ—å‡ºæ‰€æœ‰å¯æ¢å¤çš„å¤‡ä»½"""
        backups = []
        for session_dir in self.base_path.iterdir():
            if session_dir.is_dir():
                for backup_dir in session_dir.iterdir():
                    metadata_file = backup_dir / "metadata.json"
                    if metadata_file.exists():
                        import json
                        with open(metadata_file, 'r', encoding='utf-8') as f:
                            metadata = json.load(f)
                        backups.append(metadata)
        return backups
    
    def cleanup_old_backups(self, days: int = 30):
        """æ¸…ç†è¶…è¿‡æŒ‡å®šå¤©æ•°çš„å¤‡ä»½"""
        from datetime import timedelta
        cutoff = datetime.now() - timedelta(days=days)
        
        for session_dir in self.base_path.iterdir():
            if session_dir.is_dir():
                try:
                    session_time = datetime.strptime(session_dir.name, "%Y%m%d_%H%M%S")
                    if session_time < cutoff:
                        shutil.rmtree(session_dir)
                except ValueError:
                    continue
```

**delete_file å·¥å…·æ›´æ–°**:
```python
class DeleteFileTool(BaseTool):
    """åˆ é™¤æ–‡ä»¶å·¥å…· - å¸¦å›æ”¶ç«™å¤‡ä»½"""
    
    async def execute(self, path: str, **kwargs) -> ToolResult:
        from app.utils.recycle_bin import RecycleBin
        from app.models.operation_history import FileOperation, OperationType
        
        try:
            file_path = Path(path)
            
            # æ£€æŸ¥æ–‡ä»¶å­˜åœ¨
            if not file_path.exists():
                return ToolResult(success=False, error=f"æ–‡ä»¶ä¸å­˜åœ¨: {path}")
            
            # ç”Ÿæˆæ“ä½œID
            import uuid
            operation_id = str(uuid.uuid4())[:8]
            
            # å…ˆå¤‡ä»½åˆ°å›æ”¶ç«™
            recycle_bin = RecycleBin()
            backup_path = recycle_bin.backup_before_delete(path, operation_id)
            
            # è®°å½•æ“ä½œå†å²
            operation = FileOperation(
                id=operation_id,
                timestamp=datetime.now(),
                operation_type=OperationType.DELETE,
                source_path=path,
                status=OperationStatus.SUCCESS,
                success=True,
                can_rollback=True,
                rollback_available_until=datetime.now() + timedelta(days=30)
            )
            # ä¿å­˜åˆ°å†å²è®°å½•...
            
            # æ‰§è¡Œåˆ é™¤
            if file_path.is_file():
                file_path.unlink()
            elif file_path.is_dir():
                shutil.rmtree(file_path)
            
            return ToolResult(
                success=True,
                data={
                    "deleted_path": path,
                    "backup_path": backup_path,
                    "operation_id": operation_id,
                    "can_restore": True,
                    "restore_valid_until": "30å¤©å†…"
                }
            )
            
        except Exception as e:
            return ToolResult(success=False, error=str(e))
```

#### 3.3.3 ç§»åŠ¨æ–‡ä»¶æ˜ å°„è¡¨ï¼ˆè·¯å¾„è®°å½•ï¼‰

**é—®é¢˜**: ç”¨æˆ·è®© AI ç§»åŠ¨æ–‡ä»¶åï¼Œæƒ³å›é€€åˆ°åŸå§‹ä½ç½®ï¼Œæˆ–æŸ¥çœ‹æ–‡ä»¶åŸæ¥åœ¨å“ªé‡Œ

**è§£å†³æ–¹æ¡ˆ**: ç§»åŠ¨æ“ä½œæ˜ å°„è¡¨

```python
# app/models/file_mapping.py
from pydantic import BaseModel
from typing import Optional
from datetime import datetime

class FileMoveMapping(BaseModel):
    """æ–‡ä»¶ç§»åŠ¨æ˜ å°„è®°å½•"""
    operation_id: str           # æ“ä½œID
    timestamp: datetime         # ç§»åŠ¨æ—¶é—´
    
    # è·¯å¾„ä¿¡æ¯
    original_path: str          # åŸå§‹è·¯å¾„
    new_path: str               # æ–°è·¯å¾„
    
    # æ–‡ä»¶ä¿¡æ¯
    file_name: str              # æ–‡ä»¶å
    file_size: int              # æ–‡ä»¶å¤§å°
    is_directory: bool          # æ˜¯å¦æ˜¯ç›®å½•
    
    # çŠ¶æ€
    is_active: bool = True      # æ˜¯å¦ä»æœ‰æ•ˆï¼ˆæ˜¯å¦è¢«å†æ¬¡ç§»åŠ¨ï¼‰
    superseded_by: Optional[str] = None  # è¢«å“ªä¸ªæ“ä½œè¦†ç›–

class FileMappingRegistry:
    """æ–‡ä»¶æ˜ å°„æ³¨å†Œè¡¨"""
    
    def __init__(self, db_path: str = "data/file_mappings.db"):
        self.db_path = db_path
        self._init_db()
    
    def record_move(self, original_path: str, new_path: str, operation_id: str) -> FileMoveMapping:
        """è®°å½•æ–‡ä»¶ç§»åŠ¨"""
        import os
        
        mapping = FileMoveMapping(
            operation_id=operation_id,
            timestamp=datetime.now(),
            original_path=original_path,
            new_path=new_path,
            file_name=Path(original_path).name,
            file_size=Path(original_path).stat().st_size if Path(original_path).exists() else 0,
            is_directory=Path(original_path).is_dir()
        )
        
        # ä¿å­˜åˆ°æ•°æ®åº“
        # ...
        
        return mapping
    
    def get_current_location(self, original_path: str) -> Optional[str]:
        """
        è¿½è¸ªæ–‡ä»¶çš„å½“å‰ä½ç½®
        æ”¯æŒé“¾å¼ç§»åŠ¨ï¼šAâ†’Bâ†’Cï¼Œè¾“å…¥Aè¿”å›C
        """
        current_path = original_path
        
        while True:
            # æŸ¥è¯¢è¯¥è·¯å¾„è¢«ç§»åŠ¨åˆ°å“ªé‡Œ
            mapping = self._find_mapping_by_original(current_path)
            if not mapping or not mapping.is_active:
                break
            current_path = mapping.new_path
        
        return current_path if current_path != original_path else None
    
    def get_original_location(self, current_path: str) -> Optional[str]:
        """
        åå‘è¿½è¸ªæ–‡ä»¶çš„åŸå§‹ä½ç½®
        æ”¯æŒé“¾å¼ç§»åŠ¨ï¼šAâ†’Bâ†’Cï¼Œè¾“å…¥Cè¿”å›A
        """
        # ä»å½“å‰è·¯å¾„åå‘æŸ¥æ‰¾
        original = current_path
        
        while True:
            mapping = self._find_mapping_by_new(original)
            if not mapping:
                break
            original = mapping.original_path
        
        return original if original != current_path else None
    
    def rollback_move(self, operation_id: str) -> bool:
        """å›é€€æŸæ¬¡ç§»åŠ¨æ“ä½œ"""
        mapping = self._get_mapping(operation_id)
        if not mapping or not mapping.is_active:
            return False
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨æ–°ä½ç½®
        if not Path(mapping.new_path).exists():
            return False
        
        # æ£€æŸ¥åŸå§‹ä½ç½®æ˜¯å¦å¯ç”¨
        if Path(mapping.original_path).exists():
            # åŸå§‹ä½ç½®è¢«å ç”¨ï¼Œæ¢å¤åˆ°åŸä½ç½®_å›é€€æ—¶é—´
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            rollback_path = Path(mapping.original_path).parent / f"{Path(mapping.original_path).name}_rolledback_{timestamp}"
        else:
            rollback_path = mapping.original_path
        
        # æ‰§è¡Œç§»åŠ¨ï¼ˆåå‘ï¼‰
        shutil.move(mapping.new_path, rollback_path)
        
        # æ ‡è®°æ˜ å°„ä¸ºå·²å›é€€
        mapping.is_active = False
        self._update_mapping(mapping)
        
        return True

# move_file å·¥å…·æ›´æ–°
class MoveFileTool(BaseTool):
    """ç§»åŠ¨æ–‡ä»¶å·¥å…· - å¸¦æ˜ å°„è®°å½•"""
    
    async def execute(self, source: str, destination: str, **kwargs) -> ToolResult:
        from app.models.file_mapping import FileMappingRegistry
        
        try:
            src_path = Path(source)
            dst_path = Path(destination)
            
            if not src_path.exists():
                return ToolResult(success=False, error=f"æºæ–‡ä»¶ä¸å­˜åœ¨: {source}")
            
            # ç”Ÿæˆæ“ä½œID
            import uuid
            operation_id = str(uuid.uuid4())[:8]
            
            # è®°å½•ç§»åŠ¨æ˜ å°„
            registry = FileMappingRegistry()
            mapping = registry.record_move(source, destination, operation_id)
            
            # æ‰§è¡Œç§»åŠ¨
            shutil.move(source, destination)
            
            return ToolResult(
                success=True,
                data={
                    "source": source,
                    "destination": destination,
                    "operation_id": operation_id,
                    "can_rollback": True,
                    "original_location": registry.get_original_location(destination)
                }
            )
            
        except Exception as e:
            return ToolResult(success=False, error=str(e))
```

#### 3.3.4 æ’¤é”€/å›é€€åŠŸèƒ½è®¾è®¡

**ç”¨æˆ·åœºæ™¯**:
1. "æ’¤é”€åˆšæ‰çš„ç§»åŠ¨æ“ä½œ"
2. "æ’¤é”€åˆšæ‰çš„åˆ é™¤æ“ä½œ"
3. "å›é€€æ•´ä¸ªæ•´ç†ä¼šè¯"

**å®ç°æ–¹æ¡ˆ**:

```python
# app/core/rollback.py
from typing import List, Optional
from datetime import datetime

class RollbackManager:
    """å›é€€ç®¡ç†å™¨"""
    
    def __init__(self):
        self.operation_history = OperationHistoryStore()
        self.recycle_bin = RecycleBin()
        self.file_mapping = FileMappingRegistry()
    
    async def rollback_single_operation(self, operation_id: str) -> dict:
        """
        å›é€€å•ä¸ªæ“ä½œ
        
        Args:
            operation_id: æ“ä½œID
            
        Returns:
            å›é€€ç»“æœ
        """
        operation = self.operation_history.get_operation(operation_id)
        
        if not operation:
            return {"success": False, "error": "æ“ä½œä¸å­˜åœ¨"}
        
        if not operation.can_rollback:
            return {"success": False, "error": "è¯¥æ“ä½œä¸å¯å›é€€"}
        
        if operation.operation_type == OperationType.DELETE:
            # ä»å›æ”¶ç«™æ¢å¤
            restored_path = self.recycle_bin.restore(operation_id)
            self.operation_history.mark_rollbacked(operation_id)
            return {
                "success": True,
                "operation": "delete",
                "action": "restore",
                "restored_path": restored_path
            }
        
        elif operation.operation_type == OperationType.MOVE:
            # åå‘ç§»åŠ¨
            success = self.file_mapping.rollback_move(operation_id)
            if success:
                self.operation_history.mark_rollbacked(operation_id)
                return {
                    "success": True,
                    "operation": "move",
                    "action": "rollback",
                    "message": "æ–‡ä»¶å·²ç§»å›åŸä½ç½®"
                }
            else:
                return {"success": False, "error": "å›é€€å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½å·²è¢«ä¿®æ”¹"}
        
        elif operation.operation_type == OperationType.WRITE:
            # å†™å…¥æ“ä½œå›é€€æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦ä¿å­˜åŸå§‹å†…å®¹
            # ... å®ç°ç•¥
            pass
        
        else:
            return {"success": False, "error": f"ä¸æ”¯æŒå›é€€çš„æ“ä½œç±»å‹: {operation.operation_type}"}
    
    async def rollback_execution(self, execution_id: str) -> dict:
        """
        å›é€€æ•´ä¸ª ReAct æ‰§è¡Œä¼šè¯ï¼ˆé€†åºå›é€€æ‰€æœ‰æ“ä½œï¼‰
        
        Args:
            execution_id: æ‰§è¡Œä¼šè¯ID
        """
        operations = self.operation_history.get_operations_by_execution(execution_id)
        
        # æŒ‰æ—¶é—´å€’åºå›é€€ï¼ˆååšçš„å…ˆå›é€€ï¼‰
        results = []
        for op in reversed(operations):
            if op.can_rollback and op.status != OperationStatus.ROLLED_BACK:
                result = await self.rollback_single_operation(op.id)
                results.append(result)
        
        return {
            "success": True,
            "execution_id": execution_id,
            "total_operations": len(operations),
            "rollbacked_count": len([r for r in results if r["success"]]),
            "details": results
        }
```

**API ç«¯ç‚¹è®¾è®¡**:

```python
# app/api/v1/rollback.py
from fastapi import APIRouter

router = APIRouter()

@router.post("/rollback/operation/{operation_id}")
async def rollback_single_operation(operation_id: str):
    """å›é€€å•ä¸ªæ“ä½œ"""
    manager = RollbackManager()
    result = await manager.rollback_single_operation(operation_id)
    return result

@router.post("/rollback/execution/{execution_id}")
async def rollback_execution(execution_id: str):
    """å›é€€æ•´ä¸ªæ‰§è¡Œä¼šè¯"""
    manager = RollbackManager()
    result = await manager.rollback_execution(execution_id)
    return result

@router.get("/operations/history")
async def get_operation_history(limit: int = 50):
    """è·å–æ“ä½œå†å²ï¼ˆç”¨æˆ·æŸ¥çœ‹ï¼‰"""
    history = OperationHistoryStore()
    operations = history.get_recent_operations(limit)
    return {"operations": operations}

@router.get("/backups/list")
async def list_recycle_bin():
    """åˆ—å‡ºå›æ”¶ç«™ä¸­å¯æ¢å¤çš„æ–‡ä»¶"""
    recycle_bin = RecycleBin()
    backups = recycle_bin.list_backups()
    return {"backups": backups}
```

#### 3.3.5 æ“ä½œè¿‡ç¨‹å¯è§†åŒ–å±•ç¤ºï¼ˆv1.3 æ–°å¢ï¼‰

> **è®¾è®¡ç†å¿µ**: ä¸ä»…å‘Šè¯‰ç”¨æˆ·"åšäº†ä»€ä¹ˆ"ï¼Œæ›´è¦ç›´è§‚åœ°å±•ç¤º"æ€ä¹ˆåšçš„"å’Œ"æ•ˆæœå¦‚ä½•"

**ç”¨æˆ·åœºæ™¯**: 
- "AI å¸®æˆ‘æ•´ç†äº†ä¸‹è½½æ–‡ä»¶å¤¹ï¼Œæˆ‘æƒ³**ç›´è§‚åœ°**çœ‹åˆ°æ–‡ä»¶éƒ½å»å“ªäº†"
- "æ•´ç†åç©ºé—´é‡Šæ”¾äº†å¤šå°‘ï¼Ÿåˆ é™¤äº†å¤šå°‘å¤§æ–‡ä»¶ï¼Ÿ"
- "æ–‡ä»¶æ•´ç†çš„**è¿‡ç¨‹åŠ¨ç”»**èƒ½å¸®åŠ©æˆ‘ç†è§£ AI çš„æ€è€ƒé€»è¾‘"

##### æ–¹æ¡ˆä¸€ï¼šæ–‡å­—åˆ—è¡¨å½¢å¼ï¼ˆåŸºç¡€ï¼Œå·²å®ç°ï¼‰

```
ğŸ“‹ æ“ä½œå†å²åˆ—è¡¨ï¼ˆç°æœ‰å®ç°ï¼‰

10:30:16 - [âœ…] è¯»å– C:\Users\xxx\Downloads\file1.txt
10:30:17 - [âœ…] ç§»åŠ¨ report.pdf â†’ Documents/Work/
10:30:18 - [âœ…] åˆ é™¤ temp.exeï¼ˆèŠ‚çœ 150MBï¼‰
10:30:19 - [âš ï¸] ç§»åŠ¨ image.jpg â†’ Pictures/ï¼ˆå¤±è´¥: æƒé™ä¸è¶³ï¼‰

[æŸ¥çœ‹è¯¦æƒ…] [æ’¤é”€] [å…¨éƒ¨å›é€€]
```

**é€‚ç”¨åœºæ™¯**: å¿«é€ŸæŸ¥çœ‹ã€æœç´¢ç‰¹å®šæ“ä½œã€å¤åˆ¶è·¯å¾„

##### æ–¹æ¡ˆäºŒï¼šå›¾å½¢åŒ–å±•ç¤ºï¼ˆæ¨èï¼‰

**2.1 æ–‡ä»¶å¤¹ç»“æ„å˜åŒ–å›¾ï¼ˆæ ‘å½¢å›¾ï¼‰**

```
æ•´ç†å‰                        æ•´ç†å
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ“ Downloads/                 ğŸ“ Downloads/
  â”œâ”€â”€ ğŸ“„ doc1.pdf      â†’        â”œâ”€â”€ ğŸ“„ summary.txt (æ–°ç”Ÿæˆ)
  â”œâ”€â”€ ğŸ“„ doc2.pdf      â†’        â””â”€â”€ ğŸ“ archive/ (å‹ç¼©æ—§æ–‡ä»¶)
  â”œâ”€â”€ ğŸ“· photo1.jpg    â†’      
  â”œâ”€â”€ ğŸ“· photo2.jpg    â†’      ğŸ“ Documents/Work/
  â”œâ”€â”€ ğŸ¬ video.mp4     â†’        â”œâ”€â”€ ğŸ“„ doc1.pdf âœ“
  â”œâ”€â”€ ğŸ’¾ setup.exe     â†’        â””â”€â”€ ğŸ“„ doc2.pdf âœ“
  â””â”€â”€ ğŸ“ temp.txt      â†’      
                              ğŸ“ Pictures/2024/
                                â”œâ”€â”€ ğŸ“· photo1.jpg âœ“
                                â””â”€â”€ ğŸ“· photo2.jpg âœ“
                              
                              ğŸ—‘ï¸ å›æ”¶ç«™ (å¯æ¢å¤)
                                â”œâ”€â”€ ğŸ’¾ setup.exe
                                â””â”€â”€ ğŸ“ temp.txt
                              
ç§»åŠ¨: 6 ä¸ªæ–‡ä»¶    åˆ é™¤: 2 ä¸ªæ–‡ä»¶    é‡Šæ”¾ç©ºé—´: 1.2GB
```

**å®ç°æŠ€æœ¯**:
- **æ–‡æœ¬æ ‘å½¢å›¾**: ä½¿ç”¨ ASCII/Unicode å­—ç¬¦ç»˜åˆ¶ï¼ˆæ— éœ€å‰ç«¯åº“ï¼‰
- **Mermaid æµç¨‹å›¾**: `mermaid` è¯­æ³•ç”Ÿæˆ SVG å›¾
- **å‰ç«¯ç»„ä»¶**: React + D3.js / ECharts ç»˜åˆ¶å¯äº¤äº’æ ‘å›¾

**åç«¯æ¥å£**:
```python
@router.get("/operations/visualization/tree")
async def get_operation_tree(execution_id: str):
    """è·å–æ“ä½œè¿‡ç¨‹çš„æ ‘å½¢ç»“æ„å›¾"""
    operations = OperationHistoryStore().get_operations_by_execution(execution_id)
    
    # æ„å»ºç›®å½•å˜åŒ–æ ‘
    tree_data = build_directory_tree(operations)
    
    return {
        "tree_text": render_tree_ascii(tree_data),  # ASCII æ–‡æœ¬æ ‘
        "tree_mermaid": render_tree_mermaid(tree_data),  # Mermaid è¯­æ³•
        "tree_data": tree_data  # JSON æ•°æ®ä¾›å‰ç«¯ç»˜åˆ¶
    }
```

**2.2 æ–‡ä»¶æµå‘å›¾ï¼ˆSankey å›¾ï¼‰**

```
æ–‡ä»¶æµå‘å¯è§†åŒ– (Sankey Diagram)

Downloads/        Documents/        Pictures/        å›æ”¶ç«™
     â”‚                  â”‚                â”‚              â”‚
     â”œâ”€ doc1.pdf â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚              â”‚
     â”œâ”€ doc2.pdf â”€â”€â”€â”€â”€â”€â”€â”¤                â”‚              â”‚
     â”œâ”€ photo1.jpg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”œâ”€ photo2.jpg â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
     â”œâ”€ setup.exe â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â””â”€ temp.txt â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     
     [6 ä¸ªæ–‡ä»¶ç§»åŠ¨]    [2 ä¸ªæ–‡ä»¶]       [2 ä¸ªæ–‡ä»¶]      [2 ä¸ªæ–‡ä»¶]
```

**å®ç°æŠ€æœ¯**:
- **D3.js Sankey**: ä¸“ä¸šçš„æµå‘å›¾åº“
- **ECharts Graph**: å…³ç³»å›¾/æµå‘å›¾æ”¯æŒ

**2.3 ç©ºé—´å˜åŒ–å›¾è¡¨**

```
ç£ç›˜ç©ºé—´å˜åŒ–

æ•´ç†å‰:         [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 80% (80GB/100GB)
                
æ“ä½œè¿‡ç¨‹:       [-15GB åˆ é™¤è§†é¢‘] 
                [+2GB å‹ç¼©å½’æ¡£]
                [-500MB åˆ é™¤ä¸´æ—¶æ–‡ä»¶]
                
æ•´ç†å:         [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 65% (65GB/100GB)
                é‡Šæ”¾ç©ºé—´: 15.5GB âœ¨

æŒ‰æ–‡ä»¶ç±»å‹ç»Ÿè®¡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç±»å‹   â”‚  æ•´ç†å‰  â”‚  æ•´ç†å  â”‚   å˜åŒ–    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ–‡æ¡£     â”‚  5GB    â”‚  5.2GB  â”‚ +0.2GB   â”‚
â”‚ å›¾ç‰‡     â”‚  3GB    â”‚  3GB    â”‚   0      â”‚
â”‚ è§†é¢‘     â”‚  45GB   â”‚  35GB   â”‚ -10GB â¬‡ï¸ â”‚
â”‚ ä¸´æ—¶æ–‡ä»¶ â”‚  2GB    â”‚  0.5GB  â”‚ -1.5GB â¬‡ï¸â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**åç«¯æ¥å£**:
```python
@router.get("/operations/visualization/stats")
async def get_operation_stats(execution_id: str):
    """è·å–æ“ä½œç»Ÿè®¡å›¾è¡¨æ•°æ®"""
    operations = OperationHistoryStore().get_operations_by_execution(execution_id)
    
    stats = {
        "space_before": calculate_space_before(operations),
        "space_after": calculate_space_after(operations),
        "space_saved": calculate_space_saved(operations),
        "by_file_type": calculate_by_file_type(operations),
        "timeline": generate_timeline_data(operations)
    }
    
    return stats
```

##### æ–¹æ¡ˆä¸‰ï¼šåŠ¨ç”»æŠ¥å‘Šæ¨¡å¼ï¼ˆé«˜çº§ï¼ŒPhase 2 å¯è€ƒè™‘ï¼‰

**3.1 æ—¶é—´è½´åŠ¨ç”»å›æ”¾**

```
â¯ï¸ æ“ä½œè¿‡ç¨‹å›æ”¾
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

[â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”] 100% å®Œæˆ

2024-02-16 10:30:16  â–¶ï¸  å¼€å§‹æ•´ç†ä¸‹è½½æ–‡ä»¶å¤¹...
                     
2024-02-16 10:30:17  ğŸ“„  åˆ†ææ–‡ä»¶: report.pdf
                     ğŸ’¡  å†³ç­–: ç§»åŠ¨åˆ° Documents/Work/
                     â¡ï¸  æ‰§è¡Œç§»åŠ¨... âœ“
                     
2024-02-16 10:30:18  ğŸ“·  åˆ†ææ–‡ä»¶: vacation.jpg
                     ğŸ’¡  å†³ç­–: ç§»åŠ¨åˆ° Pictures/2024/
                     â¡ï¸  æ‰§è¡Œç§»åŠ¨... âœ“
                     
2024-02-16 10:30:19  ğŸ’¾  åˆ†ææ–‡ä»¶: setup.exe
                     ğŸ’¡  å†³ç­–: åˆ é™¤ï¼ˆè¶…è¿‡30å¤©æœªä½¿ç”¨ï¼‰
                     ğŸ—‘ï¸  ç§»åŠ¨åˆ°å›æ”¶ç«™... âœ“
                     
2024-02-16 10:30:20  âœ… æ•´ç†å®Œæˆï¼
                     ğŸ“Š ç»Ÿè®¡: ç§»åŠ¨ 6 ä¸ªæ–‡ä»¶, åˆ é™¤ 2 ä¸ªæ–‡ä»¶
                     ğŸ’¾ é‡Šæ”¾ç©ºé—´: 1.2GB
```

**äº¤äº’åŠŸèƒ½**:
- â–¶ï¸ æ’­æ”¾/æš‚åœåŠ¨ç”»
- â®ï¸ ä¸Šä¸€æ­¥/ä¸‹ä¸€æ­¥
- â© å¿«è¿›/æ…¢æ”¾
- ğŸ” ç‚¹å‡»æŸä¸ªæ“ä½œæŸ¥çœ‹è¯¦æƒ…
- ğŸ”„ ä»ä»»æ„æ­¥éª¤é‡æ–°å¼€å§‹

**å®ç°æ–¹æ¡ˆ**:
```python
# åç«¯ï¼šç”ŸæˆåŠ¨ç”»è„šæœ¬
@router.get("/operations/visualization/animation")
async def get_operation_animation(execution_id: str):
    """è·å–æ“ä½œè¿‡ç¨‹åŠ¨ç”»è„šæœ¬"""
    operations = OperationHistoryStore().get_operations_by_execution(execution_id)
    
    animation_script = {
        "total_duration": 30,  # 30ç§’å›æ”¾
        "frames": [
            {
                "timestamp": 0,
                "action": "start",
                "message": "å¼€å§‹æ•´ç†ä¸‹è½½æ–‡ä»¶å¤¹..."
            },
            {
                "timestamp": 2,
                "action": "analyze",
                "file": "report.pdf",
                "decision": "ç§»åŠ¨åˆ° Documents/Work/"
            },
            {
                "timestamp": 4,
                "action": "move",
                "source": "Downloads/report.pdf",
                "destination": "Documents/Work/report.pdf",
                "status": "success"
            },
            # ... æ›´å¤šå¸§
        ]
    }
    
    return animation_script

# å‰ç«¯ï¼šä½¿ç”¨ Lottie / CSS Animation æ’­æ”¾
```

**3.2 3D æ–‡ä»¶å¤¹å¯è§†åŒ–ï¼ˆå¯é€‰ï¼Œç‚«é…·æ•ˆæœï¼‰**

```
ğŸ—‚ï¸ 3D æ–‡ä»¶å¤¹æµè§ˆå™¨

    ğŸ“ Downloads
       â”‚
       â”œâ”€â”€ ğŸ“„ [ç§»åŠ¨åˆ°] â¡ï¸  ğŸ“ Documents
       â”‚
       â”œâ”€â”€ ğŸ“· [ç§»åŠ¨åˆ°] â¡ï¸  ğŸ“ Pictures  
       â”‚
       â””â”€â”€ ğŸ’¾ [åˆ é™¤]   â¡ï¸  ğŸ—‘ï¸ å›æ”¶ç«™

[æ—‹è½¬è§†å›¾] [ç¼©æ”¾] [å±•å¼€/æŠ˜å ] [æŸ¥çœ‹è¯¦æƒ…]
```

##### å¯è§†åŒ–å±•ç¤ºé€‰å‹å»ºè®®

| æ–¹æ¡ˆ | å¤æ‚åº¦ | å®ç°å‘¨æœŸ | ç”¨æˆ·ä½“éªŒ | æ¨èé˜¶æ®µ |
|------|--------|---------|---------|---------|
| **æ–‡å­—åˆ—è¡¨** | â­ ä½ | å·²å®Œæˆ | â­â­â­ åŸºç¡€ | Phase 1.3 âœ… |
| **ASCII æ ‘å½¢å›¾** | â­â­ ä¸­ | 1-2 å¤© | â­â­â­â­ ç›´è§‚ | Phase 1.3 âœ… |
| **Mermaid å›¾** | â­â­ ä¸­ | 2-3 å¤© | â­â­â­â­ ä¸“ä¸š | Phase 1.3 å¯é€‰ |
| **ECharts ç»Ÿè®¡** | â­â­â­ ä¸­é«˜ | 3-5 å¤© | â­â­â­â­â­ ä¸°å¯Œ | Phase 1.4 |
| **åŠ¨ç”»å›æ”¾** | â­â­â­â­ é«˜ | 1-2 å‘¨ | â­â­â­â­â­ æä½³ | Phase 2.x |
| **3D å¯è§†åŒ–** | â­â­â­â­â­ å¾ˆé«˜ | 2-4 å‘¨ | â­â­â­â­â­ ç‚«é…· | Phase 2.x |

##### æ¨èå®ç°é¡ºåº

**Phase 1.3ï¼ˆå½“å‰ï¼‰**:
1. âœ… æ–‡å­—åˆ—è¡¨ï¼ˆå·²å®Œæˆï¼‰
2. ğŸ¯ **ASCII æ ‘å½¢å›¾**ï¼ˆæ¨èå®ç°ï¼‰
   - æˆæœ¬ä½ï¼šçº¯æ–‡æœ¬ï¼Œæ— éœ€å‰ç«¯åº“
   - æ•ˆæœå¥½ï¼šç›´è§‚å±•ç¤ºæ–‡ä»¶ç§»åŠ¨è·¯å¾„
   - æ˜“æµ‹è¯•ï¼šåç«¯ç”Ÿæˆï¼ŒAPI ç›´æ¥è¿”å›

**Phase 1.4ï¼ˆåç»­ï¼‰**:
3. ECharts ç»Ÿè®¡å›¾è¡¨ï¼ˆç©ºé—´å˜åŒ–ã€æ–‡ä»¶ç±»å‹åˆ†å¸ƒï¼‰
4. ç®€å•åŠ¨ç”»å›æ”¾ï¼ˆå…³é”®æ­¥éª¤é«˜äº®ï¼‰

**Phase 2.xï¼ˆæœªæ¥ï¼‰**:
5. å®Œæ•´åŠ¨ç”»å›æ”¾ï¼ˆæ—¶é—´è½´æ’­æ”¾æ§åˆ¶ï¼‰
6. 3D å¯è§†åŒ–ï¼ˆWebGL/Three.jsï¼‰

##### åç«¯å®ç°ä»£ç ç¤ºä¾‹

```python
# app/services/visualization.py

class OperationVisualizer:
    """æ“ä½œè¿‡ç¨‹å¯è§†åŒ–æœåŠ¡"""
    
    def generate_ascii_tree(self, execution_id: str) -> str:
        """ç”Ÿæˆ ASCII æ ‘å½¢å›¾"""
        operations = self._get_operations(execution_id)
        
        lines = ["ğŸ“ æ–‡ä»¶æ•´ç†è¿‡ç¨‹å¯è§†åŒ–", "=" * 50]
        
        # æŒ‰æ“ä½œç±»å‹åˆ†ç»„
        moves = [op for op in operations if op.type == "move"]
        deletes = [op for op in operations if op.type == "delete"]
        
        lines.append("\nğŸ“¦ æ–‡ä»¶ç§»åŠ¨:\n")
        for op in moves:
            lines.append(f"  {op.source}")
            lines.append(f"  {' ' * len(op.source)} â””â”€â¡ï¸ {op.destination}")
        
        lines.append("\nğŸ—‘ï¸  åˆ é™¤çš„æ–‡ä»¶:\n")
        for op in deletes:
            lines.append(f"  âŒ {op.source} (å¯æ¢å¤)")
        
        lines.append("\n" + "=" * 50)
        lines.append(f"ğŸ“Š æ€»è®¡: ç§»åŠ¨ {len(moves)} ä¸ª, åˆ é™¤ {len(deletes)} ä¸ª")
        
        return "\n".join(lines)
    
    def generate_mermaid_diagram(self, execution_id: str) -> str:
        """ç”Ÿæˆ Mermaid æµç¨‹å›¾è¯­æ³•"""
        operations = self._get_operations(execution_id)
        
        mermaid = ["graph LR"]
        
        for op in operations:
            if op.type == "move":
                source = self._sanitize(op.source)
                dest = self._sanitize(op.destination)
                mermaid.append(f"    {source}[{op.filename}] -->|ç§»åŠ¨| {dest}")
            elif op.type == "delete":
                source = self._sanitize(op.source)
                mermaid.append(f"    {source}[{op.filename}] -->|åˆ é™¤| trash[ğŸ—‘ï¸]")
        
        return "\n".join(mermaid)
    
    def generate_stats_chart(self, execution_id: str) -> dict:
        """ç”Ÿæˆç»Ÿè®¡å›¾è¡¨æ•°æ®"""
        operations = self._get_operations(execution_id)
        
        return {
            "pie_chart": {
                "title": "æ“ä½œç±»å‹åˆ†å¸ƒ",
                "data": [
                    {"name": "ç§»åŠ¨", "value": len([o for o in operations if o.type == "move"])},
                    {"name": "åˆ é™¤", "value": len([o for o in operations if o.type == "delete"])},
                    {"name": "è¯»å–", "value": len([o for o in operations if o.type == "read"])}
                ]
            },
            "space_chart": {
                "title": "ç©ºé—´å˜åŒ–",
                "before": sum([o.file_size for o in operations if o.type == "delete"]),
                "after": 0  # åˆ é™¤å
            }
        }
```

**å‰ç«¯å±•ç¤ºç¤ºä¾‹**:

```tsx
// å‰ç«¯ç»„ä»¶ï¼šOperationVisualizer.tsx

import React, { useState } from 'react';

interface OperationVisualizerProps {
  executionId: string;
}

export const OperationVisualizer: React.FC<OperationVisualizerProps> = ({ executionId }) => {
  const [viewMode, setViewMode] = useState<'list' | 'tree' | 'chart'>('list');
  
  return (
    <div className="operation-visualizer">
      <div className="view-toggle">
        <button onClick={() => setViewMode('list')}>ğŸ“‹ åˆ—è¡¨</button>
        <button onClick={() => setViewMode('tree')}>ğŸŒ² æ ‘å½¢å›¾</button>
        <button onClick={() => setViewMode('chart')}>ğŸ“Š ç»Ÿè®¡å›¾</button>
      </div>
      
      {viewMode === 'list' && <OperationList executionId={executionId} />}
      {viewMode === 'tree' && <AsciiTree executionId={executionId} />}
      {viewMode === 'chart' && <StatsChart executionId={executionId} />}
    </div>
  );
};

// ASCII æ ‘å½¢å›¾ç»„ä»¶
const AsciiTree: React.FC<{ executionId: string }> = ({ executionId }) => {
  const [treeText, setTreeText] = useState('');
  
  React.useEffect(() => {
    fetch(`/api/v1/operations/visualization/tree?execution_id=${executionId}`)
      .then(res => res.json())
      .then(data => setTreeText(data.tree_text));
  }, [executionId]);
  
  return <pre className="ascii-tree">{treeText}</pre>;
};
```

---

## 4. éªŒæ”¶æ ‡å‡†

### 4.1 åŠŸèƒ½éªŒæ”¶

| éªŒæ”¶é¡¹ | éªŒæ”¶æ ‡å‡† | éªŒè¯æ–¹æ³• |
|--------|---------|---------|
| **å·¥å…·æ³¨å†Œ** | 4ä¸ª P0 å·¥å…·éƒ½èƒ½æ­£ç¡®æ³¨å†Œ | è°ƒç”¨ `ToolRegistry.list_tools()` éªŒè¯ |
| **read_file** | èƒ½è¯»å–æ–‡æœ¬æ–‡ä»¶å¹¶è¿”å›å†…å®¹ | å•å…ƒæµ‹è¯•ï¼šè¯»å–æµ‹è¯•æ–‡ä»¶ |
| **write_file** | èƒ½åˆ›å»ºæ–‡ä»¶å¹¶å†™å…¥å†…å®¹ | å•å…ƒæµ‹è¯•ï¼šå†™å…¥åè¯»å–éªŒè¯ |
| **list_directory** | èƒ½åˆ—å‡ºç›®å½•ä¸­çš„æ–‡ä»¶ | å•å…ƒæµ‹è¯•ï¼šå¯¹æ¯” os.listdir |
| **move_file** | èƒ½ç§»åŠ¨/é‡å‘½åæ–‡ä»¶ | å•å…ƒæµ‹è¯•ï¼šç§»åŠ¨åéªŒè¯ |
| **ReActå¾ªç¯** | èƒ½å®Œæˆè‡³å°‘3è½®æ€è€ƒ-è¡ŒåŠ¨-è§‚å¯Ÿ | é›†æˆæµ‹è¯•ï¼šæ¨¡æ‹Ÿå¤æ‚ä»»åŠ¡ |
| **é”™è¯¯é‡è¯•** | å¤±è´¥3æ¬¡åæ‰æŠ¥é”™ | å•å…ƒæµ‹è¯•ï¼šæ¨¡æ‹Ÿå¤±è´¥åœºæ™¯ |
| **æ—¥å¿—è®°å½•** | æ¯æ¬¡å·¥å…·è°ƒç”¨éƒ½æœ‰æ—¥å¿—ï¼ŒåŒ…å«è€—æ—¶ | æ£€æŸ¥æ—¥å¿—æ–‡ä»¶å†…å®¹ |
| **Windows å…¼å®¹** | åœ¨ Windows 11 + PS 5.1 ä¸‹æµ‹è¯•é€šè¿‡ | å®é™…è¿è¡Œæµ‹è¯• |
| **ä¸­æ–‡è·¯å¾„** | èƒ½è¯»å–/å†™å…¥ä¸­æ–‡è·¯å¾„æ–‡ä»¶ | å•å…ƒæµ‹è¯•ï¼šä½¿ç”¨ä¸­æ–‡è·¯å¾„æµ‹è¯• |
| **åˆ é™¤å¤‡ä»½** | åˆ é™¤çš„æ–‡ä»¶è‡ªåŠ¨å¤‡ä»½åˆ°å›æ”¶ç«™ | éªŒè¯å›æ”¶ç«™ç›®å½•å­˜åœ¨å¤‡ä»½ |
| **ç§»åŠ¨è®°å½•** | ç§»åŠ¨æ“ä½œè®°å½•æºè·¯å¾„å’Œç›®æ ‡è·¯å¾„ | æŸ¥è¯¢æ˜ å°„è¡¨éªŒè¯ |
| **æ“ä½œå†å²** | ç”¨æˆ·å¯æŸ¥çœ‹æœ€è¿‘çš„æ“ä½œå†å² | UI/API æµ‹è¯• |
| **æ’¤é”€åŠŸèƒ½** | å¯æ’¤é”€å•æ¬¡åˆ é™¤/ç§»åŠ¨æ“ä½œ | åŠŸèƒ½æµ‹è¯•ï¼šæ‰§è¡Œâ†’æ’¤é”€â†’éªŒè¯ |
| **å›é€€ä¼šè¯** | å¯å›é€€æ•´ä¸ª ReAct æ‰§è¡Œä¼šè¯ | åŠŸèƒ½æµ‹è¯•ï¼šå¤šæ“ä½œâ†’æ‰¹é‡å›é€€ |

**éªŒæ”¶æ ‡å‡†è¡¥å……è¯´æ˜**ï¼ˆv1.2 æ–°å¢ï¼‰ï¼š
- æ—¥å¿—éªŒæ”¶éœ€éªŒè¯ï¼šè¯·æ±‚IDã€å·¥å…·åç§°ã€æ‰§è¡Œè€—æ—¶ã€æˆåŠŸ/å¤±è´¥çŠ¶æ€
- Windows å…¼å®¹éœ€éªŒè¯ï¼šPowerShell 5.1 ç¯å¢ƒä¸‹æ‰€æœ‰å·¥å…·æ­£å¸¸æ‰§è¡Œ
- ä¸­æ–‡è·¯å¾„éœ€éªŒè¯ï¼šåŒ…å«ä¸­æ–‡çš„æ–‡ä»¶åå’Œç›®å½•åéƒ½èƒ½æ­£ç¡®å¤„ç†

**æ–‡ä»¶æ“ä½œå®‰å…¨éªŒæ”¶æ ‡å‡†**ï¼ˆv1.3 æ–°å¢ï¼‰ï¼š
- **åˆ é™¤å¤‡ä»½**ï¼šåˆ é™¤çš„æ–‡ä»¶å¿…é¡»åœ¨ `data/recycle_bin/` ç›®å½•æœ‰å¤‡ä»½ï¼Œä¿ç•™30å¤©
- **ç§»åŠ¨è®°å½•**ï¼šå¿…é¡»è®°å½•æºè·¯å¾„â†’ç›®æ ‡è·¯å¾„çš„æ˜ å°„å…³ç³»ï¼Œæ”¯æŒé“¾å¼è¿½è¸ªï¼ˆAâ†’Bâ†’Câ†’å½“å‰ä½ç½®ï¼‰
- **æ“ä½œå†å²**ï¼šç”¨æˆ·å¯é€šè¿‡ API `/operations/history` æŸ¥çœ‹æœ€è¿‘50æ¡æ“ä½œè®°å½•
- **æ’¤é”€åŠŸèƒ½**ï¼š
  - åˆ é™¤æ“ä½œï¼šä»å›æ”¶ç«™æ¢å¤ï¼ŒéªŒè¯æ–‡ä»¶å®Œæ•´æ€§
  - ç§»åŠ¨æ“ä½œï¼šåå‘ç§»åŠ¨ï¼ŒéªŒè¯æ–‡ä»¶å›åˆ°åŸä½ç½®
  - å›é€€æœ‰æ•ˆæœŸï¼š30å¤©å†…å¯å›é€€
- **å›é€€ä¼šè¯**ï¼šæ”¯æŒä¸€é”®å›é€€æ•´ä¸ª ReAct ä¼šè¯çš„æ‰€æœ‰æ“ä½œï¼ˆæŒ‰é€†åºå›é€€ï¼‰
- **å¹¶å‘å®‰å…¨**ï¼šå›é€€è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ–‡ä»¶å·²è¢«ç”¨æˆ·æ‰‹åŠ¨ä¿®æ”¹ï¼Œåº”æç¤ºå†²çªè€Œä¸æ˜¯å¼ºåˆ¶è¦†ç›–

### 4.2 æ€§èƒ½éªŒæ”¶

| æŒ‡æ ‡ | è¦æ±‚ | æµ‹è¯•æ–¹æ³• |
|------|------|---------|
| å·¥å…·æ‰§è¡Œæ—¶é—´ | < 100ms | å•å…ƒæµ‹è¯•è®¡æ—¶ |
| ReActå•æ¬¡è¿­ä»£ | < 5s (å«AIè°ƒç”¨) | é›†æˆæµ‹è¯•è®¡æ—¶ |
| å†…å­˜å ç”¨ | < 50MB | è¿è¡Œæ—¶ç›‘æ§ |

### 4.3 è´¨é‡éªŒæ”¶

- [ ] **æµ‹è¯•è¦†ç›–ç‡**: â‰¥ 80%
- [ ] **ä»£ç å®¡æŸ¥**: æ— ä¸¥é‡é—®é¢˜
- [ ] **æ–‡æ¡£å®Œæ•´æ€§**: æ‰€æœ‰å·¥å…·éƒ½æœ‰ä½¿ç”¨è¯´æ˜
- [ ] **é”™è¯¯å¤„ç†**: æ‰€æœ‰å¼‚å¸¸éƒ½æœ‰åˆé€‚çš„é”™è¯¯æç¤º

---

## 5. é£é™©é¢„ä¼°

### 5.1 æŠ€æœ¯é£é™©

| é£é™© | å¯èƒ½æ€§ | å½±å“ | åº”å¯¹æªæ–½ |
|------|--------|------|---------|
| AI ä¸è¾“å‡ºæ ‡å‡†æ ¼å¼ | ä¸­ | é«˜ | æ·»åŠ æ ¼å¼æ ¡éªŒå’Œé‡è¯•æœºåˆ¶ |
| å·¥å…·æ‰§è¡Œæƒé™ä¸è¶³ | ä¸­ | é«˜ | æ·»åŠ æƒé™æ£€æŸ¥å’Œå‹å¥½æç¤º |
| æ–‡ä»¶æ“ä½œå¼‚å¸¸ï¼ˆå ç”¨ç­‰ï¼‰ | ä¸­ | ä¸­ | æ·»åŠ å¼‚å¸¸å¤„ç†å’Œé‡è¯• |
| æ­»å¾ªç¯é£é™© | ä½ | é«˜ | è®¾ç½® max_iterations é™åˆ¶ |
| AI å“åº”æ ¼å¼ä¸ç¨³å®š | é«˜ | ä¸­ | æ·»åŠ  JSON Schema æ ¡éªŒå’Œå®¹é”™è§£æ |
| æ—¥å¿—ç³»ç»Ÿæ•…éšœ | ä½ | ä¸­ | ç¡®ä¿æ—¥å¿—ç³»ç»Ÿç¨³å®šï¼ˆPhase 1.2 å·²ä¿®å¤ï¼‰ |
| å›æ”¶ç«™ç©ºé—´ä¸è¶³ | ä¸­ | é«˜ | ç›‘æ§ç£ç›˜ç©ºé—´ï¼Œè‡ªåŠ¨æ¸…ç†æ—§å¤‡ä»½ï¼ˆ>30å¤©ï¼‰ |
| å›é€€å†²çª | ä¸­ | ä¸­ | å›é€€å‰æ£€æŸ¥æ–‡ä»¶æ˜¯å¦è¢«ä¿®æ”¹ï¼Œæç¤ºç”¨æˆ·é€‰æ‹© |
| æ“ä½œå†å²ä¸¢å¤± | ä½ | é«˜ | SQLite æ•°æ®åº“å®šæœŸå¤‡ä»½ |

**é£é™©è¡¥å……è¯´æ˜**ï¼ˆv1.2 æ–°å¢ï¼‰ï¼š
- **AI å“åº”æ ¼å¼ä¸ç¨³å®š**ï¼šReAct ä¾èµ– AI è¾“å‡ºæ ‡å‡† JSONï¼Œå¯èƒ½è§£æå¤±è´¥ï¼Œéœ€æ·»åŠ  try-except å’Œé‡è¯•
- **æ—¥å¿—ç³»ç»Ÿæ•…éšœ**ï¼šå¦‚æœ Phase 1.2 çš„æ—¥å¿—ç³»ç»Ÿæœ‰é—®é¢˜ï¼Œä¼šå½±å“ ReAct è°ƒè¯•ï¼Œéœ€ç¡®ä¿ api_logger åˆå§‹åŒ–æ­£ç¡®

**æ–‡ä»¶æ“ä½œå®‰å…¨é£é™©**ï¼ˆv1.3 æ–°å¢ï¼‰ï¼š
- **å›æ”¶ç«™ç©ºé—´ä¸è¶³**ï¼šå¤§é‡åˆ é™¤æ“ä½œå¯èƒ½å æ»¡ç£ç›˜ï¼Œéœ€ç›‘æ§å¹¶è‡ªåŠ¨æ¸…ç†30å¤©å‰çš„å¤‡ä»½
- **å›é€€å†²çª**ï¼šç”¨æˆ·å›é€€æ—¶ï¼Œå¦‚æœæ–‡ä»¶å·²è¢«æ‰‹åŠ¨ä¿®æ”¹ï¼Œåº”æç¤ºå†²çªè€Œä¸æ˜¯å¼ºåˆ¶è¦†ç›–
- **æ“ä½œå†å²ä¸¢å¤±**ï¼šSQLite æ•°æ®åº“æŸåå¯èƒ½å¯¼è‡´å†å²è®°å½•ä¸¢å¤±ï¼Œéœ€å®šæœŸå¤‡ä»½æ•°æ®åº“æ–‡ä»¶
- **å¹¶å‘æ“ä½œå†²çª**ï¼šç”¨æˆ·å’Œ AI åŒæ—¶æ“ä½œåŒä¸€æ–‡ä»¶ï¼Œéœ€æ–‡ä»¶é”æˆ–ä¹è§‚é”æœºåˆ¶

### 5.2 ä¾èµ–é£é™©

| ä¾èµ– | é£é™©æè¿° | åº”å¯¹æªæ–½ |
|------|---------|---------|
| Phase 1.2 | AI æœåŠ¡ä¸ç¨³å®š | ä½¿ç”¨ OpenCode ä½œä¸ºå¤‡é€‰ |
| æ–‡ä»¶ç³»ç»Ÿ | Windows è·¯å¾„é—®é¢˜ | ä½¿ç”¨ pathlib å¤„ç†è·¨å¹³å° |

---

## 6. å®æ–½è®¡åˆ’

### 6.1 å¼€å‘é¡ºåº

```
Day 1-2: å·¥å…·æ¡†æ¶
  â”œâ”€ å·¥å…·åŸºç±» (BaseTool)
  â”œâ”€ å·¥å…·æ³¨å†Œè¡¨ (ToolRegistry)
  â””â”€ å·¥å…·å®šä¹‰ Schema

Day 3: P0 å·¥å…·å®ç° - è¯»å–ç±»
  â”œâ”€ read_file å·¥å…·ï¼ˆåŸºç¡€å®ç°ï¼‰
  â””â”€ list_directory å·¥å…·ï¼ˆåŸºç¡€å®ç°ï¼‰

Day 4: P0 å·¥å…·å®ç° - å†™å…¥ç±»ï¼ˆå«å®‰å…¨æœºåˆ¶ï¼‰
  â”œâ”€ write_file å·¥å…·
  â”œâ”€ å›æ”¶ç«™æœºåˆ¶ (RecycleBin)
  â”‚   â”œâ”€ åˆ é™¤å‰å¤‡ä»½å®ç°
  â”‚   â”œâ”€ å…ƒæ•°æ®ç®¡ç†
  â”‚   â””â”€ è‡ªåŠ¨æ¸…ç†ç­–ç•¥ï¼ˆ>30å¤©ï¼‰
  â”œâ”€ æ–‡ä»¶ç§»åŠ¨æ˜ å°„ (FileMappingRegistry)
  â”‚   â”œâ”€ æºâ†’ç›®æ ‡è·¯å¾„è®°å½•
  â”‚   â”œâ”€ é“¾å¼è¿½è¸ªæŸ¥è¯¢
  â”‚   â””â”€ åå‘æŸ¥è¯¢å®ç°
  â””â”€ move_file å·¥å…·ï¼ˆå«æ˜ å°„è®°å½•ï¼‰

Day 5: ReAct æ¡†æ¶å’Œ Think é˜¶æ®µ
  â”œâ”€ ReActExecutor ç±»æ¡†æ¶æ­å»º
  â”œâ”€ execute() ä¸»å¾ªç¯å®ç°ï¼ˆå« max_iterations é™åˆ¶ï¼‰
  â”œâ”€ _think() æ–¹æ³•å®ç°
  â”‚   â”œâ”€ Prompt æ¨¡æ¿æ„å»ºï¼ˆå«å·¥å…·æè¿°ã€å†å²ä¸Šä¸‹æ–‡ï¼‰
  â”‚   â”œâ”€ è°ƒç”¨ AI æœåŠ¡è·å–å“åº”
  â”‚   â””â”€ è§£æ AI å“åº”ä¸ºç»“æ„åŒ–æ•°æ®
  â””â”€ _parse_thought_response() æ–¹æ³•å®ç°

Day 6: Actã€Observationã€æ—¥å¿—é›†æˆå’Œæ“ä½œå†å²
  â”œâ”€ _act() æ–¹æ³•å®ç°ï¼ˆå·¥å…·è°ƒç”¨æ‰§è¡Œï¼‰
  â”œâ”€ _retry_action() é‡è¯•é€»è¾‘å®ç°
  â”‚   â”œâ”€ æŒ‡æ•°é€€é¿ç­–ç•¥
  â”‚   â””â”€ æœ€å¤§é‡è¯•æ¬¡æ•°é™åˆ¶ï¼ˆ3æ¬¡ï¼‰
  â”œâ”€ æ—¥å¿—ç³»ç»Ÿé›†æˆï¼ˆä¸ Phase 1.2 æ—¥å¿—ç³»ç»Ÿå¯¹æ¥ï¼‰
  â”‚   â”œâ”€ ReActExecutor æ—¥å¿—è®°å½•
  â”‚   â”œâ”€ å·¥å…·è°ƒç”¨æ—¥å¿—è®°å½•
  â”‚   â””â”€ æ‰§è¡Œè€—æ—¶ç»Ÿè®¡
  â”œâ”€ æ“ä½œå†å²ç³»ç»Ÿ (OperationHistoryStore)
  â”‚   â”œâ”€ SQLite æ•°æ®åº“è®¾è®¡
  â”‚   â”œâ”€ æ“ä½œè®°å½• CRUD
  â”‚   â””â”€ ç”¨æˆ·æŸ¥è¯¢æ¥å£
  â”œâ”€ å›é€€ç®¡ç†å™¨ (RollbackManager)
  â”‚   â”œâ”€ å•æ“ä½œå›é€€
  â”‚   â””â”€ æ‰¹é‡ä¼šè¯å›é€€
  â””â”€ é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µæµ‹è¯•

Day 7: æµ‹è¯•å’Œæ–‡æ¡£
  â”œâ”€ å•å…ƒæµ‹è¯• (è¦†ç›–ç‡â‰¥80%)
  â”œâ”€ é›†æˆæµ‹è¯•
  â”œâ”€ å·¥å…·ä½¿ç”¨æ–‡æ¡£
  â””â”€ é˜¶æ®µæ€»ç»“
```

### 6.2 æ–‡ä»¶æ¸…å•

**æ–°å¢æ–‡ä»¶**:
- `app/tools/base.py` - å·¥å…·åŸºç±»å’Œå®šä¹‰
- `app/tools/registry.py` - å·¥å…·æ³¨å†Œè¡¨
- `app/tools/file_tools.py` - æ–‡ä»¶æ“ä½œå·¥å…·ï¼ˆå«å®‰å…¨æœºåˆ¶ï¼‰
- `app/core/react_executor.py` - ReAct æ‰§è¡Œå™¨
- `app/core/rollback.py` - å›é€€ç®¡ç†å™¨
- `app/utils/recycle_bin.py` - å›æ”¶ç«™ï¼ˆåˆ é™¤æ–‡ä»¶å¤‡ä»½ï¼‰
- `app/models/message.py` - æ¶ˆæ¯æ¨¡å‹
- `app/models/execution.py` - æ‰§è¡Œä¸Šä¸‹æ–‡æ¨¡å‹
- `app/models/operation_history.py` - æ“ä½œå†å²è®°å½•
- `app/models/file_mapping.py` - æ–‡ä»¶ç§»åŠ¨æ˜ å°„è¡¨
- `app/api/v1/rollback.py` - å›é€€ API ç«¯ç‚¹
- `tests/test_tools.py` - å·¥å…·å•å…ƒæµ‹è¯•
- `tests/test_react.py` - ReAct é›†æˆæµ‹è¯•
- `tests/test_rollback.py` - å›é€€åŠŸèƒ½æµ‹è¯•

**ä¿®æ”¹æ–‡ä»¶**:
- `app/main.py` - æ³¨å†Œå·¥å…·å’Œ ReAct æ‰§è¡Œå™¨
- `app/api/v1/chat.py` - é›†æˆ ReAct åˆ°å¯¹è¯æ¥å£

### 6.3 API é›†æˆæ–¹æ¡ˆï¼ˆv1.2 æ–°å¢ï¼‰

#### 6.3.1 æ–°ç«¯ç‚¹è®¾è®¡

**ç«¯ç‚¹ 1: ReAct å¯¹è¯ç«¯ç‚¹**
```
POST /api/v1/chat/react
```

**è¯·æ±‚ä½“**:
```json
{
  "message": "ç”¨æˆ·è¾“å…¥çš„æ¶ˆæ¯",
  "history": [
    {"role": "user", "content": "å†å²æ¶ˆæ¯1"},
    {"role": "assistant", "content": "å†å²å›å¤1"}
  ],
  "max_iterations": 10
}
```

**å“åº”ä½“**:
```json
{
  "success": true,
  "answer": "ReAct æ‰§è¡Œåçš„æœ€ç»ˆç­”æ¡ˆ",
  "execution_log": [
    {
      "iteration": 1,
      "thought": "æ€è€ƒå†…å®¹...",
      "action": {"tool": "read_file", "params": {"path": "file.txt"}},
      "observation": {"success": true, "data": {...}}
    }
  ],
  "total_iterations": 3,
  "total_time": 5.23
}
```

#### 6.3.2 ç°æœ‰ç«¯ç‚¹ä¿®æ”¹

**ç«¯ç‚¹ 2: æ ‡å‡†å¯¹è¯ç«¯ç‚¹ï¼ˆå¢å¼ºï¼‰**
```
POST /api/v1/chat
```

**æ–°å¢å‚æ•°**:
```json
{
  "message": "ç”¨æˆ·è¾“å…¥",
  "use_react": true,  // æ–°å¢å‚æ•°ï¼šæ˜¯å¦ä½¿ç”¨ ReAct æ¨¡å¼
  "history": []
}
```

**è¡Œä¸º**:
- `use_react: false`ï¼ˆé»˜è®¤ï¼‰ï¼šç›´æ¥è°ƒç”¨ AI æœåŠ¡ï¼Œç®€å•å¯¹è¯
- `use_react: true`ï¼šä½¿ç”¨ ReAct æ‰§è¡Œå™¨ï¼Œæ”¯æŒå·¥å…·è°ƒç”¨

#### 6.3.3 API å®ç°ä»£ç ç¤ºä¾‹

```python
# app/api/v1/chat.py
from app.core.react_executor import ReActExecutor
from app.tools.registry import ToolRegistry

@router.post("/chat/react")
async def chat_with_react(
    request: ChatRequest,
    background_tasks: BackgroundTasks
) -> ChatResponse:
    """ä½¿ç”¨ ReAct æ‰§è¡Œå¯¹è¯"""
    # è·å– AI æœåŠ¡
    ai_service = AIServiceFactory.get_service()
    
    # è·å–å·¥å…·æ³¨å†Œè¡¨
    tool_registry = ToolRegistry()
    
    # åˆ›å»º ReAct æ‰§è¡Œå™¨
    executor = ReActExecutor(ai_service, tool_registry)
    
    # æ‰§è¡Œ ReAct å¾ªç¯
    result = await executor.execute(
        user_input=request.message,
        history=request.history
    )
    
    return ChatResponse(
        success=result["success"],
        answer=result.get("answer", ""),
        execution_log=result.get("context", {}),
        total_iterations=len(result.get("context", {}).get("actions", [])),
        total_time=result.get("total_time", 0)
    )
```

---

## 7. å‚è€ƒèµ„æ–™

### 7.1 è®¾è®¡å‚è€ƒ
- ReAct è®ºæ–‡: *ReAct: Synergizing Reasoning and Acting in Language Models*
- åŸç‰ˆ `AI_OSShell_v2.py` ä¸­çš„å·¥å…·è°ƒç”¨é€»è¾‘
- ã€Šå¼€å‘ç­–ç•¥è§„èŒƒ v2.1ã€‹ç¬¬ 12.3 èŠ‚ ReAct Executor å®ç°è§„èŒƒ

### 7.2 æŠ€æœ¯å‚è€ƒ
- Pydantic æ–‡æ¡£: https://docs.pydantic.dev/
- Python `pathlib` æ¨¡å—æ–‡æ¡£

---

## 8. è®¾è®¡è¯„å®¡

### 8.1 è‡ªæ£€æ¸…å•

- [x] å·¥å…· Schema è®¾è®¡æ˜¯å¦åˆç†ï¼Ÿ
- [x] ReAct å¾ªç¯æ˜¯å¦èƒ½é˜²æ­¢æ­»å¾ªç¯ï¼Ÿ
- [x] é”™è¯¯å¤„ç†æœºåˆ¶æ˜¯å¦å®Œå–„ï¼Ÿ
- [x] æ˜¯å¦è€ƒè™‘äº†æƒé™å’Œå®‰å…¨é—®é¢˜ï¼Ÿ
- [x] æµ‹è¯•è®¡åˆ’æ˜¯å¦å®Œæ•´ï¼Ÿ

### 8.2 å¾…ç¡®è®¤é—®é¢˜ï¼ˆv1.2 å·²ç­”å¤ï¼‰

1. **å·¥å…·å‚æ•°éªŒè¯**: æ˜¯å¦éœ€è¦æ›´ä¸¥æ ¼çš„å‚æ•°æ ¡éªŒï¼ˆå¦‚è·¯å¾„åˆæ³•æ€§æ£€æŸ¥ï¼‰ï¼Ÿ
   - **ç­”å¤**: âœ… **æ˜¯ï¼Œéœ€è¦**
   - **å®æ–½æ–¹æ¡ˆ**: 
     - ä½¿ç”¨ `Path.exists()` æ£€æŸ¥è·¯å¾„å­˜åœ¨æ€§
     - ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æ£€æŸ¥è·¯å¾„æ ¼å¼ï¼ˆé˜²æ­¢è·¯å¾„éå†æ”»å‡»ï¼‰
     - å¯¹ `write_file` ç­‰å±é™©æ“ä½œï¼Œæ£€æŸ¥æ–‡ä»¶æ‰©å±•åç™½åå•

2. **AI Prompt**: ReAct çš„ prompt æ¨¡æ¿æ˜¯å¦éœ€è¦ç”¨æˆ·å¯é…ç½®ï¼Ÿ
   - **ç­”å¤**: âŒ **å¦ï¼Œå…ˆå†…ç½®**
   - **ç†ç”±**: 
     - MVP é˜¶æ®µä¿æŒç®€å•
     - å†…ç½® prompt ç»è¿‡æµ‹è¯•ï¼Œç¨³å®šæ€§æ›´å¥½
     - åç»­ç‰ˆæœ¬ï¼ˆPhase 2.xï¼‰å†è€ƒè™‘å¼€æ”¾é…ç½®

3. **æ‰§è¡Œè¶…æ—¶**: æ•´ä¸ª ReAct å¾ªç¯æ˜¯å¦éœ€è¦æ€»è¶…æ—¶é™åˆ¶ï¼Ÿ
   - **ç­”å¤**: âœ… **æ˜¯ï¼Œéœ€è¦**
   - **å®æ–½æ–¹æ¡ˆ**: 
     - è®¾ç½® **30 ç§’** æ€»è¶…æ—¶
     - æ¯æ¬¡ AI è°ƒç”¨è®¾ç½® **10 ç§’** è¶…æ—¶
     - è¶…æ—¶æ—¶è¿”å›éƒ¨åˆ†ç»“æœå’Œè¶…æ—¶åŸå› 
     - å‰ç«¯æ˜¾ç¤ºè¿›åº¦å’Œè¶…æ—¶æç¤º

---

## 9. ä¿®è®¢å†å²

| ç‰ˆæœ¬ | æ—¥æœŸ | ä¿®è®¢äºº | ä¿®è®¢å†…å®¹ |
|------|------|--------|---------|
| v1.0 | 2026-02-16 09:17:14 | AIåŠ©æ‰‹å°æ¬§ | åˆå§‹ç‰ˆæœ¬ï¼ŒPhase 1.3 è®¾è®¡æ–‡æ¡£ |
| v1.1 | 2026-02-16 09:17:14 | AIåŠ©æ‰‹å°æ¬§ | æ–°å¢ç¬¬2.5ç«  Windowså‘½ä»¤æ‰§è¡Œè§„åˆ™ï¼Œæ–°å¢ç¬¬2.6ç« æ—¥å¿—ä¸å¯è§‚æµ‹æ€§è®¾è®¡ï¼ŒåŸºäºå®é™…æµ‹è¯•éªŒè¯çš„å‘½ä»¤ä½¿ç”¨æ–¹æ¡ˆ |
| v1.2 | 2026-02-16 09:35:45 | AIåŠ©æ‰‹å°æ¬§ | ä¿®æ­£ç« èŠ‚ç¼–å·ï¼ˆ2.5â†’2.3, 2.6â†’2.4ï¼‰ï¼Œè¡¥å……éªŒæ”¶æ ‡å‡†ï¼ˆæ—¥å¿—ã€Winå…¼å®¹ã€ä¸­æ–‡ï¼‰ï¼Œè¡¥å……é£é™©é¡¹ï¼ˆAIæ ¼å¼ã€æ—¥å¿—æ•…éšœï¼‰ï¼Œç»†åŒ–Day 5-6ä»»åŠ¡ï¼Œæ·»åŠ APIé›†æˆæ–¹æ¡ˆï¼Œç­”å¤å¾…ç¡®è®¤é—®é¢˜ |
| v1.3 | 2026-02-16 09:47:14 | AIåŠ©æ‰‹å°æ¬§ | æ–°å¢ç¬¬3.3ç« ã€Œæ–‡ä»¶æ“ä½œå®‰å…¨è®¾è®¡ã€ï¼šæ“ä½œå†å²è®°å½•ã€åˆ é™¤æ–‡ä»¶å¤‡ä»½ï¼ˆå›æ”¶ç«™ï¼‰ã€ç§»åŠ¨æ–‡ä»¶æ˜ å°„è¡¨ã€æ’¤é”€/å›é€€åŠŸèƒ½ï¼›è¡¥å……æ–‡ä»¶æ“ä½œå®‰å…¨éªŒæ”¶æ ‡å‡†ï¼›æ›´æ–°å®æ–½è®¡åˆ’ï¼ˆDay 3-6ç»†åŒ–ï¼‰ï¼›æ›´æ–°æ–‡ä»¶æ¸…å• |

---

**æ–‡æ¡£ç»“æŸ**

**ç”¨æˆ·ç¡®è®¤**:
- [ ] å·²é˜…è¯»å…¨æ–‡
- [ ] ç†è§£æŠ€æœ¯æ–¹æ¡ˆ
- [ ] è®¤å¯éªŒæ”¶æ ‡å‡†
- [ ] æ‰¹å‡†è¿›å…¥å¼€å‘é˜¶æ®µ

**ç¡®è®¤äºº**: _______________  
**ç¡®è®¤æ—¥æœŸ**: YYYY-MM-DD
