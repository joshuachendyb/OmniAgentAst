# 阶段2.1：Web对话界面+配置+安全 - 设计文档

**文档编号**: OMA-DESIGN-2.1-WEB  
**版本**: v1.4  
**创建时间**: 2026-02-17 15:12:11  
**更新**: 2026-02-17 21:50:00  
**阶段状态**: 🟡进行中  

---

## 1. 设计目标

### 1.1 核心目标
实现基于浏览器的对话界面，支持**对话与任务下达**、执行过程可视化、基础交互功能。

**设计原则**：
- **现代化UI**：界面美观、交互流畅，提供良好的用户体验
- **功能完整**：不仅是对话，更要支持AI任务执行的全流程控制
- **响应式布局**：适配桌面、平板、手机多种设备
- **高可测试性**：组件可单元测试，流程可自动化测试

### 1.2 验收策略
**先Web后桌面**：
1. **Web版先行**：文本功能，便于快速测试、调试和迭代
2. **用户验收Web版**：确认功能符合预期
3. **再开发桌面版**：基于Web版功能，增加系统级特性

---

## 2. 双版本架构说明

### 2.1 Web版 vs 桌面版对比

| 特性 | Web版 | 桌面版 | 说明 |
|------|-------|--------|------|
| **运行环境** | 浏览器 | Tauri桌面应用 | Web版便于测试，桌面版用于生产 |
| **核心功能** | ✅完整 | ✅完整 | 对话、执行展示、历史管理完全一致 |
| **通信方式** | HTTP (Axios) | Tauri IPC | 桌面版使用原生IPC，更快更安全 |
| **系统托盘** | ❌无 | ✅有 | 桌面版后台常驻 |
| **全局快捷键** | ❌无 | ✅有 | 桌面版Ctrl+Shift+O唤醒 |
| **窗口管理** | ❌无 | ✅有 | 桌面版最小化到托盘 |
| **打包部署** | 简单 | 需Tauri打包 | Web版直接访问，桌面版需安装 |

### 2.2 核心功能（双版本一致）

```
┌─────────────────────────────────────────────────────────┐
│                    对话界面核心功能                       │
├─────────────────────────────────────────────────────────┤
│ 1. 对话与任务下达                                        │
│    ├── 消息展示（用户/AI气泡）                           │
│    ├── 消息输入（Enter发送，Shift+Enter换行）            │
│    ├── 历史记录滚动                                      │
│    ├── 消息复制                                         │
│    ├── 任务中断（AI执行过长时可停止）                    │
│    └── 任务暂停/继续（复杂任务可暂停查看中间结果）        │
│                                                         │
│ 2. 执行过程可视化                                        │
│    ├── AI思考过程（可折叠）                              │
│    ├── 工具调用信息（工具名、参数、结果）                 │
│    ├── 执行结果展示（成功/失败状态）                     │
│    └── ReAct循环时间线                                   │
│                                                         │
│ 3. 导航功能（Web版适用）                                │
│    ├── 📁 文件操作入口    ✅ 适用（打开文件操作面板）    │
│    ├── 🖥️ 系统控制入口   ❌ 不适用（需系统级权限）      │
│    ├── 🌐 浏览器入口     ❌ 不适用（已在浏览器中）       │
│    ├── 📚 知识库入口     ✅ 适用（知识库管理界面）       │
│    ├── ⚙️ 设置入口       ✅ 适用（配置页面）             │
│    ├── 💬 历史会话       ✅ 适用（历史会话列表）         │
│    └── 🔧 快捷指令       ✅ 适用（快捷指令面板）         │
└─────────────────────────────────────────────────────────┘
```

### 2.3 差异功能详解

#### Web版特有
- **浏览器访问**：通过URL访问（localhost:5173）
- **响应式布局**：适配不同屏幕尺寸
- **HTTP通信**：基于REST API（Axios/Fetch）
- **开发热更新**：Vite热重载，便于调试

#### UI/UX设计要求

**视觉设计**：
- **现代化风格**：采用Ant Design 5企业级设计体系
- **配色方案**：主色调蓝色（#1890ff），支持亮色/暗色主题切换
- **字体规范**：系统字体栈，中文优先使用系统默认字体
- **间距规范**：遵循8px网格系统，保持一致的节奏感

**交互动效**：
- **消息动画**：新消息渐入（fade-in），时长200ms
- **加载状态**：骨架屏 + 打字机效果（思考中...）
- **过渡动画**：页面切换使用淡入淡出，时长300ms
- **微交互**：按钮hover效果、点击反馈

**响应式断点**：
| 设备类型 | 宽度范围 | 布局调整 |
|---------|---------|---------|
| 桌面大屏 | ≥1440px | 左侧导航展开，聊天区最大宽度1200px |
| 桌面标准 | 1024-1439px | 左侧导航展开，聊天区自适应 |
| 平板 | 768-1023px | 左侧导航可收起，聊天区全宽 |
| 手机 | <768px | 左侧导航隐藏为抽屉，底部固定输入框 |

**可访问性**：
- **键盘导航**：Tab键可遍历所有交互元素
- **焦点管理**：清晰的focus样式
- **屏幕阅读器**：所有图标配合aria-label
- **对比度**：文字与背景对比度≥4.5:1

#### 桌面版特有（阶段3.1）
- **系统托盘**：右键菜单（显示主窗口、退出）
- **全局快捷键**：Ctrl+Shift+O快速唤醒
- **窗口状态**：最小化到托盘而非关闭
- **单实例运行**：防止重复打开
- **IPC通信**：Tauri命令替代HTTP，更低延迟

---

## 3. Web版技术方案

### 3.1 技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| **框架** | React 18 + TypeScript | 组件化开发 |
| **构建工具** | Vite 5 | 快速开发和热更新 |
| **UI库** | Ant Design 5 | 企业级UI组件 |
| **状态管理** | React Context | 轻量级状态管理 |
| **HTTP客户端** | Axios | REST API通信 |
| **样式** | CSS Modules | 组件级样式隔离 |

### 3.2 项目结构

```
frontend/
├── src/
│   ├── components/
│   │   ├── Chat/                 # 聊天组件
│   │   │   ├── ChatWindow.tsx    # 聊天窗口主组件
│   │   │   ├── MessageList.tsx   # 消息列表
│   │   │   ├── MessageItem.tsx   # 单条消息
│   │   │   ├── MessageInput.tsx  # 消息输入框
│   │   │   └── ExecutionPanel.tsx # 执行过程展示
│   │   ├── Sidebar/              # 左侧导航
│   │   │   ├── Sidebar.tsx       # 导航栏主组件
│   │   │   └── NavItem.tsx       # 导航项
│   │   └── common/               # 通用组件
│   │       ├── Loading.tsx       # 加载状态
│   │       └── ErrorDisplay.tsx  # 错误展示
│   ├── hooks/
│   │   ├── useChat.ts            # 聊天逻辑Hook
│   │   ├── useExecution.ts       # 执行过程Hook
│   │   └── useWebSocket.ts       # WebSocket连接（预留）
│   ├── services/
│   │   ├── api.ts                # API服务
│   │   └── chatService.ts        # 聊天相关API
│   ├── types/
│   │   └── chat.ts               # 类型定义
│   ├── utils/
│   │   └── format.ts             # 格式化工具
│   ├── App.tsx                   # 应用入口
│   └── main.tsx                  # 渲染入口
├── index.html
└── package.json
```

### 3.3 界面布局

```
┌────────────────────────────────────────────────────────────┐
│  OmniAgentAst. Web版                            [_] [□] [X] │
├────────────┬───────────────────────────────────────────────┤
│            │                                               │
│  📁 文件    │    🤖 今天有什么可以帮你的？                   │
│  🖥️ 系统    │                                               │
│  🌐 浏览器  │    ┌─────────────────────────────────────┐   │
│  📚 知识库  │    │ 用户: 帮我整理下载文件夹               │   │
│  ⚙️ 设置    │    │                                       │   │
│            │    │ Agent: 好的，我发现下载文件夹有:        │   │
│ ───────────│    │ - 15个压缩包 (.zip/.rar)               │   │
│  💬 历史    │    │ - 23个文档 (.pdf/.doc)                 │   │
│  🔧 快捷    │    │ - 8个安装包 (.exe/.msi)                │   │
│            │    │                                       │   │
│            │    │ 建议按类型分3个文件夹存放，执行吗？      │   │
│            │    │ [执行] [查看详情] [取消]                │   │
│            │    └─────────────────────────────────────┘   │
│            │                                               │
│            │    ┌─────────────────────────────────────┐   │
│            │    │ > 帮我截图当前窗口并保存到桌面         │   │
│            │    └─────────────────────────────────────┘   │
│            │                    [发送]                     │
└────────────┴───────────────────────────────────────────────┘
```

### 3.4 关键组件设计

#### ChatWindow（聊天窗口）
```typescript
interface ChatWindowProps {
  sessionId?: string;      // 会话ID
  onSendMessage: (msg: string) => void;
  onClearChat: () => void;
}

// 功能：
// - 消息列表展示
// - 消息输入和发送
// - 清空对话
// - 加载状态管理
```

#### ExecutionPanel（执行过程展示）
```typescript
interface ExecutionPanelProps {
  steps: ExecutionStep[];  // ReAct执行步骤
  isExpanded: boolean;     // 是否展开
}

interface ExecutionStep {
  stepNumber: number;
  thought: string;         // AI思考
  action: Action;          // 执行的行动
  observation: Observation; // 观察结果
  status: 'pending' | 'success' | 'failed';
  timestamp: string;
}

// 功能：
// - 折叠/展开思考过程
// - 展示工具调用详情
// - 显示执行结果
// - 时间线可视化
```

#### Sidebar（左侧导航）
```typescript
interface NavItem {
  key: string;
  icon: React.ReactNode;
  label: string;
  path: string;
}

// 导航项：
// - 文件操作（📁）
// - 系统控制（🖥️）
// - 浏览器（🌐）
// - 知识库（📚）
// - 设置（⚙️）
// - 对话历史（💬）
// - 快捷指令（🔧）
```

---

## 4. API接口

### 4.1 聊天接口

```typescript
// 发送消息
POST /api/v1/chat
Request: {
  message: string;         // 用户消息
  history?: Message[];     // 历史消息
  session_id?: string;     // 会话ID
}

Response: {
  response: string;        // AI回复
  session_id: string;      // 会话ID
  steps: ExecutionStep[];  // 执行步骤
  timestamp: string;
}

// 获取执行过程
GET /api/v1/chat/execution/:session_id
Response: {
  session_id: string;
  steps: ExecutionStep[];
  status: 'running' | 'completed' | 'failed';
}
```

### 4.2 会话管理

```typescript
// 创建会话
POST /api/v1/sessions
Response: { session_id: string }

// 获取会话列表
GET /api/v1/sessions
Response: { sessions: Session[] }

// 清空会话
DELETE /api/v1/sessions/:session_id
```

### 4.3 配置接口

```typescript
// 获取配置
GET /api/v1/config
Response: {
  ai_model: string;        // 当前模型
  api_key_configured: boolean;  // API Key是否已配置
  theme: 'light' | 'dark';
}

// 更新配置
PUT /api/v1/config
Request: {
  ai_model?: string;
  zhipu_api_key?: string;
  opencode_api_key?: string;
}
Response: { success: boolean }
```

### 4.4 安全接口

```typescript
// 获取安全策略
GET /api/v1/security/policy
Response: {
  shell_blacklist: string[];  // Shell黑名单命令
  dangerous_operations: string[];  // 危险操作列表
}

// 危险操作确认
POST /api/v1/security/confirm
Request: {
  operation_id: string;    // 操作ID
  confirmed: boolean;      // 是否确认
}
```

---

## 5. 配置管理

### 5.1 后端配置
已完成：
- [x] config.yaml结构
- [x] AI模型配置（智谱GLM + OpenCode）
- [x] 安全配置

### 5.2 前端配置界面

**设置页面组件**：
```typescript
// Settings.tsx
interface SettingsProps {
  onConfigChange: (config: Config) => void;
}

// 功能：
// - AI模型选择下拉框
// - API Key输入框（密码隐藏）
// - 主题切换
```

**配置项**：
| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| ai_model | string | 'zhipu' | 模型选择：zhipu/opencode |
| zhipu_api_key | string | '' | 智谱API Key |
| opencode_api_key | string | '' | OpenCode API Key |
| theme | string | 'light' | 主题：light/dark |

---

## 6. 安全增强

### 6.1 后端安全
已完成：
- [x] 全局错误捕获
- [x] 友好的错误提示
- [x] 日志记录机制

待完成：
- [ ] Shell命令黑名单机制
- [ ] 危险操作识别

### 6.2 前端安全交互

**危险操作弹窗确认**：
```typescript
// DangerConfirmModal.tsx
interface DangerConfirmModalProps {
  operation: string;       // 操作描述
  command: string;         // 具体命令
  onConfirm: () => void;
  onCancel: () => void;
}

// 触发条件：
// - 包含rm -rf、mkfs等高危命令
// - 系统级路径操作
// - 网络请求到外部地址
```

**黑名单展示**：
- 在设置页面显示当前黑名单规则
- 可扩展的白名单机制（预留）

---

## 7. 开发计划

### 5.1 Week 1: 基础架构与组件开发

| 天数 | 任务 | 产出 | 测试要求 |
|------|------|------|----------|
| Day 1 | 项目结构整理，组件目录创建 | 目录结构完成 | 项目能正常启动 |
| Day 2 | ChatWindow、MessageList组件 | 聊天窗口基础 | 单元测试：3个 |
| Day 3 | MessageItem、MessageInput组件 | 消息展示和输入 | 单元测试：4个 |
| Day 4 | ExecutionPanel组件（执行过程） | 执行可视化 | 单元测试：3个 |
| Day 5 | Sidebar组件、路由配置 | 导航功能完成 | 单元测试：4个，Week1累计>14个 |

**Week 1里程碑**：所有UI组件完成，可独立运行，单元测试覆盖率>30%

### 5.2 Week 2: 业务逻辑与API集成

| 天数 | 任务 | 产出 | 测试要求 |
|------|------|------|----------|
| Day 1 | useChat Hook实现 | 聊天逻辑完成 | 单元测试：5个 |
| Day 2 | useExecution Hook实现 | 执行过程逻辑 | 单元测试：4个 |
| Day 3 | API服务层封装 | 与后端API对接 | 集成测试：3个 |
| Day 4 | 任务中断/暂停功能 | 流程控制完成 | 单元测试：3个 |
| Day 5 | 单元测试编写 | 测试覆盖率>80% | 单元测试累计>45个 |

**Week 2里程碑**：业务逻辑完成，可与后端联调，单元测试覆盖率>80%

### 5.3 Week 3: UI优化、集成测试与验收准备

| 天数 | 任务 | 产出 | 测试要求 |
|------|------|------|----------|
| Day 1 | UI美化（主题、动画、响应式） | 视觉效果完成 | 视觉回归测试 |
| Day 2 | 响应式布局完善 | 多设备适配完成 | 4个断点测试 |
| Day 3 | Playwright E2E测试 | 集成测试完成 | E2E测试>15个通过 |
| Day 4 | Bug修复、性能优化 | 性能达标 | Lighthouse>90 |
| Day 5 | 验收测试、文档完善 | 阶段文档完成 | AC001-AC007全部通过 |

**Week 3里程碑**：测试通过，准备验收，AC全部达标

---

## 8. 测试计划

### 8.1 测试目标与策略

**目标分解**：
| 测试类型 | 目标数量 | 覆盖率目标 | 验证方式 |
|----------|----------|-----------|----------|
| **单元测试** | 45-50个 | 组件100%覆盖，Hooks 80%覆盖 | Jest + React Testing Library |
| **集成测试** | 15-20个 | 核心流程100%覆盖 | Playwright E2E |
| **验收测试** | 7个AC | 全部自动化 | Playwright |
| **总计** | 70个左右 | 整体>80% | - |

**策略**：先单元测试（保证组件可独立运行），后集成测试（验证端到端），最后验收测试（验证AC）

### 8.2 单元测试详细设计

**组件测试**（目标：25个测试）：
| 组件 | 测试数量 | 测试内容 | 优先级 | 风险 |
|------|---------|---------|--------|------|
| ChatWindow | 6个 | 渲染、消息列表、输入发送、加载状态、清空对话、快捷键 | P0 | 低 |
| MessageItem | 4个 | 用户消息渲染、AI消息渲染、复制功能、长内容截断 | P0 | 低 |
| MessageInput | 5个 | 输入框、发送按钮、Enter发送、Shift+Enter换行、禁用状态 | P0 | 低 |
| ExecutionPanel | 6个 | 折叠/展开、步骤渲染、工具调用展示、成功/失败状态、时间线、空状态 | P1 | 中（复杂渲染） |
| Sidebar | 4个 | 导航项渲染、点击切换、当前项高亮、折叠展开 | P1 | 低 |

**Hooks测试**（目标：18个测试）：
| Hook | 测试数量 | 测试内容 | 依赖Mock | 难度 |
|------|---------|---------|----------|------|
| useChat | 8个 | 发送消息、接收回复、错误处理、重试、加载状态、历史加载、会话切换、清空对话 | API服务 | 高（异步多） |
| useExecution | 6个 | 执行状态管理、步骤更新、展开/折叠、实时推送、错误处理、取消任务 | WebSocket | 高（实时性） |
| useMessages | 4个 | 消息列表管理、滚动加载、复制消息、本地缓存 | LocalStorage | 中 |

**工具函数测试**（目标：6个测试）：
| 函数 | 测试数量 | 测试内容 |
|------|---------|---------|
| format.ts | 3个 | 时间格式化、内容截断、字节格式化 |
| validation.ts | 2个 | 输入验证、路径验证 |
| storage.ts | 1个 | LocalStorage封装 |

**单元测试风险**：
| 风险项 | 影响 | 应对措施 |
|--------|------|----------|
| useChat异步测试复杂 | 测试编写难度大，容易不稳定 | 使用msw(Mock Service Worker)统一Mock API |
| useExecution WebSocket | 实时数据推送难以测试 | 创建Mock WebSocket Server |
| ExecutionPanel复杂渲染 | 步骤数据嵌套深，断言复杂 | 拆分小组件，分别测试 |

### 8.3 集成测试详细设计

**场景测试**（目标：15个测试）：
| 场景 | 测试数量 | 测试步骤 | 通过标准 | 难度 |
|------|---------|---------|----------|------|
| 完整对话流程 | 3个 | 1.输入消息 2.发送 3.等待回复 4.验证显示 | 消息正确显示，AI有回复，执行步骤展示 | 中 |
| 文件操作任务 | 2个 | 1.输入"读取文件" 2.发送 3.查看执行过程 | 显示ReAct步骤，有工具调用，结果正确 | 高（依赖后端） |
| 任务中断 | 2个 | 1.发送长任务 2.点击停止 3.验证中断 | 任务停止，显示中断提示，状态正确 | 高（时序控制） |
| 响应式布局 | 3个 | 1.调整窗口大小 2.验证布局变化 | 各断点布局正确（1440px/1024px/768px/375px） | 中 |
| 导航切换 | 2个 | 1.点击不同导航项 2.验证内容切换 | 内容正确切换，URL正确更新 | 低 |
| 历史会话 | 2个 | 1.创建多个会话 2.切换会话 3.验证历史加载 | 历史记录正确显示，切换后内容正确 | 中 |
| 错误处理 | 1个 | 1.模拟网络错误 2.验证错误提示 | 显示友好错误信息，有重试按钮 | 中 |

**集成测试依赖**：后端API服务（必须启动）、AI服务（可用Mock）、数据库（可用内存数据库）

### 8.4 测试覆盖率保障

**Week 2 Day 5检查点**：
| 指标 | 目标 | 检查方式 |
|------|------|----------|
| 组件测试 | 25个完成 | jest --coverage查看组件覆盖率>90% |
| Hooks测试 | 18个完成 | useChat、useExecution核心流程测试通过 |
| 工具函数 | 6个完成 | 纯函数覆盖率100% |
| 总覆盖率 | >80% | jest --coverage查看Overall Coverage |

**Week 3 Day 3检查点**：
| 指标 | 目标 | 检查方式 |
|------|------|----------|
| E2E测试 | 15个通过 | playwright test全部通过 |
| AC自动化 | 7个通过 | 验收标准脚本全部通过 |
| 性能 | 达标 | Lighthouse评分>90 |

**风险预案**：如果Week 2覆盖率<80%，Week 3前两天继续补充单元测试；如果E2E不稳定，增加等待时间、重试机制，或改用Mock后端

---

## 9. 验收标准

### 9.1 功能验收（AC001-AC007）

| 编号 | 验收项 | 验收标准 | 测试方式 | 优先级 |
|------|--------|----------|----------|--------|
| AC001 | 消息发送 | 输入消息后按Enter发送，消息显示在列表中，有发送时间戳 | Playwright自动化 | P0 |
| AC002 | AI回复 | AI回复显示在消息列表，包含文本内容，有AI标识 | Playwright自动化 | P0 |
| AC003 | 执行展示 | ReAct执行步骤可视化展示（思考→行动→观察），可折叠展开 | Playwright自动化 | P0 |
| AC004 | 导航栏 | 左侧导航栏可切换不同功能模块，当前项高亮 | Playwright自动化 | P1 |
| AC005 | 历史记录 | 可查看历史对话，支持滚动加载，有会话列表 | Playwright自动化 | P1 |
| AC006 | 清空对话 | 一键清空当前对话内容，有确认提示 | Playwright自动化 | P1 |
| AC007 | 复制消息 | 可复制单条消息内容，有复制成功提示 | Playwright自动化 | P2 |
| AC008 | 配置管理 | 可修改API Key、切换AI模型，配置保存生效 | Playwright自动化 | P1 |
| AC009 | 安全黑名单 | Shell危险命令被拦截，提示用户风险 | Playwright自动化 | P1 |
| AC010 | 危险操作确认 | 高危操作弹出确认框，用户确认后才执行 | Playwright自动化 | P0 |

### 9.2 性能验收

| 指标 | 验收标准 | 测试工具 | 达标线 |
|------|----------|----------|--------|
| 首屏加载时间 | 从输入URL到首屏渲染完成 | Lighthouse | <3秒 |
| 消息响应时间 | 从点击发送到收到AI回复 | Playwright计时 | <3秒 |
| 界面性能评分 | 综合性能评分 | Lighthouse | >90分 |
| 可访问性评分 | 无障碍支持程度 | Axe-core | >95分 |
| 响应式适配 | 4个断点布局正确 | Playwright | 全部通过 |

### 9.3 质量验收

| 指标 | 验收标准 | 检查方式 |
|------|----------|----------|
| 单元测试覆盖率 | 整体代码覆盖率 | jest --coverage | ≥80% |
| 集成测试通过率 | E2E测试通过比例 | playwright test | 100%（15/15） |
| 类型检查 | TypeScript类型错误 | tsc --noEmit | 0错误 |
| 代码规范 | ESLint警告和错误 | npm run lint | 0错误，0警告 |

---

## 10. 与桌面版的关系

### 8.1 功能复用

Web版开发的所有组件和逻辑，桌面版**完全复用**：
- UI组件（ChatWindow, MessageList等）
- 业务逻辑（useChat, useExecution hooks）
- 类型定义（TypeScript interfaces）
- 样式文件（CSS Modules）

### 8.2 差异替换

| Web版 | 桌面版 | 替换方式 |
|-------|--------|----------|
| Axios HTTP | Tauri IPC | 替换API调用层 |
| Browser路由 | Tauri窗口 | 使用Tauri的window API |
| LocalStorage | 本地文件 | 使用Tauri的fs API |

### 8.3 开发顺序

```
阶段2.1 (Web版)
├── 开发React组件
├── 实现HTTP API通信
├── 完成基础功能
└── 用户验收 ✅
    ↓
阶段3.1 (桌面版)
├── 复用所有React组件
├── 替换为Tauri IPC
├── 添加系统托盘/快捷键
└── 用户验收 ✅
```
---

## 11. 风险提示

| 风险 | 影响 | 应对 |
|------|------|------|
| Web版功能不完整 | 高 | 按验收标准逐项检查 |
| 桌面版复用困难 | 中 | 组件设计时考虑Tauri兼容性 |
| API性能问题 | 中 | 添加loading状态，优化后端 |
| 测试覆盖不足 | 中 | 严格按测试计划执行，覆盖率>80% |

---

**下一步**：完成Web版开发后，用户验收通过，进入阶段3.1桌面版开发。

**参考文档**:
- [阶段1.3-设计文档](阶段1.3-设计文档-2026-02-16.md) - ReAct执行器设计
