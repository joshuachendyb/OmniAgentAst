# 封面图生成经验总结

**创建时间**: 2026-02-10 16:30:00
**文档类型**: 经验总结
**适用场景**: AI助手图像生成任务

---

## 一、需求确认阶段的问题与教训

### 1.1 首次需求不明确

**问题现象**:
- 用户要求"来作图。看doc下面的生成图片说明"
- 没有明确询问图片的**基本规格**：尺寸、格式、风格、用途
- 没有确认图片的具体用途（文档封面、PPT配图、宣传图等）

**导致的后果**:
- 第一次生成的图片是800x600 PNG格式，但未确认是否满足需求
- 后续发现需要重新生成不同风格和尺寸的图片
- 返工浪费时间

### 1.2 应该做的改进

**需求确认清单**（以后必须执行）:

| 确认项 | 问题 | 示例 |
|--------|------|------|
| **尺寸** | 图片需要多大？ | 800x600, 1920x1080, A4等 |
| **格式** | 什么格式？ | PNG, JPG, SVG, PDF等 |
| **风格** | 什么视觉风格？ | 扁平化、科技感、商务风、卡通风等 |
| **内容** | 包含哪些元素？ | 标题、Logo、图表、数据等 |
| **用途** | 用于什么场景？ | 文档封面、PPT、网站、印刷等 |
| **数量** | 需要几张？ | 单张、多张、系列图等 |

**经验**: 在动手前花2分钟确认需求，可以节省30分钟的返工时间。

---

## 二、生成工具的选择与下载

### 2.1 工具下载记录

**第一次下载 (13:00左右)**:
```bash
pip install matplotlib numpy
```
- **matplotlib**: 绘图库
- **numpy**: 数值计算库

**第二次下载 (16:00左右)**:
```bash
pip install matplotlib numpy
```
- 实际上与第一次相同的工具
- 因为中间重新安装了Python环境，需要重新安装

### 2.2 为什么两次工具"看起来差不多"但实际不同？

**关键区别**: 不是工具不同，而是**使用方式**不同！

| 时间 | 脚本特点 | 结果 |
|------|----------|------|
| **13:00版本** | 缺少警告抑制 | 产生大量字体警告，触发prune，图片数据被清理 |
| **16:00版本** | 添加`warnings.filterwarnings('ignore')`和`matplotlib.use('Agg')` | 成功生成，无prune干扰 |

### 2.3 工具使用要点

**matplotlib使用规范**:
```python
# 必须在import matplotlib之前
import warnings
warnings.filterwarnings('ignore')

# 使用非交互式后端
import matplotlib
matplotlib.use('Agg')

# 然后才import pyplot
import matplotlib.pyplot as plt
```

**原因**: 
- `warnings.filterwarnings('ignore')`: 阻止matplotlib的字体警告
- `matplotlib.use('Agg')`: 使用非交互式后端，不产生GUI输出

---

## 三、脚本质量对生成结果的影响

### 3.1 脚本演进历程

| 版本 | 文件名 | 主要问题 | 结果 |
|------|--------|----------|------|
| **v1.0** | `generate_dcp_cover.py` | 缺少警告抑制，尺寸设置错误 | 单色底，93-113字节，失败 |
| **v2.0** | `generate_dcp_covers.py` | 部分修复，但仍有优化空间 | 彩色图，40-64KB，成功 |
| **v3.0** | `generate_high_res_covers.py` | 完善警告抑制，优化绘图 | 高清图，95-130KB，成功 |
| **v4.0** | `generate_new_style_covers.py` | 全新设计，最佳实践 | 全新风格，120-200KB，成功 |

### 3.2 v1.0脚本失败原因分析

**问题1: 单色底图片**
```python
# 错误代码
plt.savefig(path, bbox_inches='tight')  # 这行导致尺寸失控！
```
- `bbox_inches='tight'`会自动裁剪图片到内容边界
- 导致800x600的设置失效
- 最终生成的图片只有50x50像素的纯色块

**问题2: 触发prune**
```python
# 缺少
import warnings
warnings.filterwarnings('ignore')
import matplotlib
matplotlib.use('Agg')
```
- matplotlib在Windows上搜索中文字体时产生大量警告
- 警告信息快速累积，触发DCP的prune策略
- 图片数据被清理，只保留警告信息

### 3.3 脚本最佳实践

**标准模板**:
```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# 第1步：抑制警告（必须在matplotlib之前）
import warnings
warnings.filterwarnings('ignore')

# 第2步：设置后端（必须在pyplot之前）
import matplotlib
matplotlib.use('Agg')

# 第3步：导入绘图库
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
import numpy as np

# 第4步：设置字体
plt.rcParams['font.sans-serif'] = ['DejaVu Sans', 'SimHei', 'Arial Unicode MS']
plt.rcParams['axes.unicode_minus'] = False

# 第5步：创建图形
def create_cover():
    fig, ax = plt.subplots(1, 1, figsize=(8, 6), dpi=150)  # 800x600 @ 150dpi
    ax.set_xlim(0, 800)
    ax.set_ylim(0, 600)
    ax.axis('off')
    
    # 绘制代码...
    
    # 第6步：保存（关键：不使用bbox_inches='tight'）
    plt.savefig('output.png', dpi=150, facecolor='white', 
                edgecolor='none', bbox_inches=None, pad_inches=0)
    plt.close()

if __name__ == '__main__':
    create_cover()
```

---

## 四、最后一次生成的情况分析

### 4.1 现象描述

在生成最后3张新风格封面图时：
- **触发了一次prune操作**（从工具列表中看到了prune工具的输出）
- **但是图片仍然完全生成了**（三张图片都正常保存）

### 4.2 为什么这次prune没有破坏图片？

**原因分析**:

1. **脚本已完善警告抑制**
   ```python
   import warnings
   warnings.filterwarnings('ignore')
   matplotlib.use('Agg')
   ```
   这些代码阻止了大部分触发prune的输出。

2. **prune时机问题**
   - 可能prune发生在图片保存**之前**
   - 清理的是之前的工具输出（如bash命令的输出）
   - 图片数据是在prune之后才生成的

3. **DCP策略配置**
   ```json
   "purgeErrors": {
       "enabled": true,
       "turns": 10
   }
   ```
   - 配置为每10轮才清理一次错误输出
   - 图片生成在清理周期之间完成

4. **输出量减少**
   - 新脚本优化了绘图代码，减少了中间输出
   - 没有达到prune的触发阈值

### 4.3 关键教训

**即使看到prune操作，也不一定意味着失败**！

需要检查：
1. 生成的文件是否存在
2. 文件大小是否正常（>1KB的才是真实图片）
3. 图片内容是否完整

---

## 五、经验总结与建议

### 5.1 需求阶段

**必须执行**:
- [ ] 确认图片尺寸（像素）
- [ ] 确认图片格式（PNG/JPG/SVG）
- [ ] 确认视觉风格（科技/商务/极简等）
- [ ] 确认内容元素（标题/图表/Logo）
- [ ] 确认数量（单张/多张）

### 5.2 工具准备

**标准安装**:
```bash
pip install matplotlib numpy pillow
```

**必须使用**:
```python
import warnings
warnings.filterwarnings('ignore')
import matplotlib
matplotlib.use('Agg')
```

### 5.3 脚本编写

**关键要点**:
1. 警告抑制必须在matplotlib之前
2. 尺寸设置：`figsize=(8, 6), dpi=150` = 1200x900像素
3. 保存时：**不要使用** `bbox_inches='tight'`
4. 使用`plt.close()`及时释放内存

### 5.4 验证步骤

**生成后检查**:
1. `ls -lh *.png` - 文件大小应>50KB
2. `file *.png` - 确认是PNG格式
3. 用图片查看器打开确认内容完整

### 5.5 DCP配置建议

**图片生成期间**:
```json
{
  "tools": {
    "prune": { "permission": "deny" },  // 临时禁用
    "distill": { "permission": "allow" },
    "compress": { "permission": "deny" }
  }
}
```

**完成后可恢复**:
```json
{
  "tools": {
    "prune": { "permission": "ask" }  // 恢复询问
  }
}
```

---

## 六、附录：相关文件清单

**工具脚本** (位于 `doc/` 目录):
- `generate_dcp_cover.py` - v1.0 初始版本（问题版本）
- `generate_dcp_covers.py` - v2.0 修复版本
- `generate_high_res_covers.py` - v3.0 高清版本
- `generate_new_style_covers.py` - v4.0 全新风格版本

**生成的图片** (位于 `doc/` 目录):
- `DCP_Cover_01_TechGradient_800x600.png` - 渐变科技风
- `DCP_Cover_02_Professional_800x600.png` - 专业商务风  
- `DCP_Cover_03_DataViz_800x600.png` - 数据可视化风
- `DCP_NewStyle_01_FlatDesign_800x600.png` - 扁平化极简风
- `DCP_NewStyle_02_DataFlow_800x600.png` - 数据流网络风
- `DCP_NewStyle_03_LayeredCards_800x600.png` - 分层卡片风

---

**更新时间**: 2026-02-10 16:30:00
**总结人**: OpenCode AI助手
**文档状态**: 完成
